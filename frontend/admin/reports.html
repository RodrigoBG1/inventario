<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Ventas y Cobranzas - Sistema de Aceites</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <style>
        /* Estilos espec√≠ficos para reporte de ventas y cobranzas */
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .report-header {
            background: linear-gradient(135deg, #052e5b, #052e5b);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .report-header h1 {
            margin: 0 0 1rem 0;
            font-size: 2rem;
            font-weight: 700;
        }

        .report-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .report-controls {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input,
        .control-group select {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #052e5b;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #052e5b, #3b82f6);
            color: white;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #052e5b, #052e5b);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            box-shadow: 0 4px 6px rgba(5, 150, 105, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(5, 150, 105, 0.4);
        }

        /* Modal del reporte */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .report-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 1400px;
            max-height: 95vh;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, #052e5b, #052e5b);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .report-section {
            margin-bottom: 3rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #052e5b;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon {
            background: #052e5b;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .report-table th {
            background: #f8fafc;
            color: #374151;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }

        .report-table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        .report-table tr:last-child td {
            border-bottom: none;
        }

        .report-table tr:hover {
            background: #f8fafc;
        }

        .amount-cell {
            font-weight: 600;
            color: #052e5b;
            text-align: right;
        }

        .date-cell {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .payment-method {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .method-efectivo {
            background: #dcfce7;
            color: #166534;
        }

        .method-cheque {
            background: #fef3c7;
            color: #92400e;
        }

        .method-transferencia {
            background: #dbeafe;
            color: #1e40af;
        }

        .method-tarjeta {
            background: #fce7f3;
            color: #be185d;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .summary-card h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-amount {
            font-size: 2rem;
            font-weight: 700;
            color: #052e5b;
            margin: 0;
        }

        .total-card {
            background: linear-gradient(135deg, #052e5b, #052e5b);
            color: white;
        }

        .total-card h4 {
            color: rgba(255, 255, 255, 0.9);
        }

        .total-card .summary-amount {
            color: white;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .print-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e5e7eb;
            text-align: center;
        }

        @media print {
            .modal-header,
            .modal-close,
            .print-section {
                display: none !important;
            }

            .modal-content {
                max-width: none;
                max-height: none;
                box-shadow: none;
                border-radius: 0;
            }

            .modal-body {
                padding: 1rem;
            }

            .report-table {
                font-size: 0.875rem;
            }

            .summary-grid {
                break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .modal-content {
                margin: 0.5rem;
                max-height: calc(100vh - 1rem);
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .report-table {
                font-size: 0.875rem;
            }

            .report-table th,
            .report-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <span id="user-name"></span>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="products.html">Productos</a></li>
                <li><a href="employees.html">Vendedores</a></li>
                <li><a href="orders.html">Pedidos</a></li>
                <li><a href="subalmacenes.html">Subalmacenes</a></li>
                <li><a href="reports.html" class="active">Reportes</a></li>
                <li><a href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="report-container">
                <div class="report-header">
                    <h1> Reporte de Ventas y Cobranzas</h1>
                    <p>Genera reportes detallados de ventas diarias por empleado</p>
                </div>

                <div class="report-controls">
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="report-date"> Fecha del Reporte</label>
                            <input type="date" id="report-date" required>
                        </div>

                        <div class="control-group">
                            <label for="employee-select"> Empleado</label>
                            <select id="employee-select" required>
                                <option value="">Seleccionar empleado...</option>
                            </select>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateReport()">
                            Ver Reporte
                        </button>
                        <button class="btn btn-secondary" onclick="printReport()">
                            Imprimir Reporte
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal del Reporte -->
    <div id="reportModal" class="report-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Reporte Diario de Ventas y Cobranzas</h2>
                <button class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="reportContent">
                    <!-- El contenido del reporte se generar√° aqu√≠ -->
                </div>

                <div class="print-section">
                    <button class="btn btn-secondary" onclick="printReport()">
                         Imprimir Reporte
                    </button>
                    <button class="btn btn-primary" onclick="closeReportModal()">
                         Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        // Variables globales
        let currentEmployees = [];
        let currentReportData = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Iniciando p√°gina de reporte de ventas y cobranzas...');
            
            // Verificar autenticaci√≥n de admin
            if (!requireAdmin()) return;
            
            // Configurar fecha por defecto (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            
            // Cargar empleados
            loadEmployees();
            
            console.log('‚úÖ P√°gina de reportes inicializada');
        });

        // Cargar lista de empleados
        async function loadEmployees() {
            try {
                console.log('üë• Cargando empleados...');
                
                currentEmployees = await window.getEmployees();
                
                const employeeSelect = document.getElementById('employee-select');
                employeeSelect.innerHTML = '<option value="">Seleccionar empleado...</option>';
                
                // Filtrar solo empleados (no admins)
                const employees = currentEmployees.filter(emp => emp.role === 'employee');
                
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.employee_code} - ${employee.name}`;
                    employeeSelect.appendChild(option);
                });
                
                console.log('‚úÖ Empleados cargados:', employees.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando empleados:', error);
                showNotification('Error al cargar empleados: ' + error.message, 'error');
            }
        }

        // Generar reporte
        async function generateReport() {
            const date = document.getElementById('report-date').value;
            const employeeId = document.getElementById('employee-select').value;
            
            if (!date || !employeeId) {
                showNotification('Por favor selecciona fecha y empleado', 'warning');
                return;
            }
            
            try {
                console.log('üìä Generando reporte:', { date, employeeId });
                
                // Mostrar indicador de carga
                const reportContent = document.getElementById('reportContent');
                reportContent.innerHTML = `
                    <div class="no-data">
                        <h3>üîÑ Generando reporte...</h3>
                        <p>Por favor espera mientras procesamos los datos</p>
                    </div>
                `;
                
                // Obtener datos del reporte
                const reportData = await fetchReportData(employeeId, date);
                currentReportData = reportData;
                
                // Renderizar reporte
                renderReport(reportData);
                
                // Mostrar modal
                document.getElementById('reportModal').classList.add('show');
                document.body.style.overflow = 'hidden';
                
                console.log('‚úÖ Reporte generado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte:', error);
                showNotification('Error al generar reporte: ' + error.message, 'error');
            }
        }

        // Obtener datos del reporte
        async function fetchReportData(employeeId, date) {
            try {
                // Hacer petici√≥n al endpoint de reporte
                const response = await fetch(`${window.API_BASE_URL}/api/reports/sales-collection?employee_id=${employeeId}&date=${date}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos del reporte obtenidos:', data);
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Error obteniendo datos del reporte:', error);
                throw error;
            }
        }

        // Renderizar reporte
        function renderReport(data) {
            const employee = currentEmployees.find(emp => emp.id === parseInt(data.employee_id));
            const reportDate = new Date(data.date).toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Actualizar t√≠tulo del modal
            document.getElementById('modalTitle').textContent = 
                `Reporte de ${employee?.name || 'Empleado'} - ${reportDate}`;
            
            const reportContent = document.getElementById('reportContent');
            
            reportContent.innerHTML = `
                <!-- Informaci√≥n del empleado -->
                <div class="report-section">
                    <div class="section-title">
                        <span class="section-icon"></span>
                        Informaci√≥n del Empleado
                    </div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h4>Empleado</h4>
                            <p class="summary-amount" style="font-size: 1.2rem;">${employee?.name || 'N/A'}</p>
                        </div>
                        <div class="summary-card">
                            <h4>C√≥digo</h4>
                            <p class="summary-amount" style="font-size: 1.2rem;">${employee?.employee_code || 'N/A'}</p>
                        </div>
                        <div class="summary-card">
                            <h4>Fecha</h4>
                            <p class="summary-amount" style="font-size: 1.2rem;">${reportDate}</p>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Ventas -->
                <div class="report-section">
                    <div class="section-title">
                        <span class="section-icon">üí∞</span>
                        Ventas del D√≠a
                    </div>
                    ${renderSalesTable(data.sales)}
                </div>

                <!-- Tabla de Cobranzas -->
                <div class="report-section">
                    <div class="section-title">
                        <span class="section-icon">üí≥</span>
                        Cobranzas del D√≠a
                    </div>
                    ${renderPaymentsTable(data.payments)}
                </div>

                <!-- Resumen por M√©todo de Pago -->
                <div class="report-section">
                    <div class="section-title">
                        <span class="section-icon"></span>
                        Resumen por M√©todo de Pago
                    </div>
                    ${renderPaymentSummary(data.payment_summary)}
                </div>
            `;
        }

        // Renderizar tabla de ventas
        function renderSalesTable(sales) {
            if (!sales || sales.length === 0) {
                return `
                    <div class="no-data">
                        <h3>üìù No hay ventas registradas</h3>
                        <p>No se encontraron ventas para este empleado en la fecha seleccionada</p>
                    </div>
                `;
            }
            
            let totalVentas = 0;
            let totalAbonos = 0;
            
            const salesRows = sales.map(sale => {
                const total = parseFloat(sale.total) || 0;
                const abono = parseFloat(sale.paid_amount) || 0;
                
                totalVentas += total;
                totalAbonos += abono;
                
                return `
                    <tr>
                        <td>${sale.sale_number || sale.order_number || 'N/A'}</td>
                        <td class="date-cell">${formatDate(sale.created_at)}</td>
                        <td>${sale.client_info?.name || 'Cliente directo'}</td>
                        <td class="amount-cell">$${total.toFixed(2)}</td>
                        <td class="amount-cell">$${abono.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            return `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>No. Nota</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Total Venta</th>
                            <th>Abono</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${salesRows}
                        <tr style="background: #f8fafc; font-weight: 600;">
                            <td colspan="3">TOTALES</td>
                            <td class="amount-cell">$${totalVentas.toFixed(2)}</td>
                            <td class="amount-cell">$${totalAbonos.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // Renderizar tabla de cobranzas
        function renderPaymentsTable(payments) {
            if (!payments || payments.length === 0) {
                return `
                    <div class="no-data">
                        <h3>üí≥ No hay cobranzas registradas</h3>
                        <p>No se encontraron pagos registrados por este empleado en la fecha seleccionada</p>
                    </div>
                `;
            }
            
            let totalCobranzas = 0;
            
            const paymentsRows = payments.map(payment => {
                const amount = parseFloat(payment.amount) || 0;
                totalCobranzas += amount;
                
                return `
                    <tr>
                        <td>${payment.order_number || 'N/A'}</td>
                        <td class="date-cell">${formatDate(payment.created_at)}</td>
                        <td>${payment.client_name || 'Cliente directo'}</td>
                        <td class="amount-cell">$${amount.toFixed(2)}</td>
                        <td>
                            <span class="payment-method method-${payment.payment_method}">
                                ${payment.payment_method}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            return `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>No. Pedido</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Monto</th>
                            <th>M√©todo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paymentsRows}
                        <tr style="background: #f8fafc; font-weight: 600;">
                            <td colspan="3">TOTAL COBRANZAS</td>
                            <td class="amount-cell">$${totalCobranzas.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // Renderizar resumen por m√©todo de pago
        function renderPaymentSummary(summary) {
            if (!summary) {
                return `
                    <div class="no-data">
                        <h3>üìä No hay datos de resumen</h3>
                        <p>No se pudo generar el resumen de m√©todos de pago</p>
                    </div>
                `;
            }
            
            return `
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>üíµ Efectivo</h4>
                        <p class="summary-amount">$${(summary.efectivo || 0).toFixed(2)}</p>
                    </div>
                    <div class="summary-card">
                        <h4>üìù Cheque</h4>
                        <p class="summary-amount">$${(summary.cheque || 0).toFixed(2)}</p>
                    </div>
                    <div class="summary-card">
                        <h4>üè¶ Transferencia</h4>
                        <p class="summary-amount">$${(summary.transferencia || 0).toFixed(2)}</p>
                    </div>
                    <div class="summary-card">
                        <h4>üí≥ Tarjeta</h4>
                        <p class="summary-amount">$${(summary.tarjeta || 0).toFixed(2)}</p>
                    </div>
                    <div class="summary-card total-card">
                        <h4>üí∞ Total Cobrado</h4>
                        <p class="summary-amount">$${(summary.total || 0).toFixed(2)}</p>
                    </div>
                </div>
            `;
        }

        // Cerrar modal
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Imprimir reporte
        function printReport() {
            if (!currentReportData) {
                showNotification('Primero genera un reporte', 'warning');
                return;
            }
            
            // Si el modal no est√° abierto, generarlo primero
            if (!document.getElementById('reportModal').classList.contains('show')) {
                generateReport().then(() => {
                    setTimeout(() => window.print(), 500);
                });
            } else {
                window.print();
            }
        }

        // Formatear fecha
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-MX', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target === modal) {
                closeReportModal();
            }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('reportModal');
                if (modal.classList.contains('show')) {
                    closeReportModal();
                }
            }
        });

        // Funci√≥n de notificaci√≥n
        function showNotification(message, type = 'info') {
            if (window.showNotification) {
                window.showNotification(message, type);
            } else {
                alert(message);
            }
        }
    </script>
</body>
</html>