<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Ventas y Cobranzas - Sistema de Aceites</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="admin-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <span id="user-name"></span>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="products.html">Productos</a></li>
                <li><a href="employees.html">Vendedores</a></li>
                <li><a href="orders.html">Pedidos</a></li>
                <li><a href="subalmacenes.html">Subalmacenes</a></li>
                <li><a href="clients.html">Clientes</a></li>
                <li><a href="reports.html" class="active">Reportes</a></li>
                <li><a href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="report-container">
                <div class="report-header">
                    <h1> Reporte de Ventas y Cobranzas</h1>
                    <p>Genera reportes detallados de ventas diarias por vendedor</p>
                </div>

                <div class="report-controls">
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="report-date"> Fecha del Reporte</label>
                            <input type="date" id="report-date" required>
                        </div>

                        <div class="control-group">
                            <label for="employee-select"> vendedor</label>
                            <select id="employee-select" required>
                                <option value="">Seleccionar vendedor...</option>
                            </select>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateReport()">
                            Ver Reporte
                        </button>
                        <button class="btn btn-secondary" onclick="printReport()">
                            Imprimir Reporte
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal del Reporte -->
    <div id="reportModal" class="report-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Reporte Diario de Ventas y Cobranzas</h2>
                <button class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="reportContent">
                    <!-- El contenido del reporte se generar√° aqu√≠ -->
                </div>

                <div class="print-section">
                    <button class="btn btn-secondary" onclick="printReport()">
                         Imprimir Reporte
                    </button>
                    <button class="btn btn-primary" onclick="closeReportModal()">
                         Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        // Variables globales
        let currentEmployees = [];
        let currentReportData = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Iniciando p√°gina de reporte de ventas y cobranzas...');
            
            // Verificar autenticaci√≥n de admin
            if (!requireAdmin()) return;
            
            // Configurar fecha por defecto (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            
            // Cargar vendedors
            loadEmployees();
            
            console.log('‚úÖ P√°gina de reportes inicializada');
        });

        // Cargar lista de vendedors
        async function loadEmployees() {
            try {
                console.log('üë• Cargando vendedors...');
                
                currentEmployees = await window.getEmployees();
                
                const employeeSelect = document.getElementById('employee-select');
                employeeSelect.innerHTML = '<option value="">Seleccionar vendedor...</option>';
                
                // Filtrar solo vendedors (no admins)
                const employees = currentEmployees.filter(emp => emp.role === 'employee');
                
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.employee_code} - ${employee.name}`;
                    employeeSelect.appendChild(option);
                });
                
                console.log('‚úÖ vendedors cargados:', employees.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando vendedors:', error);
                showNotification('Error al cargar vendedors: ' + error.message, 'error');
            }
        }

        // Generar reporte
        async function generateReport() {
            const date = document.getElementById('report-date').value;
            const employeeId = document.getElementById('employee-select').value;
            
            if (!date || !employeeId) {
                showNotification('Por favor selecciona fecha y vendedor', 'warning');
                return;
            }
            
            try {
                console.log('üìä Generando reporte con debug activado...');
                
                // Mostrar indicador de carga
                const reportContent = document.getElementById('reportContent');
                reportContent.innerHTML = `
                    <div class="no-data">
                        <h3>üîÑ Generando reporte...</h3>
                        <p>Por favor espera mientras procesamos los datos</p>
                    </div>
                `;
                
                // DEBUG: Usar la funci√≥n de debug
                const reportData = await debugReportData(employeeId, date);
                currentReportData = reportData;
                
                // Renderizar reporte
                renderReport(reportData);
                
                // Mostrar modal
                document.getElementById('reportModal').classList.add('show');
                document.body.style.overflow = 'hidden';
                
                console.log('‚úÖ Reporte generado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte:', error);
                showNotification('Error al generar reporte: ' + error.message, 'error');
                
                // Mostrar error detallado en el contenido
                document.getElementById('reportContent').innerHTML = `
                    <div class="no-data" >
                        <h3> Error al generar reporte</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <details>
                            <summary>Detalles t√©cnicos</summary>
                            <pre style="text-align: left; font-size: 0.8rem; margin-top: 1rem;">${error.stack}</pre>
                        </details>
                    </div>
                `;
            }
        }
        // Obtener datos del reporte
        async function fetchReportData(employeeId, date) {
            try {
                // Hacer petici√≥n al endpoint de reporte
                const response = await fetch(`${window.API_BASE_URL}/api/reports/sales-collection?employee_id=${employeeId}&date=${date}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos del reporte obtenidos:', data);
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Error obteniendo datos del reporte:', error);
                throw error;
            }
        }

        // Renderizar reporte
        function renderReport(data) {
            const employee = currentEmployees.find(emp => emp.id === parseInt(data.employee_id));
            const reportDate = new Date(data.date).toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('modalTitle').textContent = 
                `Reporte de ${employee?.name || 'Vendedor'} - ${reportDate}`;
            
            const reportContent = document.getElementById('reportContent');
            
            reportContent.innerHTML = `
                <!-- Informaci√≥n del vendedor -->
                <div class="report-section">
                <div class="section-title">
                    Informaci√≥n del Vendedor
                </div>
                <div class="summary-grid">
                    <div class="summary-card">
                    <h4>Vendedor</h4>
                    <p class="summary-amount" style="font-size: 1.2rem;">${employee?.name || 'N/A'}</p>
                    </div>
                    <div class="summary-card">
                    <h4>C√≥digo</h4>
                    <p class="summary-amount" style="font-size: 1.2rem;">${employee?.employee_code || 'N/A'}</p>
                    </div>
                    <div class="summary-card">
                    <h4>Fecha</h4>
                    <p class="summary-amount" style="font-size: 1.2rem;">${reportDate}</p>
                    </div>
                </div>
                </div>

                <!-- Tabla de Ventas - SIMPLIFICADA -->
                <div class="report-section">
                <div class="section-title">
                    Ventas del D√≠a
                </div>
                ${renderSalesTable(data.sales, data.payments)}
                </div>

                <!-- Tabla de Cobranzas -->
                <div class="report-section">
                <div class="section-title">
                    Cobranzas del D√≠a
                </div>
                ${renderPaymentsTable(data.payments)}
                </div>

                <!-- Resumen por M√©todo de Pago -->
                <div class="report-section">
                <div class="section-title">
                    Resumen por M√©todo de Pago
                </div>
                ${renderPaymentSummary(data.payment_summary)}
                </div>
            `;
            }

        // Funci√≥n corregida para construir ventas desde pagos cuando sales est√° vac√≠o
        function renderSalesFromPayments(payments) {
            console.log('üîÑ Construyendo ventas desde pagos iniciales...');
            
            if (!payments || payments.length === 0) {
                return [];
            }
            
            // Filtrar solo abonos iniciales que representan ventas
            const initialPayments = payments.filter(payment => 
                payment.payment_type === 'initial_payment' && 
                payment.order_total && 
                payment.order_total > 0
            );
            
            console.log(' Abonos iniciales encontrados:', initialPayments.length);
            
            // Convertir abonos iniciales a formato de ventas
            const salesFromPayments = initialPayments.map(payment => {
                return {
                    id: payment.order_id,
                    order_number: payment.order_number,
                    sale_number: payment.order_number, // Usar order_number como sale_number
                    total: payment.order_total,
                    paid_amount: payment.amount,
                    client_info: {
                        name: payment.client_name
                    },
                    client_name: payment.client_name,
                    created_at: payment.created_at,
                    employee_id: payment.recorded_by,
                    employee_code: payment.recorded_by_code,
                    payment_method: payment.payment_method,
                    // Marcar como construido desde pagos
                    _source: 'from_payments'
                };
            });
            
            console.log('‚úÖ Ventas construidas desde pagos:', salesFromPayments.length);
            return salesFromPayments;
        }

        // Renderizar tabla de ventas
        function renderSalesTable(sales, payments) {
            console.log('üìä RENDER SALES TABLE CORREGIDO - Mostrando TODAS las ventas:', { 
                sales: sales?.length || 0, 
                payments: payments?.length || 0 
            });
            
            let processedSales = sales || [];
            
            if (!processedSales || processedSales.length === 0) {
                console.log('‚ö†Ô∏è No hay ventas para mostrar');
                return `
                    <div class="no-data">
                        <h3>No hay ventas registradas</h3>
                        <p>No se encontraron ventas confirmadas para este vendedor en la fecha seleccionada</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                            <strong>Nota:</strong> Solo se muestran pedidos que han sido confirmados como ventas.
                        </div>
                    </div>
                `;
            }
            
            console.log(`‚úÖ Procesando ${processedSales.length} ventas para la tabla`);
            
            let totalVentas = 0;
            let totalAbonado = 0;
            let ventasConAbono = 0;
            let ventasSinAbono = 0;
            
            const salesRows = processedSales.map((sale, index) => {
                const total = parseFloat(sale.total) || 0;
                const paidAmount = parseFloat(sale.paid_amount) || 0;
                
                totalVentas += total;
                totalAbonado += paidAmount;
                
                // ‚úÖ CONTAR VENTAS POR TIPO DE ABONO
                if (paidAmount > 0) {
                    ventasConAbono++;
                } else {
                    ventasSinAbono++;
                }
                
                const folio = sale.order_number || sale.sale_number || `VENTA-${sale.id}` || 'N/A';
                
                let fechaFormateada = 'Fecha no disponible';
                try {
                    if (sale.created_at) {
                        fechaFormateada = formatDate(sale.created_at);
                    }
                } catch (error) {
                    console.warn('Error formateando fecha:', error);
                    fechaFormateada = sale.created_at || 'Fecha inv√°lida';
                }
                
                let clienteName = 'Cliente directo';
                try {
                    if (sale.client_info) {
                        if (typeof sale.client_info === 'string') {
                            const parsed = JSON.parse(sale.client_info);
                            clienteName = parsed.name || 'Cliente directo';
                        } else if (typeof sale.client_info === 'object' && sale.client_info.name) {
                            clienteName = sale.client_info.name;
                        }
                    } else if (sale.client_name) {
                        clienteName = sale.client_name;
                    }
                } catch (error) {
                    console.warn('Error parseando client_info:', error);
                    clienteName = sale.client_name || 'Cliente directo';
                }
                
                // ‚úÖ MEJORAR VISUALIZACI√ìN DEL ABONO
                let abonoDisplay = '';
                let abonoStyle = '';
                
                if (paidAmount > 0) {
                    abonoDisplay = `${paidAmount.toFixed(2)}`;
                    abonoStyle = '';
                } else {
                    abonoDisplay = '0.00';
                    abonoStyle = '';
                }
                
                const abonoSubtext = paidAmount > 0 
                    ? `<small></small>`
                    : `<small></small>`;
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${folio}</div>
                            <small style="color: #64748b;"></small>
                        </td>
                        <td class="date-cell">${fechaFormateada}</td>
                        <td>${clienteName}</td>
                        <td class="amount-cell">${total.toFixed(2)}</td>
                        <td class="amount-cell" style="${abonoStyle}">
                            ${abonoDisplay}
                            ${abonoSubtext}
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('üìä Estad√≠sticas de ventas corregidas:', {
                total_ventas: totalVentas,
                total_abonado: totalAbonado,
                ventas_con_abono: ventasConAbono,
                ventas_sin_abono: ventasSinAbono,
                pendiente: totalVentas - totalAbonado
            });
            
            return `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Total Venta</th>
                            <th>Abono Inicial</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${salesRows}
                        <tr style="background: #f0f9ff; border-top: 2px solid #0369a1;">
                            <td colspan="2"><strong>TOTALES</strong></td>
                            <td><strong>Ventas: ${processedSales.length}</strong></td>
                            <td class="amount-cell"><strong>${totalVentas.toFixed(2)}</strong></td>
                            <td class="amount-cell"><strong>${totalAbonado.toFixed(2)}</strong></td>
                        </tr>
                        <tr style="background: #f8fafc; font-weight: 600; border-top: 2px solid #334155;">
                            <td colspan="2"><strong>RESUMEN</strong></td>
                            <td><strong>Saldo pendiente:</strong></td>
                            <td class="amount-cell"><strong>${(totalVentas - totalAbonado).toFixed(2)}</strong></td>
                            <td class="amount-cell">
                                <strong style="color: ${totalAbonado >= totalVentas ? '#059669' : '#dc2626'};">
                                    ${totalAbonado >= totalVentas ? '' : ' '}
                                </strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                
                <style>
                .amount-cell {
                    text-align: right;
                    font-weight: 600;
                }
                
                .date-cell {
                    font-size: 0.9rem;
                    color: #64748b;
                }
                
                .sales-explanation ul li {
                    margin-bottom: 0.25rem;
                }
                
                @media (max-width: 768px) {
                    .report-table {
                        font-size: 0.9rem;
                    }
                    
                    .report-table th,
                    .report-table td {
                        padding: 0.5rem 0.25rem;
                    }
                }
                </style>
            `;
        }
            
                
        // Renderizar tabla de cobranzas - CON COLUMNA POR PAGAR
        function renderPaymentsTable(payments) {
            console.log('üîç RENDER PAYMENTS TABLE CORREGIDO - Datos recibidos:', { 
                payments: payments?.length || 0 
            });
            
            if (!payments || payments.length === 0) {
                return `
                    <div class="no-data">
                        <h3>No hay cobranzas registradas</h3>
                        <p>No se encontraron pagos registrados por este vendedor en la fecha seleccionada</p>
                    </div>
                `;
            }
            
            let totalCobranzas = 0;
            let totalAbonos = 0;
            let totalPagos = 0;
            
            // Separar pagos por tipo
            const abonosIniciales = payments.filter(p => p.payment_type === 'initial_payment');
            const pagosPosteriores = payments.filter(p => p.payment_type === 'subsequent_payment');
            
            const paymentsRows = payments.map(payment => {
                const amount = parseFloat(payment.amount) || 0;
                totalCobranzas += amount;
                
                // Clasificar tipo de pago
                const isInitialPayment = payment.payment_type === 'initial_payment';
                
                if (isInitialPayment) {
                    totalAbonos += amount;
                } else {
                    totalPagos += amount;
                }
                
                // Determinar icono y clase seg√∫n el tipo
                let typeIcon = '';
                let typeClass = 'payment-type-subsequent';
                let typeLabel = 'Pago Posterior';
                let typeDescription = 'Abono registrado despu√©s de la venta';
                
                if (isInitialPayment) {
                    typeIcon = 'üí∞';
                    typeClass = 'payment-type-initial';
                    typeLabel = 'Abono Inicial';
                    typeDescription = 'Pago al momento de crear el pedido';
                } else {
                    typeIcon = 'üí≥';
                }
                
                // Calcular saldo pendiente
                const orderTotal = parseFloat(payment.order_total) || 0;
                const orderPaidAmount = parseFloat(payment.order_paid_amount) || 0;
                const balanceRemaining = Math.max(0, orderTotal - orderPaidAmount);
                
                return `
                    <tr class="${typeClass}">
                        <td>
                            <div class="payment-info">
                                <strong>${payment.order_number || 'N/A'}</strong>
                                <div class="payment-type-badge ${typeClass}">
                                    ${typeIcon} ${typeLabel}
                                </div>
                                <small style="color: #64748b;">${typeDescription}</small>
                            </div>
                        </td>
                        <td class="date-cell">${formatDate(payment.created_at)}</td>
                        <td>${payment.client_name || 'Cliente directo'}</td>
                        <td class="amount-cell">$${amount.toFixed(2)}</td>
                        <td class="amount-cell">
                            <span style="color: ${balanceRemaining > 0 ? '#dc2626' : '#059669'};">
                                $${balanceRemaining.toFixed(2)}
                            </span>
                        </td>
                        <td>
                            <span class="payment-method method-${payment.payment_method}">
                                ${getPaymentMethodIcon(payment.payment_method)} ${payment.payment_method}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            return `
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>No. Pedido / Tipo</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Monto</th>
                            <th>Por Pagar</th>
                            <th>M√©todo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paymentsRows}
                    </tbody>
                </table>
                
                <style>
                .payment-type-initial {
                    background-color: rgba(16, 185, 129, 0.05);
                    border-left: 3px solid #10b981;
                }
                
                .payment-type-subsequent {
                    background-color: rgba(59, 130, 246, 0.05);
                    border-left: 3px solid #3b82f6;
                }
                
                .payment-info {
                    display: flex;
                    flex-direction: column;
                    gap: 0.25rem;
                }
                
                .payment-type-badge {
                    font-size: 0.75rem;
                    padding: 0.125rem 0.375rem;
                    border-radius: 12px;
                    font-weight: 500;
                    width: fit-content;
                }
                
                .payment-type-badge.payment-type-initial {
                    background: #d1fae5;
                    color: #065f46;
                    border: 1px solid #10b981;
                }
                
                .payment-type-badge.payment-type-subsequent {
                    background: #dbeafe;
                    color: #1e40af;
                    border: 1px solid #3b82f6;
                }
                
                .payment-breakdown {
                    border: 1px solid #e2e8f0;
                }
                
                .payments-explanation ul li {
                    margin-bottom: 0.25rem;
                }
                </style>
            `;
        }      
                

        // Renderizar resumen por m√©todo de pago - SIN PORCENTAJES
        function renderPaymentSummary(summary) {
            if (!summary) {
                return `
                    <div class="no-data">
                        <h3>No hay datos de resumen</h3>
                        <p>No se pudo generar el resumen de m√©todos de pago</p>
                    </div>
                `;
            }
            
            // Calcular total
            const total = summary.total || 0;
            const efectivo = summary.efectivo || 0;
            const cheque = summary.cheque || 0;
            const transferencia = summary.transferencia || 0;
            const tarjeta = summary.tarjeta || 0;
            
            return `
                <div class="summary-grid enhanced-summary">
                    <div class="summary-card efectivo-card">
                        <div class="card-header">
                            <h4> Efectivo</h4>
                        </div>
                        <p class="summary-amount">$${efectivo.toFixed(2)}</p>
                    </div>
                    
                    <div class="summary-card cheque-card">
                        <div class="card-header">
                            <h4>Cheque</h4>
                        </div>
                        <p class="summary-amount">$${cheque.toFixed(2)}</p>
                    </div>
                    
                    <div class="summary-card transferencia-card">
                        <div class="card-header">
                            <h4>Transferencia</h4>
                        </div>
                        <p class="summary-amount">$${transferencia.toFixed(2)}</p>
                    </div>
                    
                    <div class="summary-card tarjeta-card">
                        <div class="card-header">
                            <h4>Tarjeta</h4>
                        </div>
                        <p class="summary-amount">$${tarjeta.toFixed(2)}</p>
                    </div>
                    
                    <div class="summary-card total-card">
                        <div class="card-header">
                            <h4>Total Cobrado</h4>
                        </div>
                        <p class="summary-amount total-amount" style="color: black">$${total.toFixed(2)}</p>
                    </div>
                </div>
                
                <style>
                .enhanced-summary {
                    gap: 1rem;
                }
                
                .summary-card {
                    background: white;
                    border: 1px solid #e2e8f0;
                    border-radius: 12px;
                    padding: 1.5rem;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    transition: transform 0.2s, box-shadow 0.2s;
                }
                
                .summary-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }
                
                .card-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 1rem;
                }
                
                .card-header h4 {
                    margin: 0;
                    font-size: 1rem;
                    color: #334155;
                }
                
                .summary-amount {
                    font-size: 1.5rem;
                    font-weight: 700;
                    margin: 0;
                    color: #1e293b;
                }
                
                .total-amount {
                    font-size: 1.75rem;
                    color: #059669;
                }
                
                .total-card {
                    border: 2px solid #059669;
                }
                
                .total-breakdown {
                    margin-top: 0.5rem;
                }
                
                .total-breakdown small {
                    font-style: italic;
                }
                
                @media (max-width: 768px) {
                    .enhanced-summary {
                        grid-template-columns: 1fr;
                    }
                    
                    .summary-amount {
                        font-size: 1.25rem;
                    }
                    
                    .total-amount {
                        font-size: 1.5rem;
                    }
                }
                </style>
            `;
        }
        
        // Cerrar modal
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Imprimir reporte
        function printReport() {
            if (!currentReportData) {
                showNotification('Primero genera un reporte', 'warning');
                return;
            }
            
            // ===== FUNCI√ìN HELPER PARA FORMATEAR MONEDA =====
            function formatCurrencyForPrint(amount) {
                if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
                return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
                }).format(amount);
            }
            
            // ===== FUNCI√ìN HELPER PARA FORMATEAR FECHAS =====
            function formatDateForPrint(dateString) {
                if (!dateString) return 'No especificada';
                try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                } catch (error) {
                return dateString;
                }
            }
            
            // ===== PROCESAR VENTAS =====
            let processedSales = currentReportData.sales || [];
            
            // Si no hay ventas pero hay pagos, construir ventas desde pagos
            if ((!currentReportData.sales || currentReportData.sales.length === 0) && 
                currentReportData.payments && currentReportData.payments.length > 0) {
                console.log('üîÑ PRINT - No hay ventas directas, construyendo desde pagos...');
                
                const initialPayments = currentReportData.payments.filter(payment => 
                payment.payment_type === 'initial_payment' && 
                payment.order_total && 
                payment.order_total > 0
                );
                
                processedSales = initialPayments.map(payment => ({
                id: payment.order_id,
                order_number: payment.order_number,
                sale_number: payment.order_number,
                total: payment.order_total,
                paid_amount: payment.amount,
                client_info: { name: payment.client_name },
                client_name: payment.client_name,
                created_at: payment.created_at,
                _source: 'from_payments'
                }));
            }
            
            console.log('üìä PRINT - Ventas procesadas para imprimir:', processedSales.length);
            
            // ===== GENERAR FILAS DE VENTAS COMPACTAS =====
            const salesRows = processedSales.map(sale => {
                const total = parseFloat(sale.total) || 0;
                const paidAmount = parseFloat(sale.paid_amount) || 0;
                const folio = sale.order_number || sale.sale_number || `V-${sale.id}` || 'N/A';
                
                let clienteName = 'Cliente directo';
                try {
                if (sale.client_info) {
                    if (typeof sale.client_info === 'string') {
                    const parsed = JSON.parse(sale.client_info);
                    clienteName = parsed.name || 'Cliente directo';
                    } else if (typeof sale.client_info === 'object' && sale.client_info.name) {
                    clienteName = sale.client_info.name;
                    }
                } else if (sale.client_name) {
                    clienteName = sale.client_name;
                }
                } catch (error) {
                console.warn('‚ö†Ô∏è PRINT - Error parseando client_info:', error);
                clienteName = sale.client_name || 'Cliente directo';
                }
                
                // Truncar nombre del cliente si es muy largo
                if (clienteName.length > 20) {
                    clienteName = clienteName.substring(0, 17) + '...';
                }
                
                return `
                <tr>
                    <td>${folio}</td>
                    <td>${formatDateForPrint(sale.created_at)}</td>
                    <td>${clienteName}</td>
                    <td class="money">${formatCurrencyForPrint(total)}</td>
                    <td class="money">${formatCurrencyForPrint(paidAmount)}</td>
                </tr>
                `;
            }).join('');
            
            // ===== CALCULAR TOTALES =====
            const totalVentas = processedSales.reduce((sum, sale) => sum + (parseFloat(sale.total) || 0), 0);
            const totalAbonado = processedSales.reduce((sum, sale) => sum + (parseFloat(sale.paid_amount) || 0), 0);
            
            // ===== OBTENER INFORMACI√ìN DEL VENDEDOR =====
            const employee = currentEmployees.find(emp => emp.id === parseInt(currentReportData.employee_id));
            const reportDate = new Date(currentReportData.date).toLocaleDateString('es-MX', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            // ===== C√ìDIGO DE IMPRESI√ìN OPTIMIZADO =====
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                <title>Reporte ${employee?.name || 'Vendedor'} - ${reportDate}</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { 
                        font-family: 'Arial', sans-serif; 
                        font-size: 11px;
                        line-height: 1.2;
                        color: #000;
                        padding: 15mm;
                        max-width: 210mm;
                    }
                    
                    .header { 
                        text-align: center; 
                        margin-bottom: 15px; 
                        border-bottom: 2px solid #000; 
                        padding-bottom: 8px; 
                    }
                    .header h1 {
                        font-size: 16px;
                        font-weight: bold;
                        margin-bottom: 3px;
                        text-transform: uppercase;
                    }
                    .header p {
                        font-size: 10px;
                        color: #666;
                    }
                    
                    .info-section {
                        margin: 10px 0;
                        border: 1px solid #000;
                        padding: 8px;
                    }
                    .info-row {
                        display: flex;
                        justify-content: space-between;
                        margin: 2px 0;
                    }
                    .info-label {
                        font-weight: bold;
                        width: 80px;
                    }
                    
                    .section-title { 
                        background: #f0f0f0; 
                        padding: 4px 8px; 
                        margin: 12px 0 5px 0;
                        border: 1px solid #000;
                        font-weight: bold;
                        font-size: 12px;
                        text-transform: uppercase;
                    }
                    
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin: 5px 0; 
                        font-size: 10px;
                    }
                    th, td { 
                        border: 1px solid #000; 
                        padding: 3px 4px; 
                        text-align: left; 
                    }
                    th { 
                        background: #e0e0e0;
                        font-weight: bold;
                        font-size: 9px;
                        text-transform: uppercase;
                    }
                    .money {
                        text-align: right;
                        font-family: 'Courier New', monospace;
                    }
                    
                    .total-section {
                        margin-top: 10px;
                        border: 2px solid #000;
                        padding: 8px;
                        background: #f8f8f8;
                    }
                    .total-row {
                        display: flex;
                        justify-content: space-between;
                        margin: 2px 0;
                        font-weight: bold;
                    }
                    .grand-total {
                        font-size: 12px;
                        border-top: 1px solid #000;
                        padding-top: 4px;
                        margin-top: 4px;
                    }
                    
                    .footer {
                        margin-top: 15px;
                        padding-top: 8px;
                        border-top: 1px solid #ccc;
                        font-size: 8px;
                        text-align: center;
                        color: #666;
                    }
                    
                    .no-data {
                        text-align: center;
                        padding: 20px;
                        color: #666;
                        font-style: italic;
                        border: 1px dashed #ccc;
                    }
                    
                    @media print {
                        body { 
                            margin: 0; 
                            padding: 10mm; 
                        }
                        .section { 
                            page-break-inside: avoid; 
                        }
                        @page {
                            margin: 10mm;
                            size: A4;
                        }
                    }
                </style>
                </head>
                <body>
                
                <div class="header">
                    <h1>Reporte de Ventas y Cobranzas</h1>
                    <p>Reporte Diario de Actividades</p>
                </div>
                
                <div class="info-section">
                    <div class="info-row">
                        <span><span class="info-label">Vendedor:</span> ${employee?.name || 'N/A'}</span>
                        <span><span class="info-label">C√≥digo:</span> ${employee?.employee_code || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span><span class="info-label">Fecha:</span> ${reportDate}</span>
                        <span><span class="info-label">Ventas:</span> ${processedSales.length}</span>
                    </div>
                </div>
                
                <div class="section-title">Detalle de Ventas</div>
                
                ${processedSales && processedSales.length > 0 ? `
                <table>
                    <thead>
                    <tr>
                        <th style="width: 15%;">Folio</th>
                        <th style="width: 20%;">Fecha/Hora</th>
                        <th style="width: 35%;">Cliente</th>
                        <th style="width: 15%;">Total</th>
                        <th style="width: 15%;">Abonado</th>
                    </tr>
                    </thead>
                    <tbody>
                    ${salesRows}
                    </tbody>
                </table>
                
                <div class="total-section">
                    <div class="total-row">
                        <span>N√∫mero de Ventas:</span>
                        <span>${processedSales.length}</span>
                    </div>
                    <div class="total-row">
                        <span>Total Ventas:</span>
                        <span>${formatCurrencyForPrint(totalVentas)}</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total Cobrado:</span>
                        <span>${formatCurrencyForPrint(totalAbonado)}</span>
                    </div>
                </div>
                ` : `
                <div class="no-data">
                    <h4>Sin Ventas Registradas</h4>
                    <p>No se encontraron ventas para este vendedor en la fecha seleccionada</p>
                </div>
                `}
                
                <!-- SECCI√ìN DE COBRANZAS -->
                <div class="section-title">Cobranzas del D√≠a</div>
                
                ${currentReportData.payments && currentReportData.payments.length > 0 ? `
                <table>
                    <thead>
                    <tr>
                        <th style="width: 15%;">Folio</th>
                        <th style="width: 20%;">Fecha/Hora</th>
                        <th style="width: 25%;">Cliente</th>
                        <th style="width: 15%;">Tipo</th>
                        <th style="width: 10%;">M√©todo</th>
                        <th style="width: 15%;">Monto</th>
                    </tr>
                    </thead>
                    <tbody>
                    ${currentReportData.payments.map(payment => `
                        <tr>
                            <td>${payment.order_number || 'N/A'}</td>
                            <td>${formatDateForPrint(payment.created_at)}</td>
                            <td>${payment.client_name || 'Cliente directo'}</td>
                            <td>${payment.payment_type === 'initial_payment' ? 'Inicial' : 'Abono'}</td>
                            <td>${payment.payment_method || 'N/A'}</td>
                            <td class="money">${formatCurrencyForPrint(payment.amount)}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
                
                <div class="total-section">
                    <div class="total-row">
                        <span>Total Pagos:</span>
                        <span>${currentReportData.payments.length}</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total Cobrado:</span>
                        <span>${formatCurrencyForPrint(currentReportData.payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0))}</span>
                    </div>
                </div>
                ` : `
                <div class="no-data">
                    <h4>Sin Cobranzas Registradas</h4>
                    <p>No se encontraron pagos para este vendedor en la fecha seleccionada</p>
                </div>
                `}
                
                <!-- SECCI√ìN DE M√âTODOS DE PAGO -->
                <div class="section-title">Resumen por M√©todo de Pago</div>
                
                ${(() => {
                    if (!currentReportData.payments || currentReportData.payments.length === 0) {
                        return `<div class="no-data"><p>No hay datos de m√©todos de pago</p></div>`;
                    }
                    
                    // Agrupar pagos por m√©todo
                    const paymentMethods = {};
                    currentReportData.payments.forEach(payment => {
                        const method = payment.payment_method || 'No especificado';
                        if (!paymentMethods[method]) {
                            paymentMethods[method] = { count: 0, total: 0 };
                        }
                        paymentMethods[method].count++;
                        paymentMethods[method].total += parseFloat(payment.amount) || 0;
                    });
                    
                    return `
                    <table>
                        <thead>
                        <tr>
                            <th style="width: 50%;">M√©todo de Pago</th>
                            <th style="width: 25%;">Cantidad</th>
                            <th style="width: 25%;">Total</th>
                        </tr>
                        </thead>
                        <tbody>
                        ${Object.entries(paymentMethods).map(([method, data]) => `
                            <tr>
                                <td>${method}</td>
                                <td style="text-align: center;">${data.count}</td>
                                <td class="money">${formatCurrencyForPrint(data.total)}</td>
                            </tr>
                        `).join('')}
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td>TOTAL GENERAL</td>
                            <td style="text-align: center;">${currentReportData.payments.length}</td>
                            <td class="money">${formatCurrencyForPrint(Object.values(paymentMethods).reduce((sum, data) => sum + data.total, 0))}</td>
                        </tr>
                        </tbody>
                    </table>
                    `;
                })()}
                
                <div class="footer">
                    <p><strong>Impreso:</strong> ${formatDateForPrint(new Date().toISOString())} | 
                    <strong>Sistema de Gesti√≥n Comercial</strong></p>
                </div>
                
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }
        
        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'Sin fecha';
            
            try {
                const date = new Date(dateString);
                
                // Verificar si la fecha es v√°lida
                if (isNaN(date.getTime())) {
                    console.warn('‚ö†Ô∏è Fecha inv√°lida:', dateString);
                    return 'Fecha inv√°lida';
                }
                
                return date.toLocaleDateString('es-MX', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('‚ùå Error formateando fecha:', error);
                return dateString;
            }
        }
        
        // Funci√≥n para obtener icono de m√©todo de pago
        function getPaymentMethodIcon(method) {
            const icons = {
                'efectivo': '',
                'tarjeta': '',
                'transferencia': '',
                'cheque': ''
            };
            return icons[method] || '';
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target === modal) {
                closeReportModal();
            }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('reportModal');
                if (modal.classList.contains('show')) {
                    closeReportModal();
                }
            }
        });

        // Funci√≥n de notificaci√≥n
        function showNotification(message, type = 'info') {
            if (window.showNotification && window.showNotification !== showNotification) {
                window.showNotification(message, type);
            } else {
                // Fallback simple con console y alert
                console.log(`${type.toUpperCase()}: ${message}`);
                if (type === 'error' || type === 'warning') {
                    alert(`${type.toUpperCase()}: ${message}`);
                }
            }
        }

        // Funci√≥n para logout
        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.clear();
                window.location.href = '/';
            }
        }
            
        // Funci√≥n de debug temporal - agregar al inicio de generateReport()
        async function debugReportData(employeeId, date) {
            console.log('üîç DEBUG CORREGIDO - Iniciando an√°lisis de datos del reporte');
            console.log('üîç DEBUG - Par√°metros:', { employeeId, date });
            
            try {
                // Test de conexi√≥n a la API
                const testResponse = await fetch(`${window.API_BASE_URL}/test`);
                const testData = await testResponse.json();
                console.log('üîç DEBUG - Test de API:', testData);
                
                // Test espec√≠fico del endpoint de reporte CORREGIDO
                const reportUrl = `${window.API_BASE_URL}/api/reports/sales-collection?employee_id=${employeeId}&date=${date}`;
                console.log('üîç DEBUG - URL del reporte:', reportUrl);
                
                const reportResponse = await fetch(reportUrl, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('üîç DEBUG - Status de respuesta:', reportResponse.status);
                console.log('üîç DEBUG - Headers de respuesta:', [...reportResponse.headers.entries()]);
                
                if (!reportResponse.ok) {
                    const errorText = await reportResponse.text();
                    console.error('‚ùå DEBUG - Error en respuesta:', errorText);
                    throw new Error(`Error ${reportResponse.status}: ${errorText}`);
                }
                
                const reportData = await reportResponse.json();
                console.log('üîç DEBUG - Datos completos del reporte CORREGIDO:', reportData);
                
                // ===== AN√ÅLISIS DETALLADO DE LOS DATOS CORREGIDOS =====
                console.log('üìä DEBUG - AN√ÅLISIS DE VENTAS:');
                console.log('  - Ventas recibidas:', reportData.sales?.length || 0);
                console.log('  - Fuente de ventas:', reportData.sales?.[0]?._source || 'N/A');
                
                if (reportData.sales && reportData.sales.length > 0) {
                    const ventasConAbono = reportData.sales.filter(s => (parseFloat(s.paid_amount) || 0) > 0);
                    const ventasSinAbono = reportData.sales.filter(s => (parseFloat(s.paid_amount) || 0) === 0);
                    
                    console.log('  - Ventas con abono inicial:', ventasConAbono.length);
                    console.log('  - Ventas sin abono inicial:', ventasSinAbono.length);
                    console.log('  - Primera venta detallada:', JSON.stringify(reportData.sales[0], null, 2));
                }
                
                console.log('üí≥ DEBUG - AN√ÅLISIS DE PAGOS:');
                console.log('  - Pagos totales recibidos:', reportData.payments?.length || 0);
                
                if (reportData.payments && reportData.payments.length > 0) {
                    const abonosIniciales = reportData.payments.filter(p => p.payment_type === 'initial_payment');
                    const pagosPosteriores = reportData.payments.filter(p => p.payment_type === 'subsequent_payment');
                    
                    console.log('  - Abonos iniciales:', abonosIniciales.length);
                    console.log('  - Pagos posteriores:', pagosPosteriores.length);
                    console.log('  - Primer pago detallado:', JSON.stringify(reportData.payments[0], null, 2));
                    
                    // Verificar si hay duplicados
                    const possibleDuplicates = [];
                    abonosIniciales.forEach(inicial => {
                        const ventaCorrespondiente = reportData.sales?.find(s => 
                            s.order_id === inicial.order_id && 
                            Math.abs(parseFloat(s.paid_amount) - parseFloat(inicial.amount)) < 0.01
                        );
                        
                        if (ventaCorrespondiente) {
                            possibleDuplicates.push({
                                order_id: inicial.order_id,
                                venta_abono: ventaCorrespondiente.paid_amount,
                                pago_inicial: inicial.amount,
                                diferencia: Math.abs(parseFloat(ventaCorrespondiente.paid_amount) - parseFloat(inicial.amount))
                            });
                        }
                    });
                    
                    console.log('  - ‚úÖ VERIFICACI√ìN DE DUPLICADOS:', possibleDuplicates.length === 0 ? 'SIN DUPLICADOS' : `${possibleDuplicates.length} POSIBLES DUPLICADOS`);
                    if (possibleDuplicates.length > 0) {
                        console.log('  - Detalles de duplicados:', possibleDuplicates);
                    }
                }
                
                console.log('üìà DEBUG - ESTAD√çSTICAS:');
                if (reportData.statistics) {
                    console.log('  - Total ventas:', reportData.statistics.total_ventas);
                    console.log('  - Total abonado (inicial):', reportData.statistics.total_abonado);
                    console.log('  - Total cobrado (todo):', reportData.statistics.total_cobrado);
                    console.log('  - Diferencia (cobrado - abonado):', reportData.statistics.total_cobrado - reportData.statistics.total_abonado);
                }
                
                console.log('üîß DEBUG - INFORMACI√ìN DE CORRECCI√ìN:');
                if (reportData.debug_info) {
                    console.log('  - Pedidos confirmados encontrados:', reportData.debug_info.confirmed_orders_found);
                    console.log('  - Pagos encontrados:', reportData.debug_info.payments_found);
                    console.log('  - Duplicados excluidos:', reportData.debug_info.duplicate_payments_excluded);
                }
                
                return reportData;
                
            } catch (error) {
                console.error('‚ùå DEBUG - Error completo:', error);
                console.error('‚ùå DEBUG - Stack trace:', error.stack);
                throw error;
            }
        }

        // ===== FUNCI√ìN AUXILIAR PARA VALIDAR CONSISTENCIA DE DATOS =====
        function validateReportConsistency(reportData) {
            console.log('üîç Validando consistencia de datos del reporte...');
            
            const issues = [];
            const warnings = [];
            
            if (!reportData.sales || !reportData.payments) {
                issues.push('Faltan datos de ventas o pagos');
                return { valid: false, issues, warnings };
            }
            
            // Validar que no haya duplicados en los montos
            const totalVentasAbonado = reportData.sales.reduce((sum, sale) => sum + (parseFloat(sale.paid_amount) || 0), 0);
            const totalAbonosIniciales = reportData.payments
                .filter(p => p.payment_type === 'initial_payment')
                .reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
            
            const diferencia = Math.abs(totalVentasAbonado - totalAbonosIniciales);
            
            if (diferencia > 0.01) {
                warnings.push(`Diferencia entre abonos en ventas (${totalVentasAbonado}) y abonos iniciales (${totalAbonosIniciales}): ${diferencia}`);
            } else {
                console.log('‚úÖ Consistencia verificada: abonos iniciales coinciden');
            }
            
            // Validar que los IDs de √≥rdenes sean √∫nicos en ventas
            const orderIds = reportData.sales.map(s => s.order_id);
            const uniqueOrderIds = [...new Set(orderIds)];
            
            if (orderIds.length !== uniqueOrderIds.length) {
                issues.push('Hay ventas duplicadas con el mismo order_id');
            }
            
            // Validar fechas
            const invalidDates = reportData.sales.filter(sale => !sale.created_at || isNaN(new Date(sale.created_at).getTime()));
            if (invalidDates.length > 0) {
                warnings.push(`${invalidDates.length} ventas tienen fechas inv√°lidas`);
            }
            
            return {
                valid: issues.length === 0,
                issues,
                warnings,
                summary: {
                    total_ventas: reportData.sales.length,
                    total_pagos: reportData.payments.length,
                    abonos_iniciales: reportData.payments.filter(p => p.payment_type === 'initial_payment').length,
                    pagos_posteriores: reportData.payments.filter(p => p.payment_type === 'subsequent_payment').length,
                    diferencia_abonos: diferencia
                }
            };
        }
            
    </script>
</body>
</html>