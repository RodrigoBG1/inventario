<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Pedido - Sistema de Aceites</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/employee.css">
    <script src="../js/employee.js"></script>
</head>
<body>
    <div class="employee-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Panel vendedor</h2>
                <span id="user-name"></span>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Inicio</a></li>
                <li><a href="orders.html" class="active">Crear Pedido</a></li>
                <li><a href="sales.html">Pagos</a></li>
                <li><a href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header class="content-header">
                <h1>Nuevo Pedido - Subalmac√©n</h1>
                <div class="header-actions">
                    <button id="refresh-substore-btn" class="btn btn-secondary" onclick="refreshSubstoreStatus()">
                        Actualizar Estado
                    </button>
                </div>
            </header>

            <!-- Estado del Subalmac√©n -->
            <div id="substore-status-container">
                <!-- Se llena din√°micamente -->
            </div>

            <!-- Contenido del formulario de pedido -->
            <div id="order-form-container" class="order-form-container" style="display: none;">
                
                <!-- Informaci√≥n del Cliente -->
                <div class="form-section">
                    <h3 class="section-title">Informaci√≥n del Cliente</h3>
                    <div style="padding: 1.5rem;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="client-name">Nombre del Cliente: *</label>
                                <input type="text" id="client-name" required placeholder="Nombre completo del cliente">
                            </div>
                            <div class="form-group">
                                <label for="client-phone">Tel√©fono:</label>
                                <input type="tel" id="client-phone" placeholder="N√∫mero de tel√©fono">
                            </div>
                            <div class="form-group">
                                <label for="client-address">Direcci√≥n:</label>
                                <input type="text" id="client-address" placeholder="Direcci√≥n de entrega">
                            </div>
                            <div class="form-group">
                                <label for="client-email">Email:</label>
                                <input type="email" id="client-email" placeholder="correo@ejemplo.com">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Productos del Subalmac√©n -->
                <div class="form-section">
                    <h3 class="section-title"> Productos Disponibles en mi Subalmac√©n</h3>
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <input type="text" id="product-search" class="search-input" 
                               placeholder=" Buscar productos en mi subalmac√©n...">
                    </div>
                    
                    <div style="padding: 1.5rem;">
                        <div id="products-list" class="loading">Cargando productos del subalmac√©n...</div>
                        
                        <div class="selected-products" style="margin-top: 2rem;">
                            <h4>Productos en el Pedido (<span id="products-count">0</span>)</h4>
                            <div style="overflow-x: auto;">
                                <table id="order-products-table">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Precio Unit.</th>
                                            <th>Cantidad</th>
                                            <th>Subtotal</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" style="text-align: center; padding: 2rem; color: #64748b;">
                                                üìù No hay productos en el pedido
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="cart-summary">
                                <div class="cart-items-count" id="cart-items-count">0 productos seleccionados</div>
                                <div class="cart-total">Total: <span id="order-total">$0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN MEJORADA: Opciones de Pago -->
                <div class="payment-options-section">
                    <h3 class="payment-section-title">
                        üí≥ Modalidad y Tipo de Pago
                    </h3>
                    
                    <!-- Modalidad de pago -->
                    <div class="payment-method-grid">
                        <div class="payment-method-option selected" onclick="selectPaymentMethod('cash')">
                            <input type="radio" name="payment_method" value="cash" id="payment-cash" checked>
                            <div class="payment-method-header">
                                <div class="payment-icon">üíµ</div>
                                <div class="payment-title">Contado</div>
                            </div>
                            <div class="payment-description">
                                Pago completo al momento de la entrega
                            </div>
                        </div>

                        <div class="payment-method-option" onclick="selectPaymentMethod('credit')">
                            <input type="radio" name="payment_method" value="credit" id="payment-credit">
                            <div class="payment-method-header">
                                <div class="payment-icon">üìã</div>
                                <div class="payment-title">Cr√©dito</div>
                            </div>
                            <div class="payment-description">
                                El cliente puede abonar parcialmente
                            </div>
                        </div>
                    </div>

                    <!-- NUEVO: Tipo de pago espec√≠fico -->
                    <div class="payment-type-section">
                        <h4 class="payment-type-title">üè¶ Tipo de Pago</h4>
                        <div class="payment-type-grid">
                            <div class="payment-type-option selected" onclick="selectPaymentType('efectivo')">
                                <div class="payment-type-icon">üíµ</div>
                                <div class="payment-type-label">Efectivo</div>
                            </div>
                            <div class="payment-type-option" onclick="selectPaymentType('tarjeta')">
                                <div class="payment-type-icon">üí≥</div>
                                <div class="payment-type-label">Tarjeta</div>
                            </div>
                            <div class="payment-type-option" onclick="selectPaymentType('transferencia')">
                                <div class="payment-type-icon">üè¶</div>
                                <div class="payment-type-label">Transferencia</div>
                            </div>
                            <div class="payment-type-option" onclick="selectPaymentType('cheque')">
                                <div class="payment-type-icon">üìù</div>
                                <div class="payment-type-label">Cheque</div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n de Abono Inicial (solo visible en cr√©dito) -->
                    <div class="initial-payment-section" id="initial-payment-section">
                        <label for="initial-payment" class="initial-payment-label">
                            üí∞ Abono Inicial (Opcional)
                        </label>
                        <input type="number" 
                               id="initial-payment" 
                               class="initial-payment-input"
                               step="0.01" 
                               min="0" 
                               placeholder="0.00"
                               onchange="updatePaymentSummary()">
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #160d67;">
                            üí° El cliente puede abonar cualquier cantidad
                        </div>
                    </div>

                    <!-- Resumen de Pago -->
                    <div class="payment-summary" id="payment-summary">
                        <div class="summary-row">
                            <span>Total del pedido:</span>
                            <span id="summary-total">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Abono inicial:</span>
                            <span id="summary-initial">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Saldo pendiente:</span>
                            <span id="summary-balance">$0.00</span>
                        </div>
                        <div class="summary-row payment-type-summary">
                            <span>Tipo de pago:</span>
                            <span id="summary-payment-type">Efectivo</span>
                        </div>
                    </div>
                </div>

                <!-- NUEVA SECCI√ìN: Informaci√≥n de Ubicaci√≥n -->
                <div class="location-section">
                    <h3 class="section-title">üìç Ubicaci√≥n de la Venta</h3>
                    <div style="padding: 1.5rem;">
                        <div class="location-controls">
                            <button type="button" id="get-location-btn" class="btn-location-detailed" onclick="getDetailedLocation()">
                                üì± Obtener Mi Ubicaci√≥n
                            </button>
                            <button type="button" id="manual-location-btn" class="btn-location-manual" onclick="toggleManualLocation()">
                                ‚úèÔ∏è Ubicaci√≥n Manual
                            </button>
                        </div>
                        
                        <div id="location-status" class="location-status">
                            <div class="location-icon">üìç</div>
                            <div class="location-text">
                                <div class="location-title">Sin ubicaci√≥n</div>
                                <div class="location-subtitle">Obt√©n tu ubicaci√≥n actual o ingr√©sala manualmente</div>
                            </div>
                        </div>

                        <!-- Manual location input -->
                        <div id="manual-location-input" class="manual-location-input" style="display: none;">
                            <div class="form-group">
                                <label for="manual-address">Direcci√≥n:</label>
                                <input type="text" id="manual-address" placeholder="Escribe la direcci√≥n donde realizas la venta">
                            </div>
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="manual-lat">Latitud (opcional):</label>
                                    <input type="number" id="manual-lat" step="any" placeholder="ej: 20.1234">
                                </div>
                                <div class="form-group">
                                    <label for="manual-lng">Longitud (opcional):</label>
                                    <input type="number" id="manual-lng" step="any" placeholder="ej: -103.1234">
                                </div>
                            </div>
                            <button type="button" onclick="saveManualLocation()" class="btn btn-secondary">
                                üíæ Guardar Ubicaci√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Foto y Notas -->
                <div class="form-section">
                    <h3 class="section-title">Informaci√≥n Adicional</h3>
                    <div style="padding: 1.5rem;">
                        <div class="form-group">
                            <label for="order-photo">Foto del Pedido (Opcional):</label>
                            <input type="file" id="order-photo" accept="image/*" capture="camera">
                            <div id="photo-preview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="order-notes">Observaciones:</label>
                            <textarea id="order-notes" rows="4" 
                                      placeholder="Instrucciones especiales, observaciones, etc."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="clear-order-btn">Limpiar Pedido</button>
                    <button type="button" class="btn btn-primary" id="submit-order-btn">‚ú® Crear Pedido</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    
    <script>
        console.log('üöÄ Iniciando p√°gina de pedidos con tipos de pago y ubicaci√≥n mejorados');

        // Variables globales
        let substoreProducts = [];
        let orderProducts = [];
        let currentLocation = null;
        let isProcessing = false;
        let currentPaymentMethod = 'cash';
        let currentPaymentType = 'efectivo'; // NUEVA VARIABLE
        let substoreInfo = null;
        let customPrices = {};

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã Inicializando p√°gina de pedidos...');
            
            const user = checkAuth();
            if (!user) return;
            
            if (user.role !== 'employee') {
                alert('Esta p√°gina es solo para vendedores.');
                window.location.href = '/';
                return;
            }
            
            const userNameElement = document.getElementById('user-name');
            if (userNameElement) userNameElement.textContent = user.name;
            
            setupEventListeners();
            setupMobile();
            loadSubstoreStatus();
        });

        // Configurar event listeners
        function setupEventListeners() {
            console.log('üéØ Configurando event listeners...');
            
            const submitBtn = document.getElementById('submit-order-btn');
            if (submitBtn) submitBtn.addEventListener('click', handleCreateOrder);
            
            const clearBtn = document.getElementById('clear-order-btn');
            if (clearBtn) clearBtn.addEventListener('click', handleClearOrder);
            
            const searchInput = document.getElementById('product-search');
            if (searchInput) searchInput.addEventListener('input', handleSearch);
            
            const photoInput = document.getElementById('order-photo');
            if (photoInput) photoInput.addEventListener('change', handlePhotoChange);
            
            console.log('‚úÖ Event listeners configurados');
        }

        // ===== NUEVA FUNCI√ìN: Seleccionar tipo de pago =====
        function selectPaymentType(type) {
            console.log('üè¶ Seleccionando tipo de pago:', type);
            
            currentPaymentType = type;
            
            // Actualizar interfaz visual
            document.querySelectorAll('.payment-type-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Marcar la opci√≥n seleccionada
            document.querySelectorAll('.payment-type-option').forEach(option => {
                if (option.querySelector('.payment-type-label').textContent === getPaymentTypeLabel(type)) {
                    option.classList.add('selected');
                }
            });
            
            // Actualizar resumen
            updatePaymentSummary();
            
            console.log('‚úÖ Tipo de pago actualizado a:', currentPaymentType);
        }

        function getPaymentTypeLabel(type) {
            const labels = {
                'efectivo': 'Efectivo',
                'tarjeta': 'Tarjeta',
                'transferencia': 'Transferencia',
                'cheque': 'Cheque'
            };
            return labels[type] || 'Efectivo';
        }

        // Funci√≥n existente mejorada
        function selectPaymentMethod(method) {
            console.log('üí≥ Seleccionando m√©todo de pago:', method);
            
            currentPaymentMethod = method;
            
            // Actualizar interfaz visual
            document.querySelectorAll('.payment-method-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector(`#payment-${method}`).closest('.payment-method-option');
            selectedOption.classList.add('selected');
            
            document.getElementById(`payment-${method}`).checked = true;
            
            // Mostrar/ocultar secci√≥n de abono inicial
            const initialPaymentSection = document.getElementById('initial-payment-section');
            const paymentSummary = document.getElementById('payment-summary');
            
            if (method === 'credit') {
                initialPaymentSection.classList.add('show');
                paymentSummary.classList.add('show');
            } else {
                initialPaymentSection.classList.remove('show');
                paymentSummary.classList.remove('show');
                document.getElementById('initial-payment').value = '';
            }
            
            updateProductPrices();
            updatePaymentSummary();
            
            console.log('‚úÖ M√©todo de pago actualizado a:', currentPaymentMethod);
        }

        // ===== NUEVAS FUNCIONES DE UBICACI√ìN =====
        async function getDetailedLocation() {
            const btn = document.getElementById('get-location-btn');
            const status = document.getElementById('location-status');
            
            if (!btn || !status) return;
            
            try {
                btn.disabled = true;
                btn.textContent = 'üì° Obteniendo ubicaci√≥n...';
                
                // Actualizar estado de carga
                status.innerHTML = `
                    <div class="location-icon">‚è≥</div>
                    <div class="location-text">
                        <div class="location-title">Obteniendo ubicaci√≥n...</div>
                        <div class="location-subtitle">Por favor espera mientras obtenemos tu ubicaci√≥n actual</div>
                    </div>
                `;
                
                // Obtener ubicaci√≥n
                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;
                
                console.log('üìç Ubicaci√≥n obtenida:', { latitude, longitude });
                
                // Intentar obtener direcci√≥n (reverse geocoding)
                let address = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
                
                try {
                    // Aqu√≠ podr√≠as usar una API de geocoding reverso como Google Maps o OpenStreetMap
                    // Por ahora, usaremos las coordenadas
                    address = await reverseGeocode(latitude, longitude);
                } catch (geoError) {
                    console.warn('No se pudo obtener la direcci√≥n:', geoError);
                }
                
                // Guardar ubicaci√≥n
                currentLocation = {
                    latitude,
                    longitude,
                    address,
                    accuracy: position.coords.accuracy,
                    timestamp: new Date().toISOString(),
                    method: 'gps'
                };
                
                // Actualizar estado exitoso
                status.innerHTML = `
                    <div class="location-icon">‚úÖ</div>
                    <div class="location-text">
                        <div class="location-title">Ubicaci√≥n obtenida</div>
                        <div class="location-subtitle">${address}</div>
                        <div class="location-coords">Precisi√≥n: ¬±${Math.round(position.coords.accuracy)}m</div>
                    </div>
                `;
                
                btn.textContent = '‚úÖ Ubicaci√≥n Obtenida';
                btn.style.backgroundColor = '#059669';
                
                if (window.showNotification) {
                    window.showNotification('Ubicaci√≥n obtenida exitosamente', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Error obteniendo ubicaci√≥n:', error);
                
                status.innerHTML = `
                    <div class="location-icon">‚ùå</div>
                    <div class="location-text">
                        <div class="location-title">Error en ubicaci√≥n</div>
                        <div class="location-subtitle">${error.message}</div>
                    </div>
                `;
                
                btn.textContent = 'üìç Reintentar Ubicaci√≥n';
                btn.style.backgroundColor = '#dc2626';
                
                if (window.showNotification) {
                    window.showNotification('Error al obtener ubicaci√≥n: ' + error.message, 'error');
                }
                
            } finally {
                btn.disabled = false;
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('La geolocalizaci√≥n no est√° soportada en este navegador'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    resolve,
                    (error) => {
                        let message = 'Error desconocido';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message = 'Permiso de ubicaci√≥n denegado';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = 'Ubicaci√≥n no disponible';
                                break;
                            case error.TIMEOUT:
                                message = 'Tiempo de espera agotado';
                                break;
                        }
                        reject(new Error(message));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutos
                    }
                );
            });
        }

        async function reverseGeocode(lat, lng) {
            try {
                // Usando OpenStreetMap Nominatim (gratuito)
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
                
                if (!response.ok) throw new Error('Error en geocoding');
                
                const data = await response.json();
                
                if (data && data.display_name) {
                    return data.display_name;
                }
                
                throw new Error('No se encontr√≥ direcci√≥n');
                
            } catch (error) {
                console.warn('Reverse geocoding fall√≥:', error);
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        function toggleManualLocation() {
            const manualInput = document.getElementById('manual-location-input');
            const btn = document.getElementById('manual-location-btn');
            
            if (manualInput.style.display === 'none') {
                manualInput.style.display = 'block';
                btn.textContent = '‚ùå Cancelar Manual';
                btn.style.backgroundColor = '#dc2626';
            } else {
                manualInput.style.display = 'none';
                btn.textContent = '‚úèÔ∏è Ubicaci√≥n Manual';
                btn.style.backgroundColor = '';
            }
        }

        function saveManualLocation() {
            const address = document.getElementById('manual-address').value.trim();
            const lat = parseFloat(document.getElementById('manual-lat').value);
            const lng = parseFloat(document.getElementById('manual-lng').value);
            
            if (!address) {
                if (window.showNotification) {
                    window.showNotification('Ingresa una direcci√≥n', 'warning');
                }
                return;
            }
            
            currentLocation = {
                latitude: lat || null,
                longitude: lng || null,
                address,
                accuracy: null,
                timestamp: new Date().toISOString(),
                method: 'manual'
            };
            
            const status = document.getElementById('location-status');
            status.innerHTML = `
                <div class="location-icon">‚úèÔ∏è</div>
                <div class="location-text">
                    <div class="location-title">Ubicaci√≥n manual</div>
                    <div class="location-subtitle">${address}</div>
                    ${(lat && lng) ? `<div class="location-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</div>` : ''}
                </div>
            `;
            
            toggleManualLocation();
            
            if (window.showNotification) {
                window.showNotification('Ubicaci√≥n manual guardada', 'success');
            }
        }

        // Funci√≥n mejorada para actualizar resumen de pago
        function updatePaymentSummary() {
            const total = orderProducts.reduce((sum, p) => sum + p.line_total, 0);
            const initialPayment = parseFloat(document.getElementById('initial-payment')?.value) || 0;
            const balance = Math.max(0, total - initialPayment);
            
            // Actualizar elementos del resumen
            document.getElementById('summary-total').textContent = formatCurrency(total);
            document.getElementById('summary-initial').textContent = formatCurrency(initialPayment);
            document.getElementById('summary-balance').textContent = formatCurrency(balance);
            document.getElementById('summary-payment-type').textContent = getPaymentTypeLabel(currentPaymentType);
            
            // Validar que el abono no exceda el total
            if (initialPayment > total && total > 0) {
                document.getElementById('initial-payment').style.borderColor = '#dc2626';
                document.getElementById('summary-initial').style.color = '#dc2626';
            } else {
                document.getElementById('initial-payment').style.borderColor = '#f59e0b';
                document.getElementById('summary-initial').style.color = 'inherit';
            }
        }

        // Resto de funciones existentes (loadSubstoreStatus, displaySubstoreStatus, etc.)
        async function loadSubstoreStatus() {
            console.log('üîç Cargando estado del subalmac√©n...');
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/employee/substore-status`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Estado del subalmac√©n:', data);
                
                displaySubstoreStatus(data);
                
                if (data.has_active_trip) {
                    substoreInfo = data.trip_info;
                    await loadSubstoreProducts();
                    showOrderForm();
                } else {
                    hideOrderForm();
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando estado del subalmac√©n:', error);
                displaySubstoreError(error.message);
            }
        }

        function displaySubstoreStatus(data) {
            const container = document.getElementById('substore-status-container');
            
            if (data.has_active_trip) {
                container.innerHTML = `
                    <div class="substore-status">
                        <div class="substore-header">
                            <h3 class="substore-title">üöõ Subalmac√©n Activo</h3>
                            <div class="trip-number">${data.trip_info.trip_number}</div>
                        </div>
                        <p>Tienes productos disponibles para venta desde tu subalmac√©n m√≥vil.</p>
                        
                        <div class="substore-stats">
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.available_products}</span>
                                <span class="stat-label">Productos Disponibles</span>
                            </div>
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.total_products}</span>
                                <span class="stat-label">Total Productos</span>
                            </div>
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.out_of_stock}</span>
                                <span class="stat-label">Sin Stock</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="substore-status no-trip">
                        <div class="substore-header">
                            <h3 class="substore-title">‚ö†Ô∏è Sin Subalmac√©n Activo</h3>
                        </div>
                        <p>No tienes un subalmac√©n activo asignado. Contacta al administrador para que te asigne productos.</p>
                    </div>
                `;
            }
        }

        // Funci√≥n mejorada para crear pedido
        async function handleCreateOrder() {
            if (isProcessing) return;
            
            console.log('üì§ Iniciando creaci√≥n de pedido con precios personalizados:', {
                paymentMethod: currentPaymentMethod,
                paymentType: currentPaymentType,
                location: currentLocation,
                customPrices: Object.keys(customPrices).length
            });
            
            // Validaciones existentes
            if (!orderProducts || orderProducts.length === 0) {
                if (window.showNotification) {
                    window.showNotification('Agrega al menos un producto del subalmac√©n', 'warning');
                }
                return;
            }
            
            const clientName = document.getElementById('client-name')?.value?.trim();
            if (!clientName) {
                if (window.showNotification) {
                    window.showNotification('El nombre del cliente es requerido', 'warning');
                }
                document.getElementById('client-name')?.focus();
                return;
            }
            
            // Validar ubicaci√≥n (opcional pero recomendada)
            if (!currentLocation) {
                const confirmWithoutLocation = confirm('‚ö†Ô∏è No hay ubicaci√≥n registrada.\n\n¬øContinuar sin ubicaci√≥n?\n\nRecomendamos obtener la ubicaci√≥n para mejorar el servicio.');
                if (!confirmWithoutLocation) {
                    return;
                }
            }
            
            if (!substoreInfo) {
                if (window.showNotification) {
                    window.showNotification('Error: No hay informaci√≥n del subalmac√©n', 'error');
                }
                return;
            }
            
            // Obtener informaci√≥n de pago
            const total = orderProducts.reduce((sum, p) => sum + p.line_total, 0);
            let initialPayment = 0;
            
            if (currentPaymentMethod === 'credit') {
                initialPayment = parseFloat(document.getElementById('initial-payment')?.value) || 0;
                
                if (initialPayment > total) {
                    if (window.showNotification) {
                        window.showNotification('El abono inicial no puede ser mayor al total', 'warning');
                    }
                    return;
                }
            } else {
                initialPayment = total;
            }
            
            // Verificar si hay precios personalizados y generar resumen
            let customPricingSummary = null;
            if (Object.keys(customPrices).length > 0) {
                customPricingSummary = {
                    products_with_custom_price: Object.keys(customPrices).length,
                    total_savings: 0,
                    custom_price_details: []
                };
                
                orderProducts.forEach(product => {
                    if (product.custom_price_info) {
                        customPricingSummary.total_savings += product.custom_price_info.discount_amount * product.quantity;
                        customPricingSummary.custom_price_details.push({
                            product_code: product.code,
                            product_name: product.name,
                            quantity: product.quantity,
                            original_price: product.custom_price_info.original_price,
                            custom_price: product.custom_price_info.custom_price,
                            total_savings: product.custom_price_info.discount_amount * product.quantity,
                            reason: product.custom_price_info.reason
                        });
                    }
                });
            }
            
            isProcessing = true;
            const submitBtn = document.getElementById('submit-order-btn');
            
            try {
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = '‚ö° Procesando Venta...';
                }
                
                // Preparar datos con informaci√≥n mejorada
                const formData = {
                    client_info: {
                        name: clientName,
                        phone: document.getElementById('client-phone')?.value?.trim() || '',
                        address: document.getElementById('client-address')?.value?.trim() || '',
                        email: document.getElementById('client-email')?.value?.trim() || ''
                    },
                    products: orderProducts,
                    payment_method: currentPaymentMethod,
                    payment_type: currentPaymentType,
                    inventory_source: 'substore',
                    trip_id: substoreInfo.id,
                    location: currentLocation,
                    notes: document.getElementById('order-notes')?.value?.trim() || '',
                    total: total,
                    
                    // Informaci√≥n de pagos
                    paid_amount: initialPayment,
                    balance: total - initialPayment,
                    is_fully_paid: initialPayment >= total,
                    payment_status: initialPayment >= total ? 'paid' : (initialPayment > 0 ? 'partial' : 'pending'),
                    
                    // NUEVA: Informaci√≥n de precios personalizados
                    custom_pricing_summary: customPricingSummary
                };
                
                // Manejar foto
                const photoFile = document.getElementById('order-photo')?.files[0];
                if (photoFile) {
                    try {
                        const photoBase64 = await convertToBase64(photoFile);
                        formData.photo_url = photoBase64;
                    } catch (error) {
                        console.error('Error con la foto:', error);
                    }
                }
                
                console.log('üì§ Enviando pedido con precios personalizados:', formData);
                
                // Enviar pedido
                const response = await fetch(`${window.API_BASE_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    console.log('üéâ Pedido procesado exitosamente:', result);
                    
                    const methodText = currentPaymentMethod === 'cash' ? 'Contado' : 'Cr√©dito';
                    const orderNumber = result.order?.order_number || 'Gener√°ndose...';
                    const saleNumber = result.sale?.sale_number || 'Gener√°ndose...';
                    const tripNumber = substoreInfo.trip_number;
                    
                    // Informaci√≥n de pago detallada
                    let paymentInfo = `\nüí≥ Modalidad: ${methodText}`;
                    paymentInfo += `\nüè¶ Tipo: ${getPaymentTypeLabel(currentPaymentType)}`;
                    
                    if (currentPaymentMethod === 'credit') {
                        const balance = total - initialPayment;
                        if (initialPayment > 0) {
                            paymentInfo += `\nüí∞ Abono inicial: ${formatCurrency(initialPayment)}`;
                        }
                        if (balance > 0) {
                            paymentInfo += `\nüìã Saldo pendiente: ${formatCurrency(balance)}`;
                        } else {
                            paymentInfo += `\n‚úÖ Pedido TOTALMENTE PAGADO`;
                        }
                    } else {
                        paymentInfo += '\nüíµ PAGO COMPLETO AL CONTADO';
                    }
                    
                    // Informaci√≥n de precios personalizados
                    let customPriceInfo = '';
                    if (customPricingSummary && customPricingSummary.products_with_custom_price > 0) {
                        customPriceInfo = `\n\nüí∞ PRECIOS PERSONALIZADOS:`;
                        customPriceInfo += `\n‚Ä¢ ${customPricingSummary.products_with_custom_price} producto(s) con precio especial`;
                        if (customPricingSummary.total_savings > 0) {
                            customPriceInfo += `\n‚Ä¢ Ahorro total: ${formatCurrency(customPricingSummary.total_savings)}`;
                        }
                        
                        customPricingSummary.custom_price_details.forEach(detail => {
                            if (detail.total_savings > 0) {
                                customPriceInfo += `\n  - ${detail.product_code}: Ahorro ${formatCurrency(detail.total_savings)}`;
                                if (detail.reason) {
                                    customPriceInfo += ` (${detail.reason})`;
                                }
                            }
                        });
                    }
                    
                    // Informaci√≥n de ubicaci√≥n
                    let locationInfo = '';
                    if (currentLocation) {
                        locationInfo = `\nüìç Ubicaci√≥n: ${currentLocation.address}`;
                        if (currentLocation.method === 'gps' && currentLocation.accuracy) {
                            locationInfo += ` (¬±${Math.round(currentLocation.accuracy)}m)`;
                        }
                    }
                    
                    const confirmationMessage = `üéâ ¬°VENTA COMPLETADA EXITOSAMENTE!

        üìã Pedido: ${orderNumber}
        üí∞ Venta: ${saleNumber}
        üë§ Cliente: ${formData.client_info.name}
        üì¶ Productos: ${orderProducts.length}
        üíµ Total: ${formatCurrency(formData.total)}${paymentInfo}${customPriceInfo}${locationInfo}
        üöõ Subalmac√©n: ${tripNumber}

        ‚úÖ La venta ha sido procesada autom√°ticamente
        üì¶ El inventario de tu subalmac√©n ha sido actualizado
        üìä El registro de venta ha sido creado

        ¬°Felicidades por tu venta! üéä`;
                    
                    alert(confirmationMessage);
                    
                    if (window.showNotification) {
                        window.showNotification(`¬°Venta ${methodText.toLowerCase()} completada! üéâ`, 'success');
                    }
                    
                    // Limpiar formulario (esto tambi√©n limpia customPrices)
                    clearOrderForm();
                    
                    // Recargar productos del subalmac√©n
                    await loadSubstoreProducts();
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error en el servidor');
                }
                
            } catch (error) {
                console.error('‚ùå Error procesando pedido:', error);
                
                if (window.showNotification) {
                    window.showNotification('Error: ' + error.message, 'error');
                }
                
                alert(`‚ùå Error al procesar la venta:

        ${error.message}

        Verifica la informaci√≥n e intenta nuevamente.`);
                
            } finally {
                isProcessing = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚ú® Crear Pedido';
                }
            }
        }
        // Resto de funciones auxiliares
        async function loadSubstoreProducts() {
            console.log('üì¶ Cargando productos del subalmac√©n...');
            
            const container = document.getElementById('products-list');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Cargando productos del subalmac√©n...</div>';
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/substore/products`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || !data.products) {
                    substoreProducts = [];
                } else {
                    substoreProducts = data.products;
                }
                
                displaySubstoreProducts(substoreProducts);
                
            } catch (error) {
                console.error('‚ùå Error cargando productos del subalmac√©n:', error);
                
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc2626;">
                            <p>‚ùå Error: ${error.message}</p>
                            <button onclick="loadSubstoreProducts()" class="btn btn-primary" style="margin-top: 1rem;">
                                üîÑ Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        function displaySubstoreProducts(productsToShow) {
            const container = document.getElementById('products-list');
            if (!container) return;
            
            if (productsToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        <p>üì¶ No hay productos disponibles en tu subalmac√©n</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = productsToShow.map(product => {
                const stockClass = product.stock > 10 ? 'stock-high' : product.stock > 3 ? 'stock-medium' : 'stock-low';
                const stockText = `${product.stock} disponibles`;
                const isOutOfStock = product.stock === 0;
                
                const prices = getProductPrices(product, currentPaymentMethod);
                
                const paymentBadge = currentPaymentMethod === 'credit' 
                    ? '<span style="background: #fbbf24; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üìã CR√âDITO</span>'
                    : '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üíµ CONTADO</span>';
                
                return `
                    <div class="product-card substore-product-card">
                        <div class="substore-badge">SUBALMAC√âN</div>
                        ${paymentBadge}
                        
                        <div class="product-header">
                            <div class="product-code">${product.code || 'N/A'}</div>
                            <div class="product-price">${formatCurrency(prices.box)}</div>
                        </div>
                        <div class="product-name">${product.name || 'Producto sin nombre'}</div>
                        <div class="product-details">${product.brand || 'N/A'} ‚Ä¢ ${product.viscosity || 'N/A'} ‚Ä¢ ${product.capacity || 'N/A'}</div>
                        <div class="stock-info ${stockClass}">üì¶ ${stockText}</div>
                        
                        <div class="product-actions">
                            <input type="number" class="quantity-input" data-product-id="${product.id}" 
                                   min="1" max="${product.stock || 1}" value="1" ${isOutOfStock ? 'disabled' : ''}>
                            <button class="btn btn-primary" onclick="addToOrder(${product.id})" 
                                    ${isOutOfStock ? 'disabled' : ''}>
                                ${isOutOfStock ? 'Sin Stock' : 'Agregar'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getProductPrices(product, paymentMethod) {
            if (!product) return { unit: 0, box: 0 };
            
            const basePrice = product.substore_info?.substore_price || product.price || 0;
            
            if (product.prices && typeof product.prices === 'object') {
                const priceKey = paymentMethod === 'cash' ? 'cash' : 'credit';
                return {
                    unit: product.prices[`${priceKey}_unit`] || 0,
                    box: product.prices[`${priceKey}_box`] || basePrice
                };
            } else {
                const unitPrice = basePrice / 24;
                
                if (paymentMethod === 'credit') {
                    return {
                        unit: unitPrice * 1.06,
                        box: basePrice * 1.06
                    };
                }
                
                return {
                    unit: unitPrice,
                    box: basePrice
                };
            }
        }

        function updateProductPrices() {
            if (substoreProducts && substoreProducts.length > 0) {
                displaySubstoreProducts(substoreProducts);
            }
            
            if (orderProducts && orderProducts.length > 0) {
                orderProducts.forEach(orderProduct => {
                    const product = substoreProducts.find(p => p.id === orderProduct.product_id);
                    if (product) {
                        const prices = getProductPrices(product, currentPaymentMethod);
                        orderProduct.unit_price = prices.box;
                        orderProduct.line_total = prices.box * orderProduct.quantity;
                        orderProduct.payment_method = currentPaymentMethod;
                    }
                });
                
                updateOrderTable();
            }
        }

        function addToOrder(productId) {
            const product = substoreProducts.find(p => p.id === productId);
            if (!product) return;
            
            const quantityInput = document.querySelector(`input[data-product-id="${productId}"]`);
            const quantity = parseInt(quantityInput?.value) || 1;
            
            if (quantity <= 0 || quantity > product.stock) {
                if (window.showNotification) {
                    window.showNotification(`Stock insuficiente. Disponible: ${product.stock}`, 'warning');
                }
                return;
            }
            
            // Usar precio personalizado si existe, sino usar precio normal
            let unitPrice;
            if (customPrices[productId]) {
                unitPrice = customPrices[productId].price;
            } else {
                const prices = getProductPrices(product, currentPaymentMethod);
                unitPrice = prices.box;
            }
            
            const existingIndex = orderProducts.findIndex(p => 
                p.product_id === productId && p.payment_method === currentPaymentMethod
            );
            
            if (existingIndex >= 0) {
                const newQuantity = orderProducts[existingIndex].quantity + quantity;
                if (newQuantity > product.stock) {
                    if (window.showNotification) {
                        window.showNotification(`Cantidad m√°xima: ${product.stock}`, 'warning');
                    }
                    return;
                }
                orderProducts[existingIndex].quantity = newQuantity;
                orderProducts[existingIndex].line_total = unitPrice * newQuantity;
            } else {
                const orderProduct = {
                    product_id: productId,
                    name: product.name,
                    code: product.code,
                    unit_price: unitPrice,
                    quantity: quantity,
                    line_total: unitPrice * quantity,
                    payment_method: currentPaymentMethod,
                    unit_type: 'box',
                    substore_info: product.substore_info
                };
                
                // Agregar informaci√≥n de precio personalizado si existe
                if (customPrices[productId]) {
                    orderProduct.custom_price_info = {
                        original_price: customPrices[productId].originalPrice,
                        custom_price: customPrices[productId].price,
                        reason: customPrices[productId].reason,
                        discount_amount: customPrices[productId].originalPrice - customPrices[productId].price,
                        discount_percentage: ((customPrices[productId].originalPrice - customPrices[productId].price) / customPrices[productId].originalPrice * 100).toFixed(2)
                    };
                }
                
                orderProducts.push(orderProduct);
            }
            
            updateOrderTable();
            
            if (quantityInput) quantityInput.value = 1;
            
            const productName = customPrices[productId] ? 
                `${product.name} (precio especial)` : product.name;
            
            if (window.showNotification) {
                window.showNotification(`${productName} agregado`, 'success');
            }
        }

        function updateOrderTable() {
            const tbody = document.querySelector('#order-products-table tbody');
            const productsCount = document.getElementById('products-count');
            
            if (!tbody) return;
            
            if (orderProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #64748b;">
                            üìù No hay productos en el pedido
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = orderProducts.map((product, index) => {
                    const methodBadge = product.payment_method === 'credit' 
                        ? '<small style="background: #fbbf24; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">CR√âDITO</small>'
                        : '<small style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">CONTADO</small>';
                    
                    const customPriceBadge = product.custom_price_info ? 
                        `<small style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;" title="${product.custom_price_info.reason}">
                            ${product.custom_price_info.discount_amount > 0 ? 'üí∞ DESCUENTO' : '‚≠ê ESPECIAL'}
                        </small>` : '';
                    
                    const priceInfo = product.custom_price_info ? 
                        `<small style="color: #059669; display: block; margin-top: 0.25rem;">
                            Precio original: ${formatCurrency(product.custom_price_info.original_price)} 
                            ${product.custom_price_info.discount_amount > 0 ? `(Ahorro: ${formatCurrency(product.custom_price_info.discount_amount)})` : ''}
                        </small>` : '';
                    
                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${product.code} - ${product.name}</div>
                                <small style="color: #059669;">üöõ Desde subalmac√©n</small>
                                ${methodBadge}
                                ${customPriceBadge}
                                ${priceInfo}
                            </td>
                            <td>${formatCurrency(product.unit_price)}</td>
                            <td>${product.quantity}</td>
                            <td>${formatCurrency(product.line_total)}</td>
                            <td>
                                <button class="remove-product" onclick="removeFromOrder(${index})" title="Remover producto">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            if (productsCount) {
                productsCount.textContent = orderProducts.length;
            }
            
            updateSummary();
            updatePaymentSummary();
        }

        function updateSummary() {
            const total = orderProducts.reduce((sum, p) => sum + p.line_total, 0);
            const totalItems = orderProducts.reduce((sum, p) => sum + p.quantity, 0);
            
            const totalElement = document.getElementById('order-total');
            const countElement = document.getElementById('cart-items-count');
            
            if (totalElement) {
                totalElement.textContent = formatCurrency(total);
            }
            
            if (countElement) {
                const methodText = currentPaymentMethod === 'cash' ? 'contado' : 'cr√©dito';
                countElement.textContent = `${totalItems} productos (${methodText})`;
            }
        }

        function clearOrderForm() {
            orderProducts = [];
            customPrices = {}; // Limpiar precios personalizados
            updateOrderTable();
            
            const fields = ['client-name', 'client-phone', 'client-address', 'client-email', 'order-notes'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });
            
            const photoInput = document.getElementById('order-photo');
            const photoPreview = document.getElementById('photo-preview');
            if (photoInput) photoInput.value = '';
            if (photoPreview) photoPreview.innerHTML = '';
            
            selectPaymentMethod('cash');
            selectPaymentType('efectivo');
            document.getElementById('initial-payment').value = '';
            
            // Limpiar ubicaci√≥n
            currentLocation = null;
            const locationStatus = document.getElementById('location-status');
            if (locationStatus) {
                locationStatus.innerHTML = `
                    <div class="location-icon">üìç</div>
                    <div class="location-text">
                        <div class="location-title">Sin ubicaci√≥n</div>
                        <div class="location-subtitle">Obt√©n tu ubicaci√≥n actual o ingr√©sala manualmente</div>
                    </div>
                `;
            }
            
            const locationBtn = document.getElementById('get-location-btn');
            if (locationBtn) {
                locationBtn.textContent = 'üì± Obtener Mi Ubicaci√≥n';
                locationBtn.style.backgroundColor = '';
                locationBtn.disabled = false;
            }
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.value = 1;
            });
            
            // Actualizar vista de productos para remover indicadores de precio personalizado
            if (substoreProducts && substoreProducts.length > 0) {
                displaySubstoreProducts(substoreProducts);
            }
        }

        function handleClearOrder() {
            if (orderProducts.length === 0) {
                if (window.showNotification) {
                    window.showNotification('No hay productos en el pedido', 'info');
                }
                return;
            }
            
            if (confirm('¬øLimpiar todo el pedido?')) {
                clearOrderForm();
                if (window.showNotification) {
                    window.showNotification('Pedido limpiado', 'success');
                }
            }
        }

        function removeFromOrder(index) {
            const product = orderProducts[index];
            if (!product) return;
            
            if (confirm(`¬øRemover ${product.name}?`)) {
                orderProducts.splice(index, 1);
                updateOrderTable();
                if (window.showNotification) {
                    window.showNotification('Producto removido', 'info');
                }
            }
        }

        function displaySubstoreError(errorMessage) {
            const container = document.getElementById('substore-status-container');
            container.innerHTML = `
                <div class="substore-status no-trip">
                    <div class="substore-header">
                        <h3 class="substore-title">‚ùå Error de Conexi√≥n</h3>
                    </div>
                    <p>No se pudo verificar el estado de tu subalmac√©n: ${errorMessage}</p>
                    <button onclick="loadSubstoreStatus()" class="btn btn-primary" style="margin-top: 1rem;">
                        üîÑ Reintentar
                    </button>
                </div>
            `;
        }

        function showOrderForm() {
            document.getElementById('order-form-container').style.display = 'block';
        }

        function hideOrderForm() {
            document.getElementById('order-form-container').style.display = 'none';
        }

        function refreshSubstoreStatus() {
            loadSubstoreStatus();
        }

        let searchTimeout;
        function handleSearch(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const term = e.target.value.toLowerCase().trim();
                let filtered = substoreProducts;
                
                if (term) {
                    filtered = substoreProducts.filter(p => 
                        p.name.toLowerCase().includes(term) ||
                        p.code.toLowerCase().includes(term) ||
                        p.brand.toLowerCase().includes(term) ||
                        p.viscosity.toLowerCase().includes(term)
                    );
                }
                
                displaySubstoreProducts(filtered);
            }, 300);
        }

        function handlePhotoChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                if (window.showNotification) {
                    window.showNotification('Archivo muy grande (m√°x 5MB)', 'warning');
                }
                e.target.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                if (window.showNotification) {
                    window.showNotification('Solo im√°genes permitidas', 'warning');
                }
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-preview').innerHTML = `
                    <div style="position: relative; display: inline-block; margin-top: 1rem;">
                        <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                        <button onclick="removePhoto()" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">√ó</button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            const photoInput = document.getElementById('order-photo');
            const photoPreview = document.getElementById('photo-preview');
            if (photoInput) photoInput.value = '';
            if (photoPreview) photoPreview.innerHTML = '';
        }

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function setupMobile() {
            if (!document.querySelector('.mobile-menu-btn')) {
                const mobileBtn = document.createElement('button');
                mobileBtn.className = 'mobile-menu-btn';
                mobileBtn.innerHTML = '‚ò∞';
                mobileBtn.onclick = toggleMobileMenu;
                document.body.appendChild(mobileBtn);
            }
            
            adjustForMobile();
            window.addEventListener('resize', adjustForMobile);
            document.addEventListener('click', handleOutsideClick);
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth <= 768) {
                sidebar.classList.toggle('active');
            }
        }

        function adjustForMobile() {
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            if (mobileBtn) {
                mobileBtn.style.display = window.innerWidth <= 768 ? 'block' : 'none';
            }
        }

        function handleOutsideClick(e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const menuBtn = document.querySelector('.mobile-menu-btn');
                
                if (sidebar && menuBtn && !sidebar.contains(e.target) && !menuBtn.contains(e.target) && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            }
        }

        function formatCurrency(amount) {
            if (typeof window.formatCurrency === 'function' && window.formatCurrency !== formatCurrency) {
                return window.formatCurrency(amount);
            }
            
            if (typeof amount !== 'number') {
                amount = parseFloat(amount) || 0;
            }
            
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        // Funci√≥n para mostrar el bot√≥n de precio personalizado en los productos
        function displaySubstoreProducts(productsToShow) {
            const container = document.getElementById('products-list');
            if (!container) return;
            
            if (productsToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        <p>üì¶ No hay productos disponibles en tu subalmac√©n</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = productsToShow.map(product => {
                const stockClass = product.stock > 10 ? 'stock-high' : product.stock > 3 ? 'stock-medium' : 'stock-low';
                const stockText = `${product.stock} disponibles`;
                const isOutOfStock = product.stock === 0;
                
                // Verificar si tiene precio personalizado
                const hasCustomPrice = customPrices[product.id];
                const displayPrice = hasCustomPrice ? hasCustomPrice.price : getProductPrices(product, currentPaymentMethod).box;
                
                const paymentBadge = currentPaymentMethod === 'credit' 
                    ? '<span style="background: #fbbf24; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üìã CR√âDITO</span>'
                    : '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üíµ CONTADO</span>';
                
                const customPriceIndicator = hasCustomPrice 
                    ? `<span class="custom-price-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">
                        ${hasCustomPrice.price < hasCustomPrice.originalPrice ? 'üí∞ DESCUENTO' : '‚≠ê ESPECIAL'}
                    </span>`
                    : '';
                
                return `
                    <div class="product-card substore-product-card">
                        <div class="substore-badge">SUBALMAC√âN</div>
                        ${paymentBadge}
                        
                        <div class="product-header">
                            <div class="product-code">${product.code || 'N/A'}</div>
                            <div class="product-price">
                                ${formatCurrency(displayPrice)}
                                ${customPriceIndicator}
                            </div>
                        </div>
                        <div class="product-name">${product.name || 'Producto sin nombre'}</div>
                        <div class="product-details">${product.brand || 'N/A'} ‚Ä¢ ${product.viscosity || 'N/A'} ‚Ä¢ ${product.capacity || 'N/A'}</div>
                        <div class="stock-info ${stockClass}">üì¶ ${stockText}</div>
                        
                        <div class="product-actions">
                            <input type="number" style="width: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" class="quantity-input" data-product-id="${product.id}" 
                                min="1" max="${product.stock || 1}" value="1" ${isOutOfStock ? 'disabled' : ''}>
                            <button class="btn btn-primary" onclick="addToOrder(${product.id})" 
                                    ${isOutOfStock ? 'disabled' : ''}>
                                ${isOutOfStock ? 'Sin Stock' : 'Agregar'}
                            </button>
                            <button class="btn btn-primary" style="background-color: #33557a;" onclick="openPriceOverride(${product.id}, '${product.code}', '${product.name}', ${getProductPrices(product, currentPaymentMethod).box})"
                                    ${isOutOfStock ? 'disabled' : ''} title="Establecer precio personalizado">
                                Dif precio
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Funci√≥n para abrir el modal de precio personalizado
        function openPriceOverride(productId, productCode, productName, currentPrice) {
            window.currentProductId = productId;
            window.currentProductCode = productCode;
            window.currentProductName = productName;
            window.originalPrice = currentPrice;
            window.customPrice = currentPrice;

            // Crear modal si no existe
            if (!document.getElementById('priceOverrideModal')) {
                createPriceOverrideModal();
            }

            // Actualizar informaci√≥n en el modal
            document.getElementById('product-name-display').textContent = `${productName} (${productCode})`;
            document.getElementById('current-price-display').textContent = formatCurrency(currentPrice);
            document.getElementById('new-price-display').textContent = formatCurrency(currentPrice);
            
            // Si ya tiene precio personalizado, mostrarlo
            const existing = customPrices[productId];
            if (existing) {
                document.getElementById('custom-price-input').value = existing.price;
                document.getElementById('price-reason').value = existing.reason;
                window.customPrice = existing.price;
                document.getElementById('new-price-display').textContent = formatCurrency(existing.price);
            } else {
                document.getElementById('custom-price-input').value = currentPrice;
                document.getElementById('price-reason').value = '';
            }

            // Limpiar validaciones
            const validation = document.getElementById('price-validation');
            validation.className = 'price-validation';
            validation.textContent = '';

            // Mostrar modal
            document.getElementById('priceOverrideModal').classList.add('show');
            document.body.style.overflow = 'hidden';

            // Focus en el input de precio
            setTimeout(() => {
                document.getElementById('custom-price-input').focus();
                document.getElementById('custom-price-input').select();
            }, 100);
        }

        // Funci√≥n para crear el modal de precio personalizado
        function createPriceOverrideModal() {
            const modalHTML = `
                <div id="priceOverrideModal" class="price-override-modal">
                    <div class="price-override-content">
                        <div class="price-override-header">
                            <h3 class="price-override-title">üí∞ Precio Personalizado</h3>
                            <p class="price-override-subtitle" id="product-name-display">Producto</p>
                        </div>

                        <div class="price-info-card">
                            <div class="price-comparison">
                                <div class="price-item current-price">
                                    <div class="price-label">Precio Actual</div>
                                    <div class="price-value" id="current-price-display">$0.00</div>
                                </div>
                                <div class="price-item new-price">
                                    <div class="price-label">Precio Nuevo</div>
                                    <div class="price-value" id="new-price-display">$0.00</div>
                                </div>
                            </div>
                        </div>

                        <div class="price-presets">
                            <div class="presets-label">‚ö° Descuentos R√°pidos</div>
                            <div class="presets-grid">
                                <button class="preset-btn" onclick="applyDiscount(5)">-5%</button>
                                <button class="preset-btn" onclick="applyDiscount(10)">-10%</button>
                                <button class="preset-btn" onclick="applyDiscount(15)">-15%</button>
                                <button class="preset-btn" onclick="applyDiscount(20)">-20%</button>
                                <button class="preset-btn" onclick="applyDiscount(25)">-25%</button>
                                <button class="preset-btn" onclick="resetToOriginal()">Original</button>
                            </div>
                        </div>

                        <div class="price-input-group">
                            <label class="price-input-label" for="custom-price-input">üíµ Precio Personalizado</label>
                            <input 
                                type="number" 
                                id="custom-price-input" 
                                class="price-input" 
                                step="0.01" 
                                min="1" 
                                placeholder="Ingresa el precio..."
                                oninput="updateNewPrice()"
                            >
                            <div id="price-validation" class="price-validation"></div>
                        </div>

                        <div class="price-input-group">
                            <label class="price-input-label" for="price-reason">üìù Motivo del Precio Especial</label>
                            <textarea 
                                id="price-reason" 
                                class="reason-input" 
                                placeholder="Ej: Cliente mayorista, descuento por volumen, promoci√≥n especial..."
                            ></textarea>
                        </div>

                        <div class="price-override-actions">
                            <button class="btn-cancel-override" onclick="closePriceOverride()">
                                ‚ùå Cancelar
                            </button>
                            <button class="btn-apply-override" id="apply-btn" onclick="applyPriceOverride()">
                                ‚úÖ Aplicar Precio
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Agregar event listeners
            document.getElementById('priceOverrideModal').addEventListener('click', function(e) {
                if (e.target === this) closePriceOverride();
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('priceOverrideModal');
                    if (modal && modal.classList.contains('show')) {
                        closePriceOverride();
                    }
                }
            });

            document.getElementById('custom-price-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyPriceOverride();
                }
            });
        }

        // Funci√≥n para cerrar el modal
        function closePriceOverride() {
            const modal = document.getElementById('priceOverrideModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                
                // Limpiar presets activos
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
        }

        // Funci√≥n para aplicar descuentos predefinidos
        function applyDiscount(percentage) {
            const discountedPrice = window.originalPrice * (1 - percentage / 100);
            window.customPrice = Math.round(discountedPrice * 100) / 100;
            
            document.getElementById('custom-price-input').value = window.customPrice;
            updateNewPrice();

            // Marcar preset como activo
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Auto-llenar raz√≥n
            if (percentage > 0) {
                const reasonField = document.getElementById('price-reason');
                if (!reasonField.value.trim()) {
                    reasonField.value = `Descuento del ${percentage}% aplicado`;
                }
            }
        }

        // Funci√≥n para resetear al precio original
        function resetToOriginal() {
            window.customPrice = window.originalPrice;
            document.getElementById('custom-price-input').value = window.originalPrice;
            updateNewPrice();
            
            // Marcar preset como activo
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Limpiar raz√≥n
            document.getElementById('price-reason').value = '';
        }

        // Funci√≥n para actualizar el precio nuevo en tiempo real
        function updateNewPrice() {
            const input = document.getElementById('custom-price-input');
            const newPrice = parseFloat(input.value) || 0;
            
            window.customPrice = newPrice;
            document.getElementById('new-price-display').textContent = formatCurrency(newPrice);

            validatePrice(newPrice);
            
            // Limpiar presets activos si el precio fue cambiado manualmente
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // Funci√≥n para validar el precio ingresado
        function validatePrice(price) {
            const validation = document.getElementById('price-validation');
            const applyBtn = document.getElementById('apply-btn');
            
            if (price <= 0) {
                validation.className = 'price-validation error';
                validation.textContent = '‚ùå El precio debe ser mayor a $0.00';
                applyBtn.disabled = true;
                return;
            }
            
            if (price < window.originalPrice * 0.3) {
                validation.className = 'price-validation error';
                validation.textContent = '‚ùå Precio muy bajo (m√°s del 70% de descuento)';
                applyBtn.disabled = true;
                return;
            }
            
            if (price < window.originalPrice * 0.5) {
                validation.className = 'price-validation warning';
                validation.textContent = '‚ö†Ô∏è Precio muy bajo: ' + ((window.originalPrice - price) / window.originalPrice * 100).toFixed(1) + '% de descuento';
                applyBtn.disabled = false;
                return;
            }
            
            if (price > window.originalPrice * 1.5) {
                validation.className = 'price-validation warning';
                validation.textContent = '‚ö†Ô∏è Precio muy alto: ' + ((price - window.originalPrice) / window.originalPrice * 100).toFixed(1) + '% de incremento';
                applyBtn.disabled = false;
                return;
            }
            
            if (price === window.originalPrice) {
                validation.className = 'price-validation';
                validation.textContent = '';
                applyBtn.disabled = false;
                return;
            }
            
            const difference = Math.abs((window.originalPrice - price) / window.originalPrice * 100).toFixed(1);
            if (price < window.originalPrice) {
                validation.className = 'price-validation success';
                validation.textContent = `‚úÖ Descuento del ${difference}% aplicado`;
            } else {
                validation.className = 'price-validation success';
                validation.textContent = `‚úÖ Incremento del ${difference}% aplicado`;
            }
            
            applyBtn.disabled = false;
        }

        // Funci√≥n para aplicar el precio personalizado
        function applyPriceOverride() {
            const newPrice = parseFloat(document.getElementById('custom-price-input').value);
            const reason = document.getElementById('price-reason').value.trim();
            
            if (newPrice <= 0) {
                alert('‚ùå Ingresa un precio v√°lido');
                return;
            }
            
            if (newPrice < window.originalPrice * 0.3) {
                alert('‚ùå El precio es demasiado bajo (m√°s del 70% de descuento)');
                return;
            }
            
            if (!reason && newPrice !== window.originalPrice) {
                if (!confirm('‚ö†Ô∏è No especificaste un motivo para el precio especial.\n\n¬øContinuar sin motivo?')) {
                    return;
                }
            }
            
            // Guardar precio personalizado
            if (newPrice !== window.originalPrice) {
                customPrices[window.currentProductId] = {
                    price: newPrice,
                    reason: reason,
                    originalPrice: window.originalPrice,
                    timestamp: new Date().toISOString()
                };
            } else {
                // Si vuelve al precio original, remover override
                delete customPrices[window.currentProductId];
            }
            
            console.log('üîÑ Precio personalizado aplicado:', {
                productId: window.currentProductId,
                productCode: window.currentProductCode,
                originalPrice: window.originalPrice,
                newPrice: newPrice,
                reason: reason,
                savings: window.originalPrice - newPrice
            });

            // Actualizar la vista del producto
            displaySubstoreProducts(substoreProducts);
            
            // Mostrar notificaci√≥n de √©xito
            const action = newPrice < window.originalPrice ? 'Descuento aplicado' : 
                        newPrice > window.originalPrice ? 'Precio incrementado' : 'Precio restaurado';
            
            if (window.showNotification) {
                window.showNotification(`${action}: ${formatCurrency(newPrice)}`, 'success');
            } else {
                alert(`‚úÖ ${action}\n\nNuevo precio: ${formatCurrency(newPrice)}\nMotivo: ${reason || 'Sin motivo especificado'}`);
            }
            
            closePriceOverride();
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.clear();
                window.location.href = '/';
            }
        }


    // Funciones globales
        window.addToOrder = addToOrder;
        window.removeFromOrder = removeFromOrder;
        window.removePhoto = removePhoto;
        window.logout = logout;
        window.refreshSubstoreStatus = refreshSubstoreStatus;
        window.selectPaymentMethod = selectPaymentMethod;
        window.selectPaymentType = selectPaymentType;
        window.updatePaymentSummary = updatePaymentSummary;
        window.getDetailedLocation = getDetailedLocation;
        window.toggleManualLocation = toggleManualLocation;
        window.saveManualLocation = saveManualLocation;

        console.log('‚úÖ P√°gina de pedidos con tipos de pago y ubicaci√≥n mejorados inicializada');
    </script>

</body>
</html>