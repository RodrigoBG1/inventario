<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Pedido - Sistema de Aceites</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/employee.css">
    <script src="../js/employee.js"></script>
    <style>
        /* Estilos espec√≠ficos para el selector de clientes */
        .client-selector-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .client-search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .client-search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background-color: white;
        }

        .client-search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .client-search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 1rem;
        }

        .client-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .client-dropdown.show {
            display: block;
        }

        .client-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }

        .client-option:last-child {
            border-bottom: none;
        }

        .client-option:hover {
            background-color: #f3f4f6;
        }

        .client-option.selected {
            background-color: #eff6ff;
            color: #1d4ed8;
        }

        .client-name {
            font-weight: 600;
            color: #1f2937;
        }

        .client-details {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .selected-client-card {
            background: #122164;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .selected-client-card.show {
            display: block;
        }

        .selected-client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .selected-client-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .client-change-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.2s;
        }

        .client-change-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .selected-client-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .client-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .new-client-option {
            padding: 0.75rem 1rem;
            background: #f0f9ff;
            border-bottom: 1px solid #e0f2fe;
            cursor: pointer;
            color: #0369a1;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .new-client-option:hover {
            background: #e0f2fe;
        }

        .no-clients-message {
            padding: 1rem;
            text-align: center;
            color: #64748b;
            font-style: italic;
        }

        .client-form-quick {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1.5rem;
            display: none;
            margin-top: 1rem;
        }

        .client-form-quick.show {
            display: block;
        }

        .quick-form-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .quick-form-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .client-debt-indicator {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }

        .client-debt-indicator.no-debt {
            background: #dcfce7;
            color: #166534;
        }

        .client-debt-indicator.with-debt {
            background: #fef3c7;
            color: #92400e;
        }

        .client-debt-indicator.overdue {
            background: #fee2e2;
            color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="employee-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Panel Vendedor</h2>
                <span id="user-name"></span>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Inicio</a></li>
                <li><a href="orders.html" class="active">Crear Pedido</a></li>
                <li><a href="sales.html">Pagos</a></li>
                <li><a href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header class="content-header">
                <h1>Nuevo Pedido - Subalmac√©n</h1>
                <div class="header-actions">
                    <button id="refresh-substore-btn" class="btn btn-secondary" onclick="refreshSubstoreStatus()">
                        Actualizar Estado
                    </button>
                </div>
            </header>

            <!-- Estado del Subalmac√©n -->
            <div id="substore-status-container">
                <!-- Se llena din√°micamente -->
            </div>

            <!-- Contenido del formulario de pedido -->
            <div id="order-form-container" class="order-form-container" style="display: none;">
                
                <!-- NUEVA SECCI√ìN: Selector de Cliente -->
                <div class="form-section client-selector-section">
                    <h3 class="section-title">üë§ Informaci√≥n del Cliente</h3>
                    <div style="padding: 1.5rem;">
                        
                        <!-- Cliente seleccionado -->
                        <div id="selected-client-card" class="selected-client-card">
                            <div class="selected-client-header">
                                <div>
                                    <div class="selected-client-name" id="selected-client-name">Cliente Seleccionado</div>
                                    <div id="selected-client-code" style="font-size: 0.875rem; opacity: 0.9;"></div>
                                </div>
                                <button class="client-change-btn" onclick="clearSelectedClient()">
                                    Cambiar Cliente
                                </button>
                            </div>
                            <div class="selected-client-info" id="selected-client-info">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>

                        <!-- Buscador de clientes -->
                        <div id="client-search-section" class="client-search-section">
                            <div class="client-search-container">
                                <span class="client-search-icon">üîç</span>
                                <input 
                                    type="text" 
                                    id="client-search-input" 
                                    class="client-search-input"
                                    placeholder="Buscar cliente por nombre, tel√©fono o c√≥digo..."
                                    autocomplete="off"
                                >
                                <div id="client-dropdown" class="client-dropdown">
                                    <!-- Se llena din√°micamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Formulario r√°pido para nuevo cliente -->
                        <div id="client-form-quick" class="client-form-quick">
                            <div class="quick-form-header">
                                <h4 class="quick-form-title">‚ûï Nuevo Cliente R√°pido</h4>
                                <button class="client-change-btn" onclick="cancelNewClient()">
                                    Cancelar
                                </button>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="quick-client-name">Nombre Completo *</label>
                                    <input type="text" id="quick-client-name" required placeholder="Nombre del cliente">
                                </div>
                                <div class="form-group">
                                    <label for="quick-client-phone">Tel√©fono *</label>
                                    <input type="tel" id="quick-client-phone" required placeholder="618-123-4567">
                                </div>
                                <div class="form-group">
                                    <label for="quick-client-address">Direcci√≥n</label>
                                    <input type="text" id="quick-client-address" placeholder="Direcci√≥n del cliente">
                                </div>
                                <div class="form-group">
                                    <label for="quick-client-email">Email</label>
                                    <input type="email" id="quick-client-email" placeholder="correo@ejemplo.com">
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="cancelNewClient()">
                                    Cancelar
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveQuickClient()">
                                    Guardar Cliente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Productos del Subalmac√©n -->
                <div class="form-section">
                    <h3 class="section-title">üì¶ Productos Disponibles en mi Subalmac√©n</h3>
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <input type="text" id="product-search" class="search-input" 
                               placeholder="üîç Buscar productos en mi subalmac√©n...">
                    </div>
                    
                    <div style="padding: 1.5rem;">
                        <div id="products-list" class="loading">Cargando productos del subalmac√©n...</div>
                        
                        <div class="selected-products" style="margin-top: 2rem;">
                            <h4>Productos en el Pedido (<span id="products-count">0</span>)</h4>
                            <div style="overflow-x: auto;">
                                <table id="order-products-table">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Precio Unit.</th>
                                            <th>Cantidad</th>
                                            <th>Subtotal</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" style="text-align: center; padding: 2rem; color: #64748b;">
                                                üìù No hay productos en el pedido
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="cart-summary">
                                <div class="cart-items-count" id="cart-items-count">0 productos seleccionados</div>
                                <div class="cart-total">Total: <span id="order-total">$0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Opciones de Pago -->
                <div class="payment-options-section">
                    <h3 class="payment-section-title">
                        üí≥ Modalidad y Tipo de Pago
                    </h3>
                    
                    <!-- Modalidad de pago -->
                    <div class="payment-method-grid">
                        <div class="payment-method-option selected" onclick="selectPaymentMethod('cash')">
                            <input type="radio" name="payment_method" value="cash" id="payment-cash" checked>
                            <div class="payment-method-header">
                                <div class="payment-icon">üíµ</div>
                                <div class="payment-title">Contado</div>
                            </div>
                            <div class="payment-description">
                                Pago completo al momento de la entrega
                            </div>
                        </div>

                        <div class="payment-method-option" onclick="selectPaymentMethod('credit')">
                            <input type="radio" name="payment_method" value="credit" id="payment-credit">
                            <div class="payment-method-header">
                                <div class="payment-icon">üìã</div>
                                <div class="payment-title">Cr√©dito</div>
                            </div>
                            <div class="payment-description">
                                El cliente puede abonar parcialmente
                            </div>
                        </div>
                    </div>

                    <!-- Tipo de pago espec√≠fico -->
                    <div class="payment-type-section">
                        <h4 class="payment-type-title">üè¶ Tipo de Pago</h4>
                        <div class="payment-type-grid">
                            <div class="payment-type-option selected" onclick="selectPaymentType('efectivo')">
                                <div class="payment-type-icon">üíµ</div>
                                <div class="payment-type-label">Efectivo</div>
                            </div>
                            <div class="payment-type-option" onclick="selectPaymentType('tarjeta')">
                                <div class="payment-type-icon">üí≥</div>
                                <div class="payment-type-label">Tarjeta</div>
                            </div>
                            <div class="payment-type-option" onclick="selectPaymentType('transferencia')">
                                <div class="payment-type-icon">üè¶</div>
                                <div class="payment-type-label">Transferencia</div>
                            </div>
                            <div class="payment-type-option" onclick="selectPaymentType('cheque')">
                                <div class="payment-type-icon">üìù</div>
                                <div class="payment-type-label">Cheque</div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n de Abono Inicial -->
                    <div class="initial-payment-section" id="initial-payment-section">
                        <label for="initial-payment" class="initial-payment-label">
                            üí∞ Abono Inicial (Opcional)
                        </label>
                        <input type="number" 
                               id="initial-payment" 
                               class="initial-payment-input"
                               step="0.01" 
                               min="0" 
                               placeholder="0.00"
                               onchange="updatePaymentSummary()">
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6366f1;">
                            üí° El cliente puede abonar cualquier cantidad
                        </div>
                    </div>

                    <!-- Resumen de Pago -->
                    <div class="payment-summary" id="payment-summary">
                        <div class="summary-row">
                            <span>Total del pedido:</span>
                            <span id="summary-total">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Abono inicial:</span>
                            <span id="summary-initial">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Saldo pendiente:</span>
                            <span id="summary-balance">$0.00</span>
                        </div>
                        <div class="summary-row payment-type-summary">
                            <span>Tipo de pago:</span>
                            <span id="summary-payment-type">Efectivo</span>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n de Ubicaci√≥n -->
                <div class="location-section">
                    <h3 class="section-title">Ubicaci√≥n de la Venta</h3>
                    <div style="padding: 1.5rem;">
                        <div class="location-controls">
                            <button type="button" id="get-location-btn" class="btn-location-detailed" onclick="getDetailedLocation()">
                             Obtener Mi Ubicaci√≥n
                            </button>
                        </div>
                        
                        <div id="location-status" class="location-status">
                            <div class="location-icon">üìç</div>
                            <div class="location-text">
                                <div class="location-title">Sin ubicaci√≥n</div>
                                <div class="location-subtitle">Obt√©n tu ubicaci√≥n actual o ingr√©sala manualmente</div>
                            </div>
                        </div>

                        <!-- Manual location input -->
                        <div id="manual-location-input" class="manual-location-input" style="display: none;">
                            <div class="form-group">
                                <label for="manual-address">Direcci√≥n:</label>
                                <input type="text" id="manual-address" placeholder="Escribe la direcci√≥n donde realizas la venta">
                            </div>
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="manual-lat">Latitud (opcional):</label>
                                    <input type="number" id="manual-lat" step="any" placeholder="ej: 20.1234">
                                </div>
                                <div class="form-group">
                                    <label for="manual-lng">Longitud (opcional):</label>
                                    <input type="number" id="manual-lng" step="any" placeholder="ej: -103.1234">
                                </div>
                            </div>
                            <button type="button" onclick="saveManualLocation()" class="btn btn-secondary">
                                üíæ Guardar Ubicaci√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n Adicional -->
                <div class="form-section">
                    <h3 class="section-title">Informaci√≥n Adicional</h3>
                    <div style="padding: 1.5rem;">
                        <div class="form-group">
                            <label for="order-photo">Foto del Pedido (Opcional):</label>
                            <input type="file" id="order-photo" accept="image/*" capture="camera">
                            <div id="photo-preview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="order-notes">Observaciones:</label>
                            <textarea id="order-notes" rows="4" 
                                      placeholder="Instrucciones especiales, observaciones, etc."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="clear-order-btn">Limpiar Pedido</button>
                    <button type="button" class="btn btn-primary" id="submit-order-btn">‚ú® Crear Pedido</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    
    <script>
        console.log('üöÄ Iniciando p√°gina de pedidos con selector de clientes');

        // Variables globales
        let substoreProducts = [];
        let orderProducts = [];
        let currentLocation = null;
        let isProcessing = false;
        let currentPaymentMethod = 'cash';
        let currentPaymentType = 'efectivo';
        let substoreInfo = null;
        let customPrices = {};
        
        // NUEVAS VARIABLES PARA CLIENTES
        let allClients = [];
        let selectedClient = null;
        let isLoadingClients = false;

        const additionalStyles = `
            .quick-client-form-loading {
                opacity: 0.7;
                pointer-events: none;
            }

            .form-input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .form-input.valid {
                border-color: #10b981;
            }

            .form-input.invalid {
                border-color: #ef4444;
            }

            .new-client-option:hover {
                background: #dbeafe;
                transform: translateY(-1px);
                transition: all 0.2s ease;
            }

            .client-form-quick .form-actions {
                position: sticky;
                bottom: 0;
                background: white;
                border-top: 1px solid #e5e7eb;
                padding: 1rem 0 0 0;
                margin-top: 1rem;
            }

            @media (max-width: 768px) {
                .client-form-quick {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    z-index: 1000;
                    background: white;
                    overflow-y: auto;
                    padding: 1rem;
                }
                
                .quick-form-header {
                    position: sticky;
                    top: 0;
                    background: white;
                    z-index: 10;
                    padding-bottom: 1rem;
                    border-bottom: 2px solid #e5e7eb;
                }
            }
            `;

// Inyectar estilos
const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã Inicializando p√°gina de pedidos con clientes...');
            
            const user = checkAuth();
            if (!user) return;
            
            if (user.role !== 'employee') {
                alert('Esta p√°gina es solo para vendedores.');
                window.location.href = '/';
                return;
            }
            
            const userNameElement = document.getElementById('user-name');
            if (userNameElement) userNameElement.textContent = user.name;
            
            setupEventListeners();
            setupClientSelector();
            setupMobile();
            loadSubstoreStatus();
            setupQuickClientFormValidation();
            loadClients();
        });

        // ===== FUNCIONES PARA MANEJO DE CLIENTES =====

        // Cargar lista de clientes
        async function loadClients() {
            if (isLoadingClients) return;
            
            console.log('üë• Cargando lista de clientes...');
            isLoadingClients = true;
            
            try {
                const clients = await getClients();
                allClients = Array.isArray(clients) ? clients : [];
                
                console.log('‚úÖ Clientes cargados:', allClients.length);
                
                if (allClients.length === 0) {
                    console.log('‚ö†Ô∏è No hay clientes registrados');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando clientes:', error);
                allClients = [];
                if (window.showNotification) {
                    window.showNotification('Error cargando lista de clientes', 'warning');
                }
            } finally {
                isLoadingClients = false;
            }
        }

        // Configurar el selector de clientes
        function setupClientSelector() {
            const searchInput = document.getElementById('client-search-input');
            const dropdown = document.getElementById('client-dropdown');
            
            if (!searchInput || !dropdown) return;
            
            // Event listeners para el buscador
            searchInput.addEventListener('input', handleClientSearch);
            searchInput.addEventListener('focus', handleClientSearchFocus);
            searchInput.addEventListener('blur', handleClientSearchBlur);
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.client-search-container')) {
                    hideClientDropdown();
                }
            });
            
            console.log('‚úÖ Selector de clientes configurado');
        }

        // Manejar b√∫squeda de clientes
        function handleClientSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm.length === 0) {
                hideClientDropdown();
                return;
            }
            
            // Filtrar clientes
            const filteredClients = allClients.filter(client => {
                return (
                    (client.name && client.name.toLowerCase().includes(searchTerm)) ||
                    (client.phone && client.phone.includes(searchTerm)) ||
                    (client.code && client.code.toLowerCase().includes(searchTerm)) ||
                    (client.email && client.email.toLowerCase().includes(searchTerm))
                );
            });
            
            displayClientOptions(filteredClients, searchTerm);
        }

        // Manejar focus en el buscador
        function handleClientSearchFocus(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm.length > 0) {
                handleClientSearch(e);
            } else {
                // Mostrar los primeros 10 clientes
                displayClientOptions(allClients.slice(0, 10));
            }
        }

        // Manejar blur del buscador
        function handleClientSearchBlur(e) {
            // Delay para permitir clic en dropdown
            setTimeout(() => {
                hideClientDropdown();
            }, 200);
        }

        // Mostrar opciones de clientes en el dropdown
        function displayClientOptions(clients, searchTerm = '') {
            const dropdown = document.getElementById('client-dropdown');
            if (!dropdown) return;
            
            dropdown.innerHTML = '';
            
            // ‚úÖ MEJORAR OPCI√ìN PARA CREAR NUEVO CLIENTE
            if (searchTerm.length >= 2) {
                const newClientOption = document.createElement('div');
                newClientOption.className = 'new-client-option';
                
                // Detectar si el t√©rmino parece un tel√©fono
                const isPhoneLike = /^[\d\-\s\+\(\)]{8,}$/.test(searchTerm);
                const displayText = isPhoneLike ? `con tel√©fono "${searchTerm}"` : `con nombre "${searchTerm}"`;
                
                newClientOption.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="font-size: 1.2rem;">‚ûï</div>
                        <div>
                            <div style="font-weight: 600;">Crear nuevo cliente</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">${displayText}</div>
                        </div>
                    </div>
                `;
                
                newClientOption.addEventListener('click', () => openNewClientForm(searchTerm));
                dropdown.appendChild(newClientOption);
            }
            
            // Mostrar clientes existentes
            if (clients.length === 0 && searchTerm.length > 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-clients-message';
                noResults.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîç</div>
                        <div>No se encontraron clientes</div>
                        ${searchTerm.length >= 2 ? '<div style="font-size: 0.8rem; margin-top: 0.25rem; opacity: 0.7;">Puedes crear un nuevo cliente arriba</div>' : ''}
                    </div>
                `;
                dropdown.appendChild(noResults);
            } else {
                clients.slice(0, 8).forEach(client => {
                    const option = createClientOption(client);
                    dropdown.appendChild(option);
                });
                
                if (clients.length > 8) {
                    const moreResults = document.createElement('div');
                    moreResults.className = 'no-clients-message';
                    moreResults.textContent = `+ ${clients.length - 8} clientes m√°s...`;
                    dropdown.appendChild(moreResults);
                }
            }
            
            showClientDropdown();
        }

        // Crear opci√≥n de cliente
        function createClientOption(client) {
            const option = document.createElement('div');
            option.className = 'client-option';
            
            // Determinar estado de deuda
            let debtIndicator = '';
            const totalDebt = client.totalDebt || 0;
            
            if (totalDebt > 0) {
                const debtClass = totalDebt > 1000 ? 'overdue' : 'with-debt';
                const debtText = totalDebt > 1000 ? 'Vencido' : 'Con deuda';
                debtIndicator = `<span class="client-debt-indicator ${debtClass}">${debtText}</span>`;
            } else {
                debtIndicator = '<span class="client-debt-indicator no-debt">Al corriente</span>';
            }
            
            option.innerHTML = `
                <div class="client-name">
                    ${client.name || 'Sin nombre'}${debtIndicator}
                </div>
                <div class="client-details">
                    ${client.code || 'Sin c√≥digo'} ‚Ä¢ ${client.phone || 'Sin tel√©fono'}
                    ${client.address ? ' ‚Ä¢ ' + client.address : ''}
                    ${totalDebt > 0 ? ' ‚Ä¢ Deuda: ' + formatCurrency(totalDebt) : ''}
                </div>
            `;
            
            option.addEventListener('click', () => selectClient(client));
            
            return option;
        }

        // Seleccionar cliente
        function selectClient(client) {
            console.log('üë§ Cliente seleccionado:', client.name);
            
            selectedClient = client;
            
            // Mostrar tarjeta de cliente seleccionado
            displaySelectedClient(client);
            
            // Ocultar secci√≥n de b√∫squeda
            hideClientDropdown();
            document.getElementById('client-search-section').style.display = 'none';
            document.getElementById('selected-client-card').classList.add('show');
            
            // Limpiar buscador
            document.getElementById('client-search-input').value = '';
            
            // Notificaci√≥n
            if (window.showNotification) {
                window.showNotification(`Cliente seleccionado: ${client.name}`, 'success');
            }
        }

        // Mostrar cliente seleccionado
        function displaySelectedClient(client) {
            const nameElement = document.getElementById('selected-client-name');
            const codeElement = document.getElementById('selected-client-code');
            const infoElement = document.getElementById('selected-client-info');
            
            if (nameElement) nameElement.textContent = client.name || 'Cliente sin nombre';
            if (codeElement) codeElement.textContent = client.code || 'Sin c√≥digo';
            
            if (infoElement) {
                const totalDebt = client.totalDebt || 0;
                const debtStatus = totalDebt > 0 ? `‚ö†Ô∏è Deuda: ${formatCurrency(totalDebt)}` : '‚úÖ Al corriente';
                
                infoElement.innerHTML = `
                    <div class="client-info-item">
                        <span></span>
                        <span>${client.phone || 'Sin tel√©fono'}</span>
                    </div>
                    ${client.email ? `
                        <div class="client-info-item">
                            <span></span>
                            <span>${client.email}</span>
                        </div>
                    ` : ''}
                `;
            }
        }

        // Limpiar cliente seleccionado
        function clearSelectedClient() {
            console.log('üîÑ Limpiando cliente seleccionado');
            
            selectedClient = null;
            
            // Ocultar tarjeta de cliente seleccionado
            document.getElementById('selected-client-card').classList.remove('show');
            
            // Mostrar secci√≥n de b√∫squeda
            document.getElementById('client-search-section').style.display = 'block';
            
            // Limpiar formulario r√°pido si est√° visible
            cancelNewClient();
            
            // Focus en buscador
            setTimeout(() => {
                const searchInput = document.getElementById('client-search-input');
                if (searchInput) searchInput.focus();
            }, 100);
        }

        // Abrir formulario de nuevo cliente
        function openNewClientForm(searchTerm = '') {
            console.log('üìù Abriendo formulario de nuevo cliente con t√©rmino:', searchTerm);
            
            hideClientDropdown();
            
            // Mostrar formulario
            document.getElementById('client-form-quick').classList.add('show');
            
            // ‚úÖ MEJORAR PRE-LLENADO DE DATOS
            if (searchTerm) {
                // Detectar si es tel√©fono o nombre
                const isPhoneLike = /^[\d\-\s\+\(\)]{8,}$/.test(searchTerm);
                
                if (isPhoneLike) {
                    // Es un tel√©fono
                    const phoneInput = document.getElementById('quick-client-phone');
                    if (phoneInput) {
                        phoneInput.value = searchTerm;
                    }
                    
                    // Focus en nombre
                    setTimeout(() => {
                        const nameInput = document.getElementById('quick-client-name');
                        if (nameInput) nameInput.focus();
                    }, 100);
                } else {
                    // Es un nombre
                    const nameInput = document.getElementById('quick-client-name');
                    if (nameInput) {
                        nameInput.value = searchTerm;
                    }
                    
                    // Focus en tel√©fono
                    setTimeout(() => {
                        const phoneInput = document.getElementById('quick-client-phone');
                        if (phoneInput) phoneInput.focus();
                    }, 100);
                }
            } else {
                // Focus en primer campo
                setTimeout(() => {
                    const nameInput = document.getElementById('quick-client-name');
                    if (nameInput) nameInput.focus();
                }, 100);
            }
        }
                
        // Cancelar nuevo cliente
        function cancelNewClient() {
            document.getElementById('client-form-quick').classList.remove('show');
            
            // Limpiar formulario
            const fields = ['quick-client-name', 'quick-client-phone', 'quick-client-address', 'quick-client-email'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });
        }

        // Guardar cliente r√°pido
        async function saveQuickClient() {
            console.log('üíæ Guardando cliente r√°pido desde empleado');
            
            // Obtener datos del formulario
            const name = document.getElementById('quick-client-name')?.value?.trim();
            const phone = document.getElementById('quick-client-phone')?.value?.trim();
            const address = document.getElementById('quick-client-address')?.value?.trim();
            const email = document.getElementById('quick-client-email')?.value?.trim();
            
            // Validaciones
            if (!name) {
                if (window.showNotification) {
                    window.showNotification('El nombre del cliente es requerido', 'warning');
                } else {
                    alert('El nombre del cliente es requerido');
                }
                document.getElementById('quick-client-name')?.focus();
                return;
            }
            
            if (!phone) {
                if (window.showNotification) {
                    window.showNotification('El tel√©fono del cliente es requerido', 'warning');
                } else {
                    alert('El tel√©fono del cliente es requerido');
                }
                document.getElementById('quick-client-phone')?.focus();
                return;
            }
            
            // Validar formato de tel√©fono (b√°sico)
            const phoneRegex = /^[\d\-\s\+\(\)]{10,}$/;
            if (!phoneRegex.test(phone)) {
                if (window.showNotification) {
                    window.showNotification('Formato de tel√©fono inv√°lido', 'warning');
                } else {
                    alert('Formato de tel√©fono inv√°lido');
                }
                document.getElementById('quick-client-phone')?.focus();
                return;
            }
            
            // Verificar si ya existe un cliente con el mismo tel√©fono
            const existingClient = allClients.find(c => 
                c.phone === phone || 
                (c.name && c.name.toLowerCase() === name.toLowerCase())
            );
            
            if (existingClient) {
                if (confirm(`Ya existe un cliente con informaci√≥n similar:\n\nNombre: ${existingClient.name}\nTel√©fono: ${existingClient.phone}\n\n¬øQuieres seleccionar este cliente existente en lugar de crear uno nuevo?`)) {
                    selectClient(existingClient);
                    cancelNewClient();
                    return;
                }
            }
            
            const clientData = {
                name,
                phone,
                address: address || '',
                email: email || '',
                city: 'Victoria de Durango', // ‚úÖ Default para empleados
                state: 'Durango', // ‚úÖ Default para empleados
                notes: 'Cliente creado desde app m√≥vil por empleado'
            };
            
            // Mostrar indicador de carga
            const saveButton = document.querySelector('#client-form-quick .btn-primary');
            const originalText = saveButton?.textContent;
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.textContent = '‚è≥ Guardando...';
            }
            
            try {
                console.log('üì§ Enviando datos del cliente:', clientData);
                
                // ‚úÖ USAR LA API DE CLIENTES CORREGIDA
                const response = await fetch(`${window.API_BASE_URL}/api/clients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(clientData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error ${response.status}: ${response.statusText}`);
                }
                
                const newClient = await response.json();
                
                console.log('‚úÖ Cliente creado exitosamente:', newClient);
                
                // Agregarlo a la lista local
                allClients.unshift(newClient);
                
                // Seleccionarlo autom√°ticamente
                selectClient(newClient);
                
                // Ocultar formulario
                cancelNewClient();
                
                if (window.showNotification) {
                    window.showNotification(`Cliente "${newClient.name}" creado exitosamente`, 'success');
                } else {
                    alert(`Cliente "${newClient.name}" creado exitosamente`);
                }
                
            } catch (error) {
                console.error('‚ùå Error creando cliente:', error);
                
                let errorMessage = 'Error al crear cliente';
                
                if (error.message.includes('c√≥digo de cliente ya existe')) {
                    errorMessage = 'El c√≥digo de cliente ya existe. Intenta nuevamente.';
                } else if (error.message.includes('Nombre y tel√©fono son campos obligatorios')) {
                    errorMessage = 'Nombre y tel√©fono son obligatorios';
                } else if (error.message.includes('Network') || error.message.includes('fetch')) {
                    errorMessage = 'Error de conexi√≥n. Verifica tu internet e intenta nuevamente.';
                } else {
                    errorMessage = error.message;
                }
                
                if (window.showNotification) {
                    window.showNotification(errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
                
            } finally {
                // Restaurar bot√≥n
                if (saveButton && originalText) {
                    saveButton.disabled = false;
                    saveButton.textContent = originalText;
                }
            }
        }

        // Generar c√≥digo de cliente autom√°tico
        function generateClientCode() {
            const existingCodes = allClients.map(c => c.code).filter(code => code);
            let counter = 1;
            let newCode;
            
            do {
                newCode = `CLI${String(counter).padStart(3, '0')}`;
                counter++;
            } while (existingCodes.includes(newCode));
            
            return newCode;
        }

        // Mostrar/ocultar dropdown
        function showClientDropdown() {
            document.getElementById('client-dropdown').classList.add('show');
        }

        function hideClientDropdown() {
            document.getElementById('client-dropdown').classList.remove('show');
        }

        // ===== CONFIGURAR EVENT LISTENERS =====
        function setupEventListeners() {
            console.log('üéØ Configurando event listeners...');
            
            const submitBtn = document.getElementById('submit-order-btn');
            if (submitBtn) submitBtn.addEventListener('click', handleCreateOrder);
            
            const clearBtn = document.getElementById('clear-order-btn');
            if (clearBtn) clearBtn.addEventListener('click', handleClearOrder);
            
            const searchInput = document.getElementById('product-search');
            if (searchInput) searchInput.addEventListener('input', handleSearch);
            
            const photoInput = document.getElementById('order-photo');
            if (photoInput) photoInput.addEventListener('change', handlePhotoChange);
            
            console.log('‚úÖ Event listeners configurados');
        }

        // ===== FUNCI√ìN PRINCIPAL: CREAR PEDIDO (CORREGIDA) =====
        async function handleCreateOrder() {
            if (isProcessing) return;
            
            console.log('üì§ Iniciando creaci√≥n de pedido con cliente:', {
                client: selectedClient?.name || 'Sin seleccionar',
                paymentMethod: currentPaymentMethod,
                paymentType: currentPaymentType,
                location: currentLocation,
                customPrices: Object.keys(customPrices).length
            });
            
            // ‚úÖ VALIDACI√ìN CORREGIDA: Solo verificar que hay cliente seleccionado
            if (!selectedClient) {
                if (window.showNotification) {
                    window.showNotification('Debes seleccionar un cliente para el pedido', 'warning');
                }
                // Scroll hacia arriba para mostrar selector de cliente
                document.querySelector('.client-selector-section').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                return;
            }
            
            // Validar productos
            if (!orderProducts || orderProducts.length === 0) {
                if (window.showNotification) {
                    window.showNotification('Agrega al menos un producto del subalmac√©n', 'warning');
                }
                return;
            }
            
            // Validar ubicaci√≥n (opcional pero recomendada)
            if (!currentLocation) {
                const confirmWithoutLocation = confirm('‚ö†Ô∏è No hay ubicaci√≥n registrada.\n\n¬øContinuar sin ubicaci√≥n?\n\nRecomendamos obtener la ubicaci√≥n para mejorar el servicio.');
                if (!confirmWithoutLocation) {
                    return;
                }
            }
            
            if (!substoreInfo) {
                if (window.showNotification) {
                    window.showNotification('Error: No hay informaci√≥n del subalmac√©n', 'error');
                }
                return;
            }
            
            // Obtener informaci√≥n de pago
            const total = orderProducts.reduce((sum, p) => sum + p.line_total, 0);
            let initialPayment = 0;
            
            if (currentPaymentMethod === 'credit') {
                initialPayment = parseFloat(document.getElementById('initial-payment')?.value) || 0;
                
                if (initialPayment > total) {
                    if (window.showNotification) {
                        window.showNotification('El abono inicial no puede ser mayor al total', 'warning');
                    }
                    return;
                }
            } else {
                initialPayment = total;
            }
            
            // Verificar si hay precios personalizados
            let customPricingSummary = null;
            if (Object.keys(customPrices).length > 0) {
                customPricingSummary = {
                    products_with_custom_price: Object.keys(customPrices).length,
                    total_savings: 0,
                    custom_price_details: []
                };
                
                orderProducts.forEach(product => {
                    if (product.custom_price_info) {
                        customPricingSummary.total_savings += product.custom_price_info.discount_amount * product.quantity;
                        customPricingSummary.custom_price_details.push({
                            product_code: product.code,
                            product_name: product.name,
                            quantity: product.quantity,
                            original_price: product.custom_price_info.original_price,
                            custom_price: product.custom_price_info.custom_price,
                            total_savings: product.custom_price_info.discount_amount * product.quantity,
                            reason: product.custom_price_info.reason
                        });
                    }
                });
            }
            
            isProcessing = true;
            const submitBtn = document.getElementById('submit-order-btn');
            
            try {
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = '‚ö° Procesando Venta...';
                }
                
                // ‚úÖ PREPARAR DATOS DEL PEDIDO - USANDO CLIENTE SELECCIONADO
                const formData = {
                    client_info: {
                        client_id: selectedClient.id, // ID del cliente
                        name: selectedClient.name,
                        phone: selectedClient.phone || '',
                        address: selectedClient.address || '',
                        email: selectedClient.email || '',
                        code: selectedClient.code || ''
                    },
                    products: orderProducts,
                    payment_method: currentPaymentMethod,
                    payment_type: currentPaymentType,
                    inventory_source: 'substore',
                    trip_id: substoreInfo.id,
                    location: currentLocation,
                    notes: document.getElementById('order-notes')?.value?.trim() || '',
                    total: total,
                    
                    // Informaci√≥n de pagos
                    paid_amount: initialPayment,
                    balance: total - initialPayment,
                    is_fully_paid: initialPayment >= total,
                    payment_status: initialPayment >= total ? 'paid' : (initialPayment > 0 ? 'partial' : 'pending'),
                    
                    // Informaci√≥n de precios personalizados
                    custom_pricing_summary: customPricingSummary
                };
                
                // Manejar foto
                const photoFile = document.getElementById('order-photo')?.files[0];
                if (photoFile) {
                    try {
                        const photoBase64 = await convertToBase64(photoFile);
                        formData.photo_url = photoBase64;
                    } catch (error) {
                        console.error('Error con la foto:', error);
                    }
                }
                
                console.log('üì§ Enviando pedido con cliente seleccionado:', formData);
                
                // Enviar pedido
                const response = await fetch(`${window.API_BASE_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    console.log('üéâ Pedido procesado exitosamente:', result);
                    
                    const methodText = currentPaymentMethod === 'cash' ? 'Contado' : 'Cr√©dito';
                    const orderNumber = result.order?.order_number || 'Gener√°ndose...';
                    const saleNumber = result.sale?.sale_number || 'Gener√°ndose...';
                    const tripNumber = substoreInfo.trip_number;
                    
                    // Informaci√≥n de pago detallada
                    let paymentInfo = `\nüí≥ Modalidad: ${methodText}`;
                    paymentInfo += `\nüè¶ Tipo: ${getPaymentTypeLabel(currentPaymentType)}`;
                    
                    if (currentPaymentMethod === 'credit') {
                        const balance = total - initialPayment;
                        if (initialPayment > 0) {
                            paymentInfo += `\nAbono inicial: ${formatCurrency(initialPayment)}`;
                        }
                        if (balance > 0) {
                            paymentInfo += `\nSaldo pendiente: ${formatCurrency(balance)}`;
                        } else {
                            paymentInfo += `\nPedido TOTALMENTE PAGADO`;
                        }
                    } else {
                        paymentInfo += '\nAGO COMPLETO AL CONTADO';
                    }
                    
                    // Informaci√≥n de precios personalizados
                    let customPriceInfo = '';
                    if (customPricingSummary && customPricingSummary.products_with_custom_price > 0) {
                        customPriceInfo = `\n\nPRECIOS PERSONALIZADOS:`;
                        customPriceInfo += `\n‚Ä¢ ${customPricingSummary.products_with_custom_price} producto(s) con precio especial`;
                        if (customPricingSummary.total_savings > 0) {
                            customPriceInfo += `\n‚Ä¢ Ahorro total: ${formatCurrency(customPricingSummary.total_savings)}`;
                        }
                    }
                    
                    // Informaci√≥n de ubicaci√≥n
                    let locationInfo = '';
                    if (currentLocation) {
                        locationInfo = `\nüìç Ubicaci√≥n: ${currentLocation.address}`;
                    }
                    
                    const confirmationMessage = `üéâ ¬°VENTA COMPLETADA EXITOSAMENTE!

üìã Pedido: ${orderNumber}
üí∞ Venta: ${saleNumber}
üë§ Cliente: ${selectedClient.name} (${selectedClient.code})
üì¶ Productos: ${orderProducts.length}
üíµ Total: ${formatCurrency(formData.total)}${paymentInfo}${customPriceInfo}${locationInfo}
üöõ Subalmac√©n: ${tripNumber}

‚úÖ La venta ha sido procesada autom√°ticamente
üì¶ El inventario de tu subalmac√©n ha sido actualizado
üìä El registro de venta ha sido creado
üë• Cliente vinculado al pedido

¬°Felicidades por tu venta! üéä`;
                    
                    alert(confirmationMessage);
                    
                    if (window.showNotification) {
                        window.showNotification(`¬°Venta ${methodText.toLowerCase()} completada para ${selectedClient.name}! üéâ`, 'success');
                    }
                    
                    // Limpiar formulario
                    clearOrderForm();
                    
                    // Recargar productos del subalmac√©n
                    await loadSubstoreProducts();
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error en el servidor');
                }
                
            } catch (error) {
                console.error('‚ùå Error procesando pedido:', error);
                
                if (window.showNotification) {
                    window.showNotification('Error: ' + error.message, 'error');
                }
                
                alert(`‚ùå Error al procesar la venta:

${error.message}

Verifica la informaci√≥n e intenta nuevamente.`);
                
            } finally {
                isProcessing = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚ú® Crear Pedido';
                }
            }
        }
        
        // ===== FUNCI√ìN PARA LIMPIAR FORMULARIO =====
        function clearOrderForm() {
            orderProducts = [];
            customPrices = {};
            updateOrderTable();
            
            // ‚úÖ LIMPIAR CLIENTE SELECCIONADO
            clearSelectedClient();
            
            // Limpiar campos
            const fields = ['order-notes'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });
            
            const photoInput = document.getElementById('order-photo');
            const photoPreview = document.getElementById('photo-preview');
            if (photoInput) photoInput.value = '';
            if (photoPreview) photoPreview.innerHTML = '';
            
            selectPaymentMethod('cash');
            selectPaymentType('efectivo');
            const initialPaymentField = document.getElementById('initial-payment');
            if (initialPaymentField) initialPaymentField.value = '';
            
            // Limpiar ubicaci√≥n
            currentLocation = null;
            const locationStatus = document.getElementById('location-status');
            if (locationStatus) {
                locationStatus.innerHTML = `
                    <div class="location-icon">üìç</div>
                    <div class="location-text">
                        <div class="location-title">Sin ubicaci√≥n</div>
                        <div class="location-subtitle">Obt√©n tu ubicaci√≥n actual o ingr√©sala manualmente</div>
                    </div>
                `;
            }
            
            const locationBtn = document.getElementById('get-location-btn');
            if (locationBtn) {
                locationBtn.textContent = 'üì± Obtener Mi Ubicaci√≥n';
                locationBtn.style.backgroundColor = '';
                locationBtn.disabled = false;
            }
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.value = 1;
            });
            
            // Actualizar vista de productos
            if (substoreProducts && substoreProducts.length > 0) {
                displaySubstoreProducts(substoreProducts);
            }
        }

        // ===== RESTO DE FUNCIONES (sin cambios) =====
        
        function selectPaymentType(type) {
            console.log('üè¶ Seleccionando tipo de pago:', type);
            
            currentPaymentType = type;
            
            document.querySelectorAll('.payment-type-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.querySelectorAll('.payment-type-option').forEach(option => {
                if (option.querySelector('.payment-type-label').textContent === getPaymentTypeLabel(type)) {
                    option.classList.add('selected');
                }
            });
            
            updatePaymentSummary();
            
            console.log('‚úÖ Tipo de pago actualizado a:', currentPaymentType);
        }

        function getPaymentTypeLabel(type) {
            const labels = {
                'efectivo': 'Efectivo',
                'tarjeta': 'Tarjeta',
                'transferencia': 'Transferencia',
                'cheque': 'Cheque'
            };
            return labels[type] || 'Efectivo';
        }

        function selectPaymentMethod(method) {
            console.log('üí≥ Seleccionando m√©todo de pago:', method);
            
            currentPaymentMethod = method;
            
            document.querySelectorAll('.payment-method-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector(`#payment-${method}`).closest('.payment-method-option');
            selectedOption.classList.add('selected');
            
            document.getElementById(`payment-${method}`).checked = true;
            
            const initialPaymentSection = document.getElementById('initial-payment-section');
            const paymentSummary = document.getElementById('payment-summary');
            
            if (method === 'credit') {
                initialPaymentSection.classList.add('show');
                paymentSummary.classList.add('show');
            } else {
                initialPaymentSection.classList.remove('show');
                paymentSummary.classList.remove('show');
                document.getElementById('initial-payment').value = '';
            }
            
            updateProductPrices();
            updatePaymentSummary();
            
            console.log('‚úÖ M√©todo de pago actualizado a:', currentPaymentMethod);
        }

        function updatePaymentSummary() {
            const total = orderProducts.reduce((sum, p) => sum + p.line_total, 0);
            const initialPayment = parseFloat(document.getElementById('initial-payment')?.value) || 0;
            const balance = Math.max(0, total - initialPayment);
            
            document.getElementById('summary-total').textContent = formatCurrency(total);
            document.getElementById('summary-initial').textContent = formatCurrency(initialPayment);
            document.getElementById('summary-balance').textContent = formatCurrency(balance);
            document.getElementById('summary-payment-type').textContent = getPaymentTypeLabel(currentPaymentType);
            
            if (initialPayment > total && total > 0) {
                document.getElementById('initial-payment').style.borderColor = '#dc2626';
                document.getElementById('summary-initial').style.color = '#dc2626';
            } else {
                document.getElementById('initial-payment').style.borderColor = '#f59e0b';
                document.getElementById('summary-initial').style.color = 'inherit';
            }
        }

        // Funciones de ubicaci√≥n
        async function getDetailedLocation() {
            const btn = document.getElementById('get-location-btn');
            const status = document.getElementById('location-status');
            
            if (!btn || !status) return;
            
            try {
                btn.disabled = true;
                btn.textContent = 'üì° Obteniendo ubicaci√≥n...';
                
                status.innerHTML = `
                    <div class="location-icon">‚è≥</div>
                    <div class="location-text">
                        <div class="location-title">Obteniendo ubicaci√≥n...</div>
                        <div class="location-subtitle">Por favor espera mientras obtenemos tu ubicaci√≥n actual</div>
                    </div>
                `;
                
                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;
                
                console.log('üìç Ubicaci√≥n obtenida:', { latitude, longitude });
                
                let address = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
                
                try {
                    address = await reverseGeocode(latitude, longitude);
                } catch (geoError) {
                    console.warn('No se pudo obtener la direcci√≥n:', geoError);
                }
                
                currentLocation = {
                    latitude,
                    longitude,
                    address,
                    accuracy: position.coords.accuracy,
                    timestamp: new Date().toISOString(),
                    method: 'gps'
                };
                
                status.innerHTML = `
                    <div class="location-icon">‚úÖ</div>
                    <div class="location-text">
                        <div class="location-title">Ubicaci√≥n obtenida</div>
                        <div class="location-subtitle">${address}</div>
                        <div class="location-coords">Precisi√≥n: ¬±${Math.round(position.coords.accuracy)}m</div>
                    </div>
                `;
                
                btn.textContent = '‚úÖ Ubicaci√≥n Obtenida';
                btn.style.backgroundColor = '#059669';
                
                if (window.showNotification) {
                    window.showNotification('Ubicaci√≥n obtenida exitosamente', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Error obteniendo ubicaci√≥n:', error);
                
                status.innerHTML = `
                    <div class="location-icon">‚ùå</div>
                    <div class="location-text">
                        <div class="location-title">Error en ubicaci√≥n</div>
                        <div class="location-subtitle">${error.message}</div>
                    </div>
                `;
                
                btn.textContent = 'üìç Reintentar Ubicaci√≥n';
                btn.style.backgroundColor = '#dc2626';
                
                if (window.showNotification) {
                    window.showNotification('Error al obtener ubicaci√≥n: ' + error.message, 'error');
                }
                
            } finally {
                btn.disabled = false;
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('La geolocalizaci√≥n no est√° soportada en este navegador'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    resolve,
                    (error) => {
                        let message = 'Error desconocido';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message = 'Permiso de ubicaci√≥n denegado';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = 'Ubicaci√≥n no disponible';
                                break;
                            case error.TIMEOUT:
                                message = 'Tiempo de espera agotado';
                                break;
                        }
                        reject(new Error(message));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            });
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
                
                if (!response.ok) throw new Error('Error en geocoding');
                
                const data = await response.json();
                
                if (data && data.display_name) {
                    return data.display_name;
                }
                
                throw new Error('No se encontr√≥ direcci√≥n');
                
            } catch (error) {
                console.warn('Reverse geocoding fall√≥:', error);
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        function toggleManualLocation() {
            const manualInput = document.getElementById('manual-location-input');
            const btn = document.getElementById('manual-location-btn');
            
            if (manualInput.style.display === 'none') {
                manualInput.style.display = 'block';
                btn.textContent = '‚ùå Cancelar Manual';
                btn.style.backgroundColor = '#dc2626';
            } else {
                manualInput.style.display = 'none';
                btn.textContent = '‚úèÔ∏è Ubicaci√≥n Manual';
                btn.style.backgroundColor = '';
            }
        }

        function saveManualLocation() {
            const address = document.getElementById('manual-address').value.trim();
            const lat = parseFloat(document.getElementById('manual-lat').value);
            const lng = parseFloat(document.getElementById('manual-lng').value);
            
            if (!address) {
                if (window.showNotification) {
                    window.showNotification('Ingresa una direcci√≥n', 'warning');
                }
                return;
            }
            
            currentLocation = {
                latitude: lat || null,
                longitude: lng || null,
                address,
                accuracy: null,
                timestamp: new Date().toISOString(),
                method: 'manual'
            };
            
            const status = document.getElementById('location-status');
            status.innerHTML = `
                <div class="location-icon">‚úèÔ∏è</div>
                <div class="location-text">
                    <div class="location-title">Ubicaci√≥n manual</div>
                    <div class="location-subtitle">${address}</div>
                    ${(lat && lng) ? `<div class="location-coords">${lat.toFixed(6)}, ${lng.toFixed(6)}</div>` : ''}
                </div>
            `;
            
            toggleManualLocation();
            
            if (window.showNotification) {
                window.showNotification('Ubicaci√≥n manual guardada', 'success');
            }
        }

        // Resto de funciones existentes
        async function loadSubstoreStatus() {
            console.log('üîç Cargando estado del subalmac√©n...');
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/employee/substore-status`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Estado del subalmac√©n:', data);
                
                displaySubstoreStatus(data);
                
                if (data.has_active_trip) {
                    substoreInfo = data.trip_info;
                    await loadSubstoreProducts();
                    showOrderForm();
                } else {
                    hideOrderForm();
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando estado del subalmac√©n:', error);
                displaySubstoreError(error.message);
            }
        }

        function displaySubstoreStatus(data) {
            const container = document.getElementById('substore-status-container');
            
            if (data.has_active_trip) {
                container.innerHTML = `
                    <div class="substore-status">
                        <div class="substore-header">
                            <h3 class="substore-title">üöõ Subalmac√©n Activo</h3>
                            <div class="trip-number">${data.trip_info.trip_number}</div>
                        </div>
                        <p>Tienes productos disponibles para venta desde tu subalmac√©n m√≥vil.</p>
                        
                        <div class="substore-stats">
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.available_products}</span>
                                <span class="stat-label">Productos Disponibles</span>
                            </div>
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.total_products}</span>
                                <span class="stat-label">Total Productos</span>
                            </div>
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.out_of_stock}</span>
                                <span class="stat-label">Sin Stock</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="substore-status no-trip">
                        <div class="substore-header">
                            <h3 class="substore-title">‚ö†Ô∏è Sin Subalmac√©n Activo</h3>
                        </div>
                        <p>No tienes un subalmac√©n activo asignado. Contacta al administrador para que te asigne productos.</p>
                    </div>
                `;
            }
        }

        async function loadSubstoreProducts() {
            console.log('üì¶ Cargando productos del subalmac√©n...');
            
            const container = document.getElementById('products-list');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Cargando productos del subalmac√©n...</div>';
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/substore/products`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || !data.products) {
                    substoreProducts = [];
                } else {
                    substoreProducts = data.products;
                }
                
                displaySubstoreProducts(substoreProducts);
                
            } catch (error) {
                console.error('‚ùå Error cargando productos del subalmac√©n:', error);
                
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc2626;">
                            <p>‚ùå Error: ${error.message}</p>
                            <button onclick="loadSubstoreProducts()" class="btn btn-primary" style="margin-top: 1rem;">
                                üîÑ Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        function displaySubstoreProducts(productsToShow) {
            const container = document.getElementById('products-list');
            if (!container) return;
            
            if (productsToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        <p>üì¶ No hay productos disponibles en tu subalmac√©n</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = productsToShow.map(product => {
                const stockClass = product.stock > 10 ? 'stock-high' : product.stock > 3 ? 'stock-medium' : 'stock-low';
                const stockText = `${product.stock} disponibles`;
                const isOutOfStock = product.stock === 0;
                
                const prices = getProductPrices(product, currentPaymentMethod);
                
                const paymentBadge = currentPaymentMethod === 'credit' 
                    ? '<span style="background: #fbbf24; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üìã CR√âDITO</span>'
                    : '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üíµ CONTADO</span>';
                
                return `
                    <div class="product-card substore-product-card">
                        <div class="substore-badge">SUBALMAC√âN</div>
                        ${paymentBadge}
                        
                        <div class="product-header">
                            <div class="product-code">${product.code || 'N/A'}</div>
                            <div class="product-price">${formatCurrency(prices.box)}</div>
                        </div>
                        <div class="product-name">${product.name || 'Producto sin nombre'}</div>
                        <div class="product-details">${product.brand || 'N/A'} ‚Ä¢ ${product.viscosity || 'N/A'} ‚Ä¢ ${product.capacity || 'N/A'}</div>
                        <div class="stock-info ${stockClass}">üì¶ ${stockText}</div>
                        
                        <div class="product-actions">
                            <input type="number" class="quantity-input" data-product-id="${product.id}" 
                                   min="1" max="${product.stock || 1}" value="1" ${isOutOfStock ? 'disabled' : ''}>
                            <button class="btn btn-primary" onclick="addToOrder(${product.id})" 
                                    ${isOutOfStock ? 'disabled' : ''}>
                                ${isOutOfStock ? 'Sin Stock' : 'Agregar'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getProductPrices(product, paymentMethod) {
            if (!product) return { unit: 0, box: 0 };
            
            const basePrice = product.substore_info?.substore_price || product.price || 0;
            
            if (product.prices && typeof product.prices === 'object') {
                const priceKey = paymentMethod === 'cash' ? 'cash' : 'credit';
                return {
                    unit: product.prices[`${priceKey}_unit`] || 0,
                    box: product.prices[`${priceKey}_box`] || basePrice
                };
            } else {
                const unitPrice = basePrice / 24;
                
                if (paymentMethod === 'credit') {
                    return {
                        unit: unitPrice * 1.06,
                        box: basePrice * 1.06
                    };
                }
                
                return {
                    unit: unitPrice,
                    box: basePrice
                };
            }
        }

        function updateProductPrices() {
            if (substoreProducts && substoreProducts.length > 0) {
                displaySubstoreProducts(substoreProducts);
            }
            
            if (orderProducts && orderProducts.length > 0) {
                orderProducts.forEach(orderProduct => {
                    const product = substoreProducts.find(p => p.id === orderProduct.product_id);
                    if (product) {
                        const prices = getProductPrices(product, currentPaymentMethod);
                        orderProduct.unit_price = prices.box;
                        orderProduct.line_total = prices.box * orderProduct.quantity;
                        orderProduct.payment_method = currentPaymentMethod;
                    }
                });
                
                updateOrderTable();
            }
        }

        function addToOrder(productId) {
            const product = substoreProducts.find(p => p.id === productId);
            if (!product) return;
            
            const quantityInput = document.querySelector(`input[data-product-id="${productId}"]`);
            const quantity = parseInt(quantityInput?.value) || 1;
            
            if (quantity <= 0 || quantity > product.stock) {
                if (window.showNotification) {
                    window.showNotification(`Stock insuficiente. Disponible: ${product.stock}`, 'warning');
                }
                return;
            }
            
            // Usar precio personalizado si existe, sino usar precio normal
            let unitPrice;
            if (customPrices[productId]) {
                unitPrice = customPrices[productId].price;
            } else {
                const prices = getProductPrices(product, currentPaymentMethod);
                unitPrice = prices.box;
            }
            
            const existingIndex = orderProducts.findIndex(p => 
                p.product_id === productId && p.payment_method === currentPaymentMethod
            );
            
            if (existingIndex >= 0) {
                const newQuantity = orderProducts[existingIndex].quantity + quantity;
                if (newQuantity > product.stock) {
                    if (window.showNotification) {
                        window.showNotification(`Cantidad m√°xima: ${product.stock}`, 'warning');
                    }
                    return;
                }
                orderProducts[existingIndex].quantity = newQuantity;
                orderProducts[existingIndex].line_total = unitPrice * newQuantity;
            } else {
                const orderProduct = {
                    product_id: productId,
                    name: product.name,
                    code: product.code,
                    unit_price: unitPrice,
                    quantity: quantity,
                    line_total: unitPrice * quantity,
                    payment_method: currentPaymentMethod,
                    unit_type: 'box',
                    substore_info: product.substore_info
                };
                
                // Agregar informaci√≥n de precio personalizado si existe
                if (customPrices[productId]) {
                    orderProduct.custom_price_info = {
                        original_price: customPrices[productId].originalPrice,
                        custom_price: customPrices[productId].price,
                        reason: customPrices[productId].reason,
                        discount_amount: customPrices[productId].originalPrice - customPrices[productId].price,
                        discount_percentage: ((customPrices[productId].originalPrice - customPrices[productId].price) / customPrices[productId].originalPrice * 100).toFixed(2)
                    };
                }
                
                orderProducts.push(orderProduct);
            }
            
            updateOrderTable();
            
            if (quantityInput) quantityInput.value = 1;
            
            const productName = customPrices[productId] ? 
                `${product.name} (precio especial)` : product.name;
            
            if (window.showNotification) {
                window.showNotification(`${productName} agregado`, 'success');
            }
        }

        function updateOrderTable() {
            const tbody = document.querySelector('#order-products-table tbody');
            const productsCount = document.getElementById('products-count');
            
            if (!tbody) return;
            
            if (orderProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #64748b;">
                            üìù No hay productos en el pedido
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = orderProducts.map((product, index) => {
                    const methodBadge = product.payment_method === 'credit' 
                        ? '<small style="background: #fbbf24; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">CR√âDITO</small>'
                        : '<small style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">CONTADO</small>';
                    
                    const customPriceBadge = product.custom_price_info ? 
                        `<small style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;" title="${product.custom_price_info.reason}">
                            ${product.custom_price_info.discount_amount > 0 ? 'DESCUENTO' : '‚≠ê ESPECIAL'}
                        </small>` : '';
                    
                    const priceInfo = product.custom_price_info ? 
                        `<small style="color: #059669; display: block; margin-top: 0.25rem;">
                            Precio original: ${formatCurrency(product.custom_price_info.original_price)} 
                            ${product.custom_price_info.discount_amount > 0 ? `(Ahorro: ${formatCurrency(product.custom_price_info.discount_amount)})` : ''}
                        </small>` : '';
                    
                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${product.code} - ${product.name}</div>
                                <small style="color: #059669;">üöõ Desde subalmac√©n</small>
                                ${methodBadge}
                                ${customPriceBadge}
                                ${priceInfo}
                            </td>
                            <td>${formatCurrency(product.unit_price)}</td>
                            <td>${product.quantity}</td>
                            <td>${formatCurrency(product.line_total)}</td>
                            <td>
                                <button class="remove-product" onclick="removeFromOrder(${index})" title="Remover producto">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            if (productsCount) {
                productsCount.textContent = orderProducts.length;
            }
            
            updateSummary();
            updatePaymentSummary();
        }

        function updateSummary() {
            const total = orderProducts.reduce((sum, p) => sum + p.line_total, 0);
            const totalItems = orderProducts.reduce((sum, p) => sum + p.quantity, 0);
            
            const totalElement = document.getElementById('order-total');
            const countElement = document.getElementById('cart-items-count');
            
            if (totalElement) {
                totalElement.textContent = formatCurrency(total);
            }
            
            if (countElement) {
                const methodText = currentPaymentMethod === 'cash' ? 'contado' : 'cr√©dito';
                countElement.textContent = `${totalItems} productos (${methodText})`;
            }
        }

        function handleClearOrder() {
            if (orderProducts.length === 0) {
                if (window.showNotification) {
                    window.showNotification('No hay productos en el pedido', 'info');
                }
                return;
            }
            
            if (confirm('¬øLimpiar todo el pedido?')) {
                clearOrderForm();
                if (window.showNotification) {
                    window.showNotification('Pedido limpiado', 'success');
                }
            }
        }

        function removeFromOrder(index) {
            const product = orderProducts[index];
            if (!product) return;
            
            if (confirm(`¬øRemover ${product.name}?`)) {
                orderProducts.splice(index, 1);
                updateOrderTable();
                if (window.showNotification) {
                    window.showNotification('Producto removido', 'info');
                }
            }
        }

        function displaySubstoreError(errorMessage) {
            const container = document.getElementById('substore-status-container');
            container.innerHTML = `
                <div class="substore-status no-trip">
                    <div class="substore-header">
                        <h3 class="substore-title">‚ùå Error de Conexi√≥n</h3>
                    </div>
                    <p>No se pudo verificar el estado de tu subalmac√©n: ${errorMessage}</p>
                    <button onclick="loadSubstoreStatus()" class="btn btn-primary" style="margin-top: 1rem;">
                        üîÑ Reintentar
                    </button>
                </div>
            `;
        }

        function showOrderForm() {
            document.getElementById('order-form-container').style.display = 'block';
        }

        function hideOrderForm() {
            document.getElementById('order-form-container').style.display = 'none';
        }

        function refreshSubstoreStatus() {
            loadSubstoreStatus();
        }

        let searchTimeout;
        function handleSearch(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const term = e.target.value.toLowerCase().trim();
                let filtered = substoreProducts;
                
                if (term) {
                    filtered = substoreProducts.filter(p => 
                        p.name.toLowerCase().includes(term) ||
                        p.code.toLowerCase().includes(term) ||
                        p.brand.toLowerCase().includes(term) ||
                        p.viscosity.toLowerCase().includes(term)
                    );
                }
                
                displaySubstoreProducts(filtered);
            }, 300);
        }

        function handlePhotoChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                if (window.showNotification) {
                    window.showNotification('Archivo muy grande (m√°x 5MB)', 'warning');
                }
                e.target.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                if (window.showNotification) {
                    window.showNotification('Solo im√°genes permitidas', 'warning');
                }
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-preview').innerHTML = `
                    <div style="position: relative; display: inline-block; margin-top: 1rem;">
                        <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                        <button onclick="removePhoto()" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">√ó</button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            const photoInput = document.getElementById('order-photo');
            const photoPreview = document.getElementById('photo-preview');
            if (photoInput) photoInput.value = '';
            if (photoPreview) photoPreview.innerHTML = '';
        }

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function setupMobile() {
            if (!document.querySelector('.mobile-menu-btn')) {
                const mobileBtn = document.createElement('button');
                mobileBtn.className = 'mobile-menu-btn';
                mobileBtn.innerHTML = '‚ò∞';
                mobileBtn.onclick = toggleMobileMenu;
                document.body.appendChild(mobileBtn);
            }
            
            adjustForMobile();
            window.addEventListener('resize', adjustForMobile);
            document.addEventListener('click', handleOutsideClick);
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth <= 768) {
                sidebar.classList.toggle('active');
            }
        }

        function adjustForMobile() {
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            if (mobileBtn) {
                mobileBtn.style.display = window.innerWidth <= 768 ? 'block' : 'none';
            }
        }

        function handleOutsideClick(e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const menuBtn = document.querySelector('.mobile-menu-btn');
                
                if (sidebar && menuBtn && !sidebar.contains(e.target) && !menuBtn.contains(e.target) && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            }
        }

        function formatCurrency(amount) {
            if (typeof window.formatCurrency === 'function' && window.formatCurrency !== formatCurrency) {
                return window.formatCurrency(amount);
            }
            
            if (typeof amount !== 'number') {
                amount = parseFloat(amount) || 0;
            }
            
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.clear();
                window.location.href = '/';
            }
        }

        function setupQuickClientFormValidation() {
            const form = document.getElementById('client-form-quick');
            if (!form) return;
            
            // Validaci√≥n en tiempo real
            const nameInput = document.getElementById('quick-client-name');
            const phoneInput = document.getElementById('quick-client-phone');
            
            if (nameInput) {
                nameInput.addEventListener('input', function() {
                    this.style.borderColor = this.value.trim() ? '#10b981' : '#f59e0b';
                });
            }
            
            if (phoneInput) {
                phoneInput.addEventListener('input', function() {
                    const phoneRegex = /^[\d\-\s\+\(\)]{10,}$/;
                    const isValid = phoneRegex.test(this.value.trim());
                    this.style.borderColor = isValid ? '#10b981' : '#f59e0b';
                });
                
                // Formatear tel√©fono autom√°ticamente
                phoneInput.addEventListener('input', function() {
                    let value = this.value.replace(/\D/g, ''); // Solo n√∫meros
                    if (value.length >= 3) {
                        value = value.replace(/^(\d{3})(\d{3})(\d{4}).*/, '$1-$2-$3');
                    }
                    this.value = value;
                });
            }
        }
        
        function handleClientApiError(error, operation = 'operaci√≥n') {
            console.error(`‚ùå Error en ${operation}:`, error);
            
            let userMessage = `Error en ${operation}`;
            
            if (error.message.includes('Network') || error.message.includes('fetch')) {
                userMessage = 'Error de conexi√≥n. Verifica tu internet.';
            } else if (error.message.includes('401') || error.message.includes('token')) {
                userMessage = 'Sesi√≥n expirada. Por favor inicia sesi√≥n nuevamente.';
                setTimeout(() => {
                    localStorage.clear();
                    window.location.href = '/';
                }, 2000);
            } else if (error.message.includes('403')) {
                userMessage = 'No tienes permisos para esta acci√≥n.';
            } else {
                userMessage = error.message || userMessage;
            }
            
            if (window.showNotification) {
                window.showNotification(userMessage, 'error');
            } else {
                alert(userMessage);
            }
        }
        
        // Funciones globales
        window.addToOrder = addToOrder;
        window.removeFromOrder = removeFromOrder;
        window.removePhoto = removePhoto;
        window.logout = logout;
        window.refreshSubstoreStatus = refreshSubstoreStatus;
        window.selectPaymentMethod = selectPaymentMethod;
        window.selectPaymentType = selectPaymentType;
        window.updatePaymentSummary = updatePaymentSummary;
        window.getDetailedLocation = getDetailedLocation;
        window.toggleManualLocation = toggleManualLocation;
        window.saveManualLocation = saveManualLocation;
        window.clearSelectedClient = clearSelectedClient;
        window.cancelNewClient = cancelNewClient;
        window.saveQuickClient = saveQuickClient;


    </script>

</body>
</html>