<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Pedido - Sistema de Aceites</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/employee.css">
    <style>
        /* Estilos específicos para esta página */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: #1d4ed8;
            transform: scale(1.05);
        }

        .mobile-close-btn {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .mobile-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Cards de productos para móvil */
        .product-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .product-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .product-code {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .product-name {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            line-height: 1.3;
        }

        .product-details {
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .product-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stock-info {
            font-size: 0.875rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .stock-high { color: var(--success-color); }
        .stock-medium { color: var(--warning-color); }
        .stock-low { 
            color: var(--danger-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .product-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .quantity-input {
            width: 70px;
            padding: 0.75rem 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
        }

        .quantity-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .add-product-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .add-product-btn:hover:not(:disabled) {
            background: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .add-product-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Búsqueda de productos */
        .product-search {
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: #f8fafc;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Resumen del carrito */
        .cart-summary {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 3px solid var(--primary-color);
            padding: 1rem;
            margin: 1rem -1rem -1rem -1rem;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .cart-items-count {
            font-size: 0.875rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .cart-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive específico */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block !important;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                position: fixed;
                z-index: 1000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
                padding-top: 4rem;
            }

            .content-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
                background: white;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .header-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .form-section {
                background: white;
                margin-bottom: 1rem;
                border-radius: 8px;
                padding: 1rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .section-title {
                background: var(--primary-color);
                color: white;
                padding: 0.75rem 1rem;
                margin: -1rem -1rem 1rem -1rem;
                font-weight: 600;
                border-radius: 8px 8px 0 0;
                font-size: 0.9rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .product-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .quantity-input {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 0.75rem;
                padding-top: 3.5rem;
            }

            .product-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="employee-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Panel Empleado</h2>
                <span id="user-name"></span>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Inicio</a></li>
                <li><a href="orders.html" class="active">Crear Pedido</a></li>
                <li><a href="sales.html">Mis Ventas</a></li>
                <li><a href="#" onclick="logout()">Cerrar Sesión</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header class="content-header">
                <h1>Nuevo Pedido</h1>
                <div class="header-actions">
                    <button id="location-btn" class="btn-location" onclick="getCurrentLocationForOrder()">
                        📍 Obtener Ubicación
                    </button>
                    <span id="location-status"></span>
                </div>
            </header>

            <div class="order-form-container">
                <form id="order-form">
                    <!-- Información del Cliente -->
                    <div class="form-section">
                        <h3 class="section-title">Información del Cliente</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="client-name">Nombre del Cliente: *</label>
                                <input type="text" id="client-name" required placeholder="Nombre completo del cliente">
                            </div>
                            <div class="form-group">
                                <label for="client-phone">Teléfono:</label>
                                <input type="tel" id="client-phone" placeholder="Número de teléfono">
                            </div>
                            <div class="form-group">
                                <label for="client-address">Dirección:</label>
                                <input type="text" id="client-address" placeholder="Dirección de entrega">
                            </div>
                            <div class="form-group">
                                <label for="client-email">Email:</label>
                                <input type="email" id="client-email" placeholder="correo@ejemplo.com">
                            </div>
                        </div>
                    </div>

                    <!-- Productos -->
                    <div class="form-section">
                        <h3 class="section-title">Seleccionar Productos</h3>
                        
                        <!-- Buscador de productos -->
                        <div class="product-search">
                            <input type="text" 
                                   id="product-search" 
                                   class="search-input" 
                                   placeholder="🔍 Buscar productos por nombre, código o marca...">
                        </div>
                        
                        <!-- Lista de productos -->
                        <div id="products-list" class="loading">
                            Cargando productos...
                        </div>
                        
                        <!-- Productos seleccionados -->
                        <div class="selected-products" style="margin-top: 2rem;">
                            <h4>Productos en el Pedido</h4>
                            <div style="overflow-x: auto;">
                                <table id="order-products-table">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Precio</th>
                                            <th>Cantidad</th>
                                            <th>Subtotal</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" style="text-align: center; padding: 2rem; color: var(--secondary-color);">
                                                📝 No hay productos en el pedido
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="cart-summary">
                                <div class="cart-items-count" id="cart-items-count">0 productos seleccionados</div>
                                <div class="cart-total">Total: <span id="order-total">$0.00</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Foto del Pedido -->
                    <div class="form-section">
                        <h3 class="section-title">Foto del Pedido (Opcional)</h3>
                        <div class="photo-upload">
                            <input type="file" id="order-photo" accept="image/*" capture="camera">
                            <p style="margin: 0.5rem 0; font-size: 0.875rem; color: var(--secondary-color);">
                                📷 Toca para agregar una foto del pedido (máximo 5MB)
                            </p>
                            <div id="photo-preview"></div>
                        </div>
                    </div>

                    <!-- Notas -->
                    <div class="form-section">
                        <h3 class="section-title">Notas Adicionales</h3>
                        <div class="form-group">
                            <label for="order-notes">Observaciones:</label>
                            <textarea id="order-notes" 
                                      rows="4" 
                                      placeholder="Instrucciones especiales, observaciones, etc."></textarea>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="clearEmployeeOrder()">
                            🧹 Limpiar Pedido
                        </button>
                        <button type="submit" class="btn btn-primary">
                            ✅ Crear Pedido
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Scripts en orden correcto: config PRIMERO -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/employee.js"></script>
    
    <!-- Script de integración específico para esta página -->
    <script>
        // Script de integración inline para garantizar que funcione
        (function() {
            'use strict';
            
            console.log('🔄 Inicializando página de pedidos integrada...');
            
            // Variables globales para esta página
            window.employeeOrderProducts = [];
            window.employeeCurrentLocation = null;
            window.employeeProducts = [];
            
            let isLoading = false;
            let retryCount = 0;
            const maxRetries = 5;
            
            // Función principal de inicialización
            function initPage() {
                console.log('🚀 Iniciando página de pedidos...');
                
                // Verificar autenticación
                const user = checkAuth();
                if (!user) return;
                
                // Mostrar nombre del usuario
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = user.name;
                }
                
                // Configurar interfaz móvil
                setupMobileInterface();
                
                // Configurar eventos
                setupEvents();
                
                // Cargar productos
                setTimeout(loadProducts, 500);
            }
            
            // Configurar interfaz móvil
            function setupMobileInterface() {
                // Crear botón de menú móvil
                if (!document.querySelector('.mobile-menu-btn')) {
                    const mobileBtn = document.createElement('button');
                    mobileBtn.className = 'mobile-menu-btn';
                    mobileBtn.innerHTML = '☰';
                    mobileBtn.onclick = toggleMobileMenu;
                    document.body.appendChild(mobileBtn);
                }
                
                // Agregar botón de cierre al sidebar
                const sidebar = document.getElementById('sidebar');
                if (sidebar && !sidebar.querySelector('.mobile-close-btn')) {
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'mobile-close-btn';
                    closeBtn.innerHTML = '×';
                    closeBtn.onclick = toggleMobileMenu;
                    closeBtn.style.display = 'none';
                    sidebar.querySelector('.sidebar-header').appendChild(closeBtn);
                }
                
                adjustForMobile();
                window.addEventListener('resize', adjustForMobile);
                document.addEventListener('click', handleOutsideClick);
            }
            
            // Configurar eventos
            function setupEvents() {
                // Formulario
                const form = document.getElementById('order-form');
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }
                
                // Búsqueda
                const searchInput = document.getElementById('product-search');
                if (searchInput) {
                    searchInput.addEventListener('input', debounce(handleSearch, 300));
                }
                
                // Preview de foto
                const photoInput = document.getElementById('order-photo');
                if (photoInput) {
                    photoInput.addEventListener('change', handlePhotoChange);
                }
            }
            
            // Cargar productos
            async function loadProducts() {
                if (isLoading) return;
                
                const container = document.getElementById('products-list');
                if (!container) return;
                
                try {
                    isLoading = true;
                    container.innerHTML = '<div class="loading">🔄 Cargando productos...</div>';
                    
                    if (typeof window.getProducts !== 'function') {
                        throw new Error('Función getProducts no disponible');
                    }
                    
                    const products = await window.getProducts();
                    if (!products || products.length === 0) {
                        throw new Error('No se encontraron productos');
                    }
                    
                    window.employeeProducts = products;
                    displayProducts(products);
                    
                    if (window.showNotification) {
                        window.showNotification('Productos cargados correctamente', 'success');
                    }
                    
                    console.log('✅ Productos cargados:', products.length);
                    
                } catch (error) {
                    console.error('❌ Error cargando productos:', error);
                    
                    retryCount++;
                    if (retryCount < maxRetries) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--warning-color);">
                                <p>⏳ Reintentando... (${retryCount}/${maxRetries})</p>
                            </div>
                        `;
                        setTimeout(loadProducts, 2000);
                    } else {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--danger-color);">
                                <p>❌ Error al cargar productos</p>
                                <p style="font-size: 0.875rem;">${error.message}</p>
                                <button onclick="window.location.reload()" class="btn btn-primary" style="margin-top: 1rem;">
                                    🔄 Recargar página
                                </button>
                            </div>
                        `;
                    }
                } finally {
                    isLoading = false;
                }
            }
            
            // Mostrar productos
            function displayProducts(products) {
                const container = document.getElementById('products-list');
                if (!container) return;
                
                if (products.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--secondary-color);">
                            <p>📦 No hay productos disponibles</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = products.map(product => {
                    const stockClass = product.stock > 20 ? 'stock-high' : 
                                     product.stock > 5 ? 'stock-medium' : 'stock-low';
                    const stockText = product.stock > 0 ? `${product.stock} disponibles` : 'Sin stock';
                    const isOutOfStock = product.stock === 0;
                    
                    return `
                        <div class="product-card">
                            <div class="product-header">
                                <div>
                                    <div class="product-code">${product.code}</div>
                                </div>
                                <div class="product-price">${product.price.toFixed(2)}</div>
                            </div>
                            
                            <div class="product-name">${product.name}</div>
                            <div class="product-details">
                                ${product.brand} • ${product.viscosity} • ${product.capacity}
                            </div>
                            
                            <div class="stock-info ${stockClass}">
                                📦 ${stockText}
                            </div>
                            
                            <div class="product-actions">
                                <input type="number" 
                                       id="qty-${product.id}" 
                                       class="quantity-input" 
                                       min="1" 
                                       max="${product.stock || 1}" 
                                       value="1"
                                       ${isOutOfStock ? 'disabled' : ''}>
                                <button class="add-product-btn" 
                                        onclick="addToCart(${product.id})"
                                        ${isOutOfStock ? 'disabled' : ''}>
                                    ${isOutOfStock ? '❌ Sin Stock' : '➕ Agregar'}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Agregar al carrito
            window.addToCart = function(productId) {
                const product = window.employeeProducts.find(p => p.id === productId);
                if (!product) return;
                
                const quantityInput = document.getElementById(`qty-${productId}`);
                const quantity = parseInt(quantityInput?.value) || 1;
                
                if (quantity <= 0 || quantity > product.stock) {
                    if (window.showNotification) {
                        window.showNotification(`Stock insuficiente. Disponible: ${product.stock}`, 'warning');
                    }
                    return;
                }
                
                const existingIndex = window.employeeOrderProducts.findIndex(p => p.product_id === productId);
                
                if (existingIndex >= 0) {
                    const newQuantity = window.employeeOrderProducts[existingIndex].quantity + quantity;
                    if (newQuantity > product.stock) {
                        if (window.showNotification) {
                            window.showNotification(`No puedes agregar más. Stock disponible: ${product.stock}`, 'warning');
                        }
                        return;
                    }
                    window.employeeOrderProducts[existingIndex].quantity = newQuantity;
                } else {
                    window.employeeOrderProducts.push({
                        product_id: productId,
                        name: product.name,
                        code: product.code,
                        price: product.price,
                        quantity: quantity
                    });
                }
                
                updateOrderTable();
                if (quantityInput) quantityInput.value = 1;
                
                if (window.showNotification) {
                    window.showNotification(`${product.name} agregado al pedido`, 'success');
                }
            };
            
            // Actualizar tabla
            function updateOrderTable() {
                const tbody = document.querySelector('#order-products-table tbody');
                if (!tbody) return;
                
                if (window.employeeOrderProducts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: var(--secondary-color);">
                                📝 No hay productos en el pedido
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = window.employeeOrderProducts.map((product, index) => `
                        <tr>
                            <td>${product.code} - ${product.name}</td>
                            <td>${product.price.toFixed(2)}</td>
                            <td>${product.quantity}</td>
                            <td>${(product.price * product.quantity).toFixed(2)}</td>
                            <td>
                                <button class="remove-product" onclick="removeFromCart(${index})">🗑️</button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                updateSummary();
            }
            
            // Actualizar resumen
            function updateSummary() {
                const total = window.employeeOrderProducts.reduce((sum, p) => sum + (p.price * p.quantity), 0);
                const totalItems = window.employeeOrderProducts.reduce((sum, p) => sum + p.quantity, 0);
                
                const totalElement = document.getElementById('order-total');
                const countElement = document.getElementById('cart-items-count');
                
                if (totalElement) {
                    totalElement.textContent = window.formatCurrency ? window.formatCurrency(total) : `${total.toFixed(2)}`;
                }
                
                if (countElement) {
                    countElement.textContent = `${totalItems} productos seleccionados`;
                }
            }
            
            // Remover del carrito
            window.removeFromCart = function(index) {
                const product = window.employeeOrderProducts[index];
                if (confirm(`¿Remover ${product.name} del pedido?`)) {
                    window.employeeOrderProducts.splice(index, 1);
                    updateOrderTable();
                    if (window.showNotification) {
                        window.showNotification('Producto removido', 'info');
                    }
                }
            };
            
            // Limpiar pedido
            window.clearEmployeeOrder = function() {
                if (window.employeeOrderProducts.length === 0) return;
                
                if (confirm('¿Limpiar el pedido completo?')) {
                    window.employeeOrderProducts = [];
                    updateOrderTable();
                    
                    // Limpiar formulario
                    const form = document.getElementById('order-form');
                    if (form) {
                        ['client-name', 'client-phone', 'client-address', 'client-email', 'order-notes'].forEach(id => {
                            const field = document.getElementById(id);
                            if (field) field.value = '';
                        });
                    }
                    
                    // Limpiar foto
                    const photoInput = document.getElementById('order-photo');
                    const photoPreview = document.getElementById('photo-preview');
                    if (photoInput) photoInput.value = '';
                    if (photoPreview) photoPreview.innerHTML = '';
                    
                    if (window.showNotification) {
                        window.showNotification('Pedido limpiado', 'success');
                    }
                }
            };
            
            // Otras funciones auxiliares
            function handleFormSubmit(e) {
                e.preventDefault();
                
                if (window.employeeOrderProducts.length === 0) {
                    if (window.showNotification) {
                        window.showNotification('Agrega al menos un producto', 'warning');
                    }
                    return;
                }
                
                const clientName = document.getElementById('client-name')?.value?.trim();
                if (!clientName) {
                    if (window.showNotification) {
                        window.showNotification('Nombre del cliente requerido', 'warning');
                    }
                    return;
                }
                
                // Aquí iría la lógica de envío del pedido
                if (window.showNotification) {
                    window.showNotification('Funcionalidad de envío en desarrollo', 'info');
                }
            }
            
            function handleSearch(e) {
                const term = e.target.value.toLowerCase().trim();
                let filtered = window.employeeProducts;
                
                if (term) {
                    filtered = window.employeeProducts.filter(p => 
                        p.name.toLowerCase().includes(term) ||
                        p.code.toLowerCase().includes(term) ||
                        p.brand.toLowerCase().includes(term)
                    );
                }
                
                displayProducts(filtered);
            }
            
            function handlePhotoChange(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    if (window.showNotification) {
                        window.showNotification('Foto muy grande (máx 5MB)', 'warning');
                    }
                    e.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photo-preview').innerHTML = `
                        <img src="${e.target.result}" style="max-width: 200px; border-radius: 8px;">
                    `;
                };
                reader.readAsDataURL(file);
            }
            
            function toggleMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                if (sidebar && window.innerWidth <= 768) {
                    sidebar.classList.toggle('active');
                    const closeBtn = sidebar.querySelector('.mobile-close-btn');
                    if (closeBtn) {
                        closeBtn.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
                    }
                }
            }
            
            function adjustForMobile() {
                const mobileBtn = document.querySelector('.mobile-menu-btn');
                if (mobileBtn) {
                    mobileBtn.style.display = window.innerWidth <= 768 ? 'block' : 'none';
                }
            }
            
            function handleOutsideClick(e) {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const menuBtn = document.querySelector('.mobile-menu-btn');
                    
                    if (sidebar && menuBtn && !sidebar.contains(e.target) && !menuBtn.contains(e.target) && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                        const closeBtn = sidebar.querySelector('.mobile-close-btn');
                        if (closeBtn) closeBtn.style.display = 'none';
                    }
                }
            }
            
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }
            
            // Obtener ubicación
            window.getCurrentLocationForOrder = async function() {
                const btn = document.getElementById('location-btn');
                const status = document.getElementById('location-status');
                
                try {
                    if (btn) {
                        btn.disabled = true;
                        btn.textContent = '📍 Obteniendo...';
                    }
                    
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000
                        });
                    });
                    
                    window.employeeCurrentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    
                    if (btn) {
                        btn.textContent = '📍 Ubicación Obtenida';
                        btn.style.backgroundColor = '#059669';
                    }
                    
                    if (status) {
                        status.textContent = `📍 Lat: ${position.coords.latitude.toFixed(6)}`;
                        status.style.color = '#059669';
                    }
                    
                    if (window.showNotification) {
                        window.showNotification('Ubicación obtenida', 'success');
                    }
                    
                } catch (error) {
                    if (btn) {
                        btn.textContent = '📍 Error';
                        btn.style.backgroundColor = '#dc2626';
                    }
                    
                    if (window.showNotification) {
                        window.showNotification('Error obteniendo ubicación', 'error');
                    }
                } finally {
                    if (btn) btn.disabled = false;
                }
            };
            
            // Función logout
            window.logout = function() {
                if (confirm('¿Cerrar sesión?')) {
                    localStorage.clear();
                    window.location.href = '/';
                }
            };
            
            // Inicializar cuando esté listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPage);
            } else {
                initPage();
            }
            
            console.log('✅ Script de integración configurado');
        })();
    </script>
</body>
</html>