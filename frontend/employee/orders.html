<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Pedido - Sistema de Aceites</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/employee.css">
    <style>
        /* Estilos específicos para subalmacén */
        .substore-status {
            background: linear-gradient(135deg, #1e40af, #2563eb);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .substore-status.no-trip {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .substore-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .substore-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .trip-number {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .substore-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .substore-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .substore-product-card {
            border-left: 4px solid var(--primary-color);
            position: relative;
        }

        .substore-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--success-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .substore-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .substore-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .substore-info-row:last-child {
            margin-bottom: 0;
        }

        .no-trip-message {
            text-align: center;
            padding: 3rem 2rem;
            background: #fef2f2;
            border-radius: 8px;
            border: 1px solid #fecaca;
            margin: 2rem 0;
        }

        .no-trip-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .no-trip-title {
            color: #dc2626;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .no-trip-description {
            color: #7f1d1d;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .contact-admin {
            background: #dc2626;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .substore-header {
                flex-direction: column;
                gap: 1rem;
            }

            .substore-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="employee-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Panel Empleado</h2>
                <span id="user-name"></span>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">Inicio</a></li>
                <li><a href="orders.html" class="active">Crear Pedido</a></li>
                <li><a href="sales.html">Mis Ventas</a></li>
                <li><a href="#" onclick="logout()">Cerrar Sesión</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header class="content-header">
                <h1>Nuevo Pedido - Subalmacén</h1>
                <div class="header-actions">
                    <button id="refresh-substore-btn" class="btn btn-secondary" onclick="refreshSubstoreStatus()">
                        🔄 Actualizar Estado
                    </button>
                </div>
            </header>

            <!-- Estado del Subalmacén -->
            <div id="substore-status-container">
                <!-- Se llena dinámicamente -->
            </div>

            <!-- Contenido del formulario de pedido -->
            <div id="order-form-container" class="order-form-container" style="display: none;">
                <!-- Modalidad de Pago -->
                <div class="payment-method-section">
                    <h3 class="payment-method-header">💳 Modalidad de Pago</h3>
                    <div class="payment-method-content">
                        <div class="payment-options">
                            <!-- Contado -->
                            <div class="payment-option selected">
                                <input type="radio" name="payment_method" value="cash" id="payment-cash" checked>
                                <label for="payment-cash">
                                    <div class="payment-option-header">
                                        <span class="payment-icon">💵</span>
                                        <span class="payment-title">Contado</span>
                                        <span class="payment-badge">INMEDIATO</span>
                                    </div>
                                    <div class="payment-description">
                                        Pago inmediato en efectivo, tarjeta o transferencia al momento de la entrega.
                                        ⚡ Se procesa automáticamente como venta completada.
                                    </div>
                                    <div class="payment-benefits">
                                        ✅ Mejores precios disponibles
                                        ✅ Venta automática confirmada
                                    </div>
                                </label>
                            </div>

                            <!-- Crédito 21 días -->
                            <div class="payment-option">
                                <input type="radio" name="payment_method" value="credit" id="payment-credit">
                                <label for="payment-credit">
                                    <div class="payment-option-header">
                                        <span class="payment-icon">📅</span>
                                        <span class="payment-title">Crédito 21 días</span>
                                        <span class="payment-badge">DIFERIDO</span>
                                    </div>
                                    <div class="payment-description">
                                        Pago diferido a 21 días naturales. Ideal para clientes establecidos.
                                        ⚡ Se procesa automáticamente como venta completada.
                                    </div>
                                    <div class="payment-benefits">
                                        📋 Cliente de confianza
                                        ✅ Venta automática confirmada
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información del Cliente -->
                <div class="form-section">
                    <h3 class="section-title">Información del Cliente</h3>
                    <div style="padding: 1.5rem;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="client-name">Nombre del Cliente: *</label>
                                <input type="text" id="client-name" required placeholder="Nombre completo del cliente">
                            </div>
                            <div class="form-group">
                                <label for="client-phone">Teléfono:</label>
                                <input type="tel" id="client-phone" placeholder="Número de teléfono">
                            </div>
                            <div class="form-group">
                                <label for="client-address">Dirección:</label>
                                <input type="text" id="client-address" placeholder="Dirección de entrega">
                            </div>
                            <div class="form-group">
                                <label for="client-email">Email:</label>
                                <input type="email" id="client-email" placeholder="correo@ejemplo.com">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Productos del Subalmacén -->
                <div class="form-section">
                    <h3 class="section-title">📦 Productos Disponibles en mi Subalmacén</h3>
                    <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                        <input type="text" id="product-search" class="search-input" 
                               placeholder="🔍 Buscar productos en mi subalmacén...">
                    </div>
                    
                    <div style="padding: 1.5rem;">
                        <div id="products-list" class="loading">Cargando productos del subalmacén...</div>
                        
                        <div class="selected-products" style="margin-top: 2rem;">
                            <h4>Productos en el Pedido (<span id="products-count">0</span>)</h4>
                            <div style="overflow-x: auto;">
                                <table id="order-products-table">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Modalidad</th>
                                            <th>Precio Unit.</th>
                                            <th>Cantidad</th>
                                            <th>Subtotal</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 2rem; color: #64748b;">
                                                📝 No hay productos en el pedido
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="cart-summary">
                                <div class="cart-items-count" id="cart-items-count">0 productos seleccionados</div>
                                <div class="cart-total">Total: <span id="order-total">$0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Foto y Notas -->
                <div class="form-section">
                    <h3 class="section-title">Información Adicional</h3>
                    <div style="padding: 1.5rem;">
                        <div class="form-group">
                            <label for="order-photo">Foto del Pedido (Opcional):</label>
                            <input type="file" id="order-photo" accept="image/*" capture="camera">
                            <div id="photo-preview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="order-notes">Observaciones:</label>
                            <textarea id="order-notes" rows="4" 
                                      placeholder="Instrucciones especiales, observaciones, etc."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="clear-order-btn">🧹 Limpiar Pedido</button>
                    <button type="button" class="btn btn-primary" id="submit-order-btn">✅ Crear Pedido</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    
    <script>
        console.log('🚀 Iniciando página de pedidos con subalmacén');

        // Variables globales
        let substoreProducts = [];
        let orderProducts = [];
        let currentLocation = null;
        let isProcessing = false;
        let currentPaymentMethod = 'cash';
        let substoreInfo = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📋 Inicializando página de pedidos con subalmacén...');
            
            const user = checkAuth();
            if (!user) return;
            
            if (user.role !== 'employee') {
                alert('Esta página es solo para empleados.');
                window.location.href = '/';
                return;
            }
            
            const userNameElement = document.getElementById('user-name');
            if (userNameElement) userNameElement.textContent = user.name;
            
            setupEventListeners();
            setupMobile();
            loadSubstoreStatus();
        });

        // Configurar event listeners
        function setupEventListeners() {
            console.log('🎯 Configurando event listeners...');
            
            // Modalidad de pago
            document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
                radio.addEventListener('change', handlePaymentMethodChange);
            });
            
            // Botones principales
            const submitBtn = document.getElementById('submit-order-btn');
            if (submitBtn) submitBtn.addEventListener('click', handleCreateOrder);
            
            const clearBtn = document.getElementById('clear-order-btn');
            if (clearBtn) clearBtn.addEventListener('click', handleClearOrder);
            
            // Búsqueda
            const searchInput = document.getElementById('product-search');
            if (searchInput) searchInput.addEventListener('input', handleSearch);
            
            // Foto
            const photoInput = document.getElementById('order-photo');
            if (photoInput) photoInput.addEventListener('change', handlePhotoChange);
            
            console.log('✅ Event listeners configurados');
        }

        // Cargar estado del subalmacén
        async function loadSubstoreStatus() {
            console.log('🔍 Cargando estado del subalmacén...');
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/employee/substore-status`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('✅ Estado del subalmacén:', data);
                
                displaySubstoreStatus(data);
                
                if (data.has_active_trip) {
                    substoreInfo = data.trip_info;
                    await loadSubstoreProducts();
                    showOrderForm();
                } else {
                    hideOrderForm();
                }
                
            } catch (error) {
                console.error('❌ Error cargando estado del subalmacén:', error);
                displaySubstoreError(error.message);
            }
        }

        // Mostrar estado del subalmacén
        function displaySubstoreStatus(data) {
            const container = document.getElementById('substore-status-container');
            
            if (data.has_active_trip) {
                container.innerHTML = `
                    <div class="substore-status">
                        <div class="substore-header">
                            <h3 class="substore-title">🚛 Subalmacén Activo</h3>
                            <div class="trip-number">${data.trip_info.trip_number}</div>
                        </div>
                        <p>Tienes productos disponibles para venta desde tu subalmacén móvil.</p>
                        
                        <div class="substore-stats">
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.available_products}</span>
                                <span class="stat-label">Productos Disponibles</span>
                            </div>
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.total_products}</span>
                                <span class="stat-label">Total Productos</span>
                            </div>
                            <div class="substore-stat">
                                <span class="stat-value">${data.inventory_summary.out_of_stock}</span>
                                <span class="stat-label">Sin Stock</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="substore-status no-trip">
                        <div class="substore-header">
                            <h3 class="substore-title">⚠️ Sin Subalmacén Activo</h3>
                        </div>
                        <p>No tienes un viaje activo asignado. Contacta al administrador para que te asigne productos.</p>
                    </div>
                    
                    <div class="no-trip-message">
                        <div class="no-trip-icon">📦</div>
                        <h3 class="no-trip-title">No hay productos asignados</h3>
                        <p class="no-trip-description">
                            Para crear pedidos necesitas tener un viaje activo con productos asignados a tu subalmacén.
                            El administrador debe crear un viaje y cargar productos para ti.
                        </p>
                        <button class="contact-admin" onclick="contactAdmin()">
                            📞 Contactar Administrador
                        </button>
                    </div>
                `;
            }
        }

        // Mostrar error del subalmacén
        function displaySubstoreError(errorMessage) {
            const container = document.getElementById('substore-status-container');
            container.innerHTML = `
                <div class="substore-status no-trip">
                    <div class="substore-header">
                        <h3 class="substore-title">❌ Error de Conexión</h3>
                    </div>
                    <p>No se pudo verificar el estado de tu subalmacén: ${errorMessage}</p>
                    <button onclick="loadSubstoreStatus()" class="btn btn-primary" style="margin-top: 1rem;">
                        🔄 Reintentar
                    </button>
                </div>
            `;
        }

        // Cargar productos del subalmacén
        async function loadSubstoreProducts() {
            console.log('📦 Cargando productos del subalmacén...');
            
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/substore/products`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('✅ Productos del subalmacén:', data);
                
                substoreProducts = data.products || [];
                displaySubstoreProducts(substoreProducts);
                
            } catch (error) {
                console.error('❌ Error cargando productos del subalmacén:', error);
                
                const container = document.getElementById('products-list');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc2626;">
                            <p>❌ Error: ${error.message}</p>
                            <button onclick="loadSubstoreProducts()" class="btn btn-primary" style="margin-top: 1rem;">
                                🔄 Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Mostrar productos del subalmacén
        function displaySubstoreProducts(productsToShow) {
            const container = document.getElementById('products-list');
            if (!container) return;
            
            if (productsToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        <p>📦 No hay productos disponibles en tu subalmacén</p>
                        <p>Contacta al administrador para solicitar productos.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = productsToShow.map(product => {
                const stockClass = product.stock > 10 ? 'stock-high' : product.stock > 3 ? 'stock-medium' : 'stock-low';
                const stockText = `${product.stock} disponibles en subalmacén`;
                const isOutOfStock = product.stock === 0;
                
                // Obtener precios según modalidad actual
                const prices = getProductPrices(product, currentPaymentMethod);
                
                return `
                    <div class="product-card substore-product-card">
                        <div class="substore-badge">SUBALMACÉN</div>
                        
                        <div class="product-header">
                            <div><div class="product-code">${product.code}</div></div>
                            <div class="product-price">${formatCurrency(prices.box)}</div>
                        </div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-details">${product.brand} • ${product.viscosity} • ${product.capacity}</div>
                        <div class="stock-info ${stockClass}">📦 ${stockText}</div>
                        
                        <div class="substore-info">
                            <div class="substore-info-row">
                                <span>📦 Stock inicial:</span>
                                <span><strong>${product.substore_info.initial_quantity}</strong></span>
                            </div>
                            <div class="substore-info-row">
                                <span>💰 Vendidos:</span>
                                <span><strong>${product.substore_info.sold_quantity}</strong></span>
                            </div>
                            <div class="substore-info-row">
                                <span>🚛 Viaje:</span>
                                <span><strong>${substoreInfo?.trip_number || 'N/A'}</strong></span>
                            </div>
                        </div>
                        
                        <div class="product-actions">
                            <input type="number" class="quantity-input" data-product-id="${product.id}" 
                                   min="1" max="${product.stock || 1}" value="1" ${isOutOfStock ? 'disabled' : ''}>
                            <button class="add-product-btn" onclick="addToOrder(${product.id})" 
                                    ${isOutOfStock ? 'disabled' : ''}>
                                ${isOutOfStock ? '❌ Sin Stock' : '➕ Agregar'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Obtener precios del producto según modalidad (del subalmacén)
        function getProductPrices(product, paymentMethod) {
            // En el subalmacén, usar el precio asignado al producto
            const basePrice = product.substore_info?.substore_price || product.price || 0;
            
            if (product.prices) {
                // Sistema multi-precios
                const priceKey = paymentMethod === 'cash' ? 'cash' : 'credit';
                return {
                    unit: product.prices[`${priceKey}_unit`] || 0,
                    box: product.prices[`${priceKey}_box`] || basePrice
                };
            } else {
                // Sistema anterior - usar precio base del subalmacén
                const unitPrice = basePrice / 24; // Estimación
                
                if (paymentMethod === 'credit') {
                    return {
                        unit: unitPrice * 1.06, // 6% más para crédito
                        box: basePrice * 1.06
                    };
                }
                
                return {
                    unit: unitPrice,
                    box: basePrice
                };
            }
        }

        // Agregar producto al pedido
        function addToOrder(productId) {
            console.log('➕ Agregando producto del subalmacén al pedido:', productId);
            
            const product = substoreProducts.find(p => p.id === productId);
            if (!product) {
                console.error('Producto no encontrado en subalmacén');
                return;
            }
            
            const quantityInput = document.querySelector(`input[data-product-id="${productId}"]`);
            const quantity = parseInt(quantityInput?.value) || 1;
            
            if (quantity <= 0 || quantity > product.stock) {
                if (window.showNotification) {
                    window.showNotification(`Stock insuficiente en subalmacén. Disponible: ${product.stock}`, 'warning');
                }
                return;
            }
            
            // Obtener precios según modalidad actual
            const prices = getProductPrices(product, currentPaymentMethod);
            
            // Buscar si ya existe en el pedido
            const existingIndex = orderProducts.findIndex(p => 
                p.product_id === productId && p.payment_method === currentPaymentMethod
            );
            
            if (existingIndex >= 0) {
                const newQuantity = orderProducts[existingIndex].quantity + quantity;
                if (newQuantity > product.stock) {
                    if (window.showNotification) {
                        window.showNotification(`Cantidad máxima en subalmacén: ${product.stock}`, 'warning');
                    }
                    return;
                }
                orderProducts[existingIndex].quantity = newQuantity;
                orderProducts[existingIndex].line_total = prices.box * newQuantity;
            } else {
                orderProducts.push({
                    product_id: productId,
                    name: product.name,
                    code: product.code,
                    unit_price: prices.box,
                    quantity: quantity,
                    line_total: prices.box * quantity,
                    payment_method: currentPaymentMethod,
                    unit_type: 'box',
                    substore_info: product.substore_info
                });
            }
            
            updateOrderTable();
            
            // Reset cantidad
            if (quantityInput) quantityInput.value = 1;
            
            if (window.showNotification) {
                window.showNotification(`${product.name} agregado desde subalmacén`, 'success');
            }
            
            console.log('✅ Producto agregado desde subalmacén. Total en pedido:', orderProducts.length);
        }

        // Actualizar tabla de pedido
        function updateOrderTable() {
            const tbody = document.querySelector('#order-products-table tbody');
            const productsCount = document.getElementById('products-count');
            
            if (!tbody) return;
            
            if (orderProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #64748b;">
                            📝 No hay productos en el pedido
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = orderProducts.map((product, index) => `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${product.code} - ${product.name}</div>
                            <small style="color: #059669;">🚛 Desde subalmacén</small>
                        </td>
                        <td>
                            <span style="padding: 0.25rem 0.5rem; background: ${product.payment_method === 'cash' ? '#dcfce7' : '#fef3c7'}; 
                                  color: ${product.payment_method === 'cash' ? '#166534' : '#92400e'}; border-radius: 4px; font-size: 0.75rem;">
                                ${product.payment_method === 'cash' ? '💵 Contado' : '📅 Crédito'}
                            </span>
                        </td>
                        <td>${formatCurrency(product.unit_price)}</td>
                        <td>${product.quantity}</td>
                        <td>${formatCurrency(product.line_total)}</td>
                        <td>
                            <button class="remove-product" onclick="removeFromOrder(${index})">🗑️</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            if (productsCount) {
                productsCount.textContent = orderProducts.length;
            }
            
            updateSummary();
        }

        // Actualizar resumen
        function updateSummary() {
            const total = orderProducts.reduce((sum, p) => sum + p.line_total, 0);
            const totalItems = orderProducts.reduce((sum, p) => sum + p.quantity, 0);
            
            const totalElement = document.getElementById('order-total');
            const countElement = document.getElementById('cart-items-count');
            
            if (totalElement) {
                totalElement.textContent = formatCurrency(total);
            }
            
            if (countElement) {
                countElement.textContent = `${totalItems} productos seleccionados del subalmacén`;
            }
        }

        // Manejar cambio de modalidad de pago
        function handlePaymentMethodChange(e) {
            currentPaymentMethod = e.target.value;
            console.log('💳 Modalidad de pago cambiada:', currentPaymentMethod);
            
            // Actualizar estilos visuales
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            e.target.closest('.payment-option').classList.add('selected');
            
            // Recalcular precios de productos en el carrito
            updateProductPricing();
            
            // Mostrar notificación
            if (window.showNotification) {
                const methodText = currentPaymentMethod === 'cash' ? 'Contado' : 'Crédito 21 días';
                window.showNotification(`Modalidad cambiada a: ${methodText}`, 'success');
            }
        }

        // Actualizar precios de productos existentes en el carrito
        function updateProductPricing() {
            orderProducts.forEach(orderProduct => {
                const product = substoreProducts.find(p => p.id === orderProduct.product_id);
                if (product && orderProduct.payment_method !== currentPaymentMethod) {
                    // Actualizar modalidad y precio
                    const prices = getProductPrices(product, currentPaymentMethod);
                    orderProduct.payment_method = currentPaymentMethod;
                    orderProduct.unit_price = prices.box;
                    orderProduct.line_total = prices.box * orderProduct.quantity;
                }
            });
            
            updateOrderTable();
        }

function clearOrderForm() {
    console.log('🧹 Limpiando formulario de pedido...');
    
    try {
        // Clear order products array
        orderProducts = [];
        updateOrderTable();
        
        // Clear client information fields
        const clientFields = [
            'client-name', 
            'client-phone', 
            'client-address', 
            'client-email', 
            'order-notes'
        ];
        
        clientFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = '';
            }
        });
        
        // Clear photo
        const photoInput = document.getElementById('order-photo');
        const photoPreview = document.getElementById('photo-preview');
        if (photoInput) photoInput.value = '';
        if (photoPreview) photoPreview.innerHTML = '';
        
        // Reset payment method to default
        const cashRadio = document.getElementById('payment-cash');
        if (cashRadio) {
            cashRadio.checked = true;
            currentPaymentMethod = 'cash';
            
            // Update visual selection
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            cashRadio.closest('.payment-option')?.classList.add('selected');
        }
        
        // Reset quantity inputs on product cards
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.value = 1;
        });
        
        console.log('✅ Formulario limpiado exitosamente');
        
    } catch (error) {
        console.error('❌ Error limpiando formulario:', error);
    }
}

// Improved handleClearOrder function that uses clearOrderForm
function handleClearOrder() {
    if (orderProducts.length === 0) {
        if (window.showNotification) {
            window.showNotification('No hay productos en el pedido para limpiar', 'info');
        }
        return;
    }
    
    if (confirm('¿Limpiar todo el pedido del subalmacén?')) {
        clearOrderForm();
        
        if (window.showNotification) {
            window.showNotification('Pedido del subalmacén limpiado', 'success');
        }
    }
}

// Helper function to format currency (if not already defined)
function formatCurrency(amount) {
    if (typeof window.formatCurrency === 'function') {
        return window.formatCurrency(amount);
    }
    
    if (typeof amount !== 'number') {
        amount = parseFloat(amount) || 0;
    }
    
    return new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN'
    }).format(amount);
}

// Updated handleCreateOrder with proper error handling
async function handleCreateOrder() {
    if (isProcessing) return;
    
    console.log('📤 Iniciando creación de pedido con AUTO-CONFIRMACIÓN...');
    
    // Validaciones
    if (!orderProducts || orderProducts.length === 0) {
        if (window.showNotification) {
            window.showNotification('Agrega al menos un producto del subalmacén', 'warning');
        }
        return;
    }
    
    const clientName = document.getElementById('client-name')?.value?.trim();
    if (!clientName) {
        if (window.showNotification) {
            window.showNotification('El nombre del cliente es requerido', 'warning');
        }
        document.getElementById('client-name')?.focus();
        return;
    }
    
    if (!substoreInfo) {
        if (window.showNotification) {
            window.showNotification('Error: No hay información del subalmacén', 'error');
        }
        return;
    }
    
    isProcessing = true;
    const submitBtn = document.getElementById('submit-order-btn');
    
    try {
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = '⚡ Procesando Venta...'; // ✅ CAMBIO: Nuevo texto
        }
        
        // Preparar datos del pedido
        const formData = {
            client_info: {
                name: clientName,
                phone: document.getElementById('client-phone')?.value?.trim() || '',
                address: document.getElementById('client-address')?.value?.trim() || '',
                email: document.getElementById('client-email')?.value?.trim() || ''
            },
            products: orderProducts,
            payment_method: currentPaymentMethod,
            inventory_source: 'substore',
            trip_id: substoreInfo.id,
            location: currentLocation,
            notes: document.getElementById('order-notes')?.value?.trim() || '',
            total: orderProducts.reduce((sum, p) => sum + p.line_total, 0)
        };
        
        // Manejar foto
        const photoFile = document.getElementById('order-photo')?.files[0];
        if (photoFile) {
            try {
                const photoBase64 = await convertToBase64(photoFile);
                formData.photo_url = photoBase64;
            } catch (error) {
                console.error('Error con la foto:', error);
            }
        }
        
        console.log('📤 Enviando pedido con auto-confirmación:', formData);
        
        // Enviar pedido - Este ahora se auto-confirma en el backend
        const response = await window.createOrder(formData);
        
        console.log('✅ Respuesta del servidor recibida:', response);
        
        // ✅ NUEVA LÓGICA: Manejar respuesta de auto-confirmación
        if (response.auto_confirmed) {
            console.log('🎉 Pedido auto-confirmado exitosamente');
            
            const methodText = currentPaymentMethod === 'cash' ? 'Contado' : 'Crédito 21 días';
            const orderNumber = response.order?.order_number || response.order?.id || 'Generándose...';
            const saleNumber = response.sale?.sale_number || 'Generándose...';
            const tripNumber = substoreInfo.trip_number;
            
            // ✅ NUEVO: Mensaje de confirmación para venta completada
            const confirmationMessage = `🎉 ¡VENTA COMPLETADA EXITOSAMENTE!

📋 Pedido: ${orderNumber}
💰 Venta: ${saleNumber}
👤 Cliente: ${formData.client_info.name}
💳 Modalidad: ${methodText}
📦 Productos: ${orderProducts.length}
💵 Total: ${formatCurrency(formData.total)}
🚛 Viaje: ${tripNumber}

✅ La venta ha sido procesada automáticamente
✅ El inventario de tu subalmacén ha sido actualizado
✅ El registro de venta ha sido creado

¡Felicidades por tu venta! 🎊`;
            
            console.log('🎉 Mostrando confirmación de venta:', confirmationMessage);
            alert(confirmationMessage);
            
            if (window.showNotification) {
                window.showNotification('¡Venta completada automáticamente! 🎉', 'success');
            }
            
        } else {
            // Fallback para pedidos no auto-confirmados (admin)
            console.log('📋 Pedido creado, requiere confirmación manual');
            
            const methodText = currentPaymentMethod === 'cash' ? 'Contado' : 'Crédito 21 días';
            const orderNumber = response.order?.order_number || response.order?.id || 'Generándose...';
            
            const confirmationMessage = `✅ PEDIDO CREADO EXITOSAMENTE

📋 Número: ${orderNumber}
👤 Cliente: ${formData.client_info.name}
💳 Modalidad: ${methodText}
📦 Productos: ${orderProducts.length}
💰 Total: ${formatCurrency(formData.total)}

⏳ El pedido requiere confirmación del administrador.`;
            
            alert(confirmationMessage);
            
            if (window.showNotification) {
                window.showNotification('Pedido creado exitosamente', 'success');
            }
        }
        
        // Limpiar formulario
        clearOrderForm();
        
        // Recargar productos del subalmacén para mostrar nuevos stocks
        console.log('🔄 Recargando productos del subalmacén...');
        try {
            await loadSubstoreProducts();
            if (window.showNotification && response.auto_confirmed) {
                window.showNotification('Inventario actualizado - nuevos stocks disponibles', 'info');
            }
        } catch (reloadError) {
            console.warn('⚠️ Error recargando productos, pero la venta se completó:', reloadError);
        }
        
    } catch (error) {
        // Manejo de errores mejorado
        console.error('❌ Error procesando pedido:', error);
        
        // Verificar si es un error real o falso positivo
        const isRealError = (
            error.message.includes('Failed to fetch') ||
            error.message.includes('NetworkError') ||
            error.message.includes('Stock insuficiente') ||
            error.message.includes('401') ||
            error.message.includes('403') ||
            error.message.includes('404') ||
            error.message.includes('500')
        );
        
        if (isRealError) {
            if (window.showNotification) {
                window.showNotification('Error: ' + error.message, 'error');
            }
            
            let errorMessage;
            if (error.message.includes('Stock insuficiente')) {
                errorMessage = `❌ Stock insuficiente en tu subalmacén:

${error.message}

Los productos pueden haber sido vendidos mientras preparabas el pedido.
Actualiza la página para ver el stock actual.`;
            } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                errorMessage = `❌ Error de conexión:

No se pudo conectar con el servidor.
Verifica tu conexión a internet e intenta nuevamente.`;
            } else if (error.message.includes('401') || error.message.includes('403')) {
                errorMessage = `❌ Error de autenticación:

Tu sesión puede haber expirado.
Intenta cerrar sesión y volver a iniciar.`;
            } else {
                errorMessage = `❌ Error procesando la venta:

${error.message}

Intenta nuevamente en unos momentos.`;
            }
            
            alert(errorMessage);
        } else {
            // Posible falso positivo - tratar como éxito parcial
            console.log('🤔 Posible falso positivo - verificando estado...');
            
            if (window.showNotification) {
                window.showNotification('Venta enviada al servidor. Verificando estado...', 'info');
            }
            
            setTimeout(async () => {
                try {
                    // Limpiar formulario como si hubiera sido exitoso
                    clearOrderForm();
                    
                    // Recargar productos para verificar si se actualizó el stock
                    await loadSubstoreProducts();
                    
                    if (window.showNotification) {
                        window.showNotification('Venta procesada exitosamente', 'success');
                    }
                    
                    alert(`✅ VENTA PROCESADA

La venta ha sido enviada al servidor exitosamente.

📋 Cliente: ${formData.client_info.name}
💳 Modalidad: ${currentPaymentMethod === 'cash' ? 'Contado' : 'Crédito 21 días'}
📦 Productos: ${orderProducts.length}
💰 Total: ${formatCurrency(formData.total)}

Verifica en la sección de ventas que se haya registrado correctamente.`);
                    
                } catch (verifyError) {
                    console.error('Error verificando estado:', verifyError);
                    
                    if (window.showNotification) {
                        window.showNotification('Recargando página para actualizar datos...', 'info');
                    }
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }, 1000);
        }
        
    } finally {
        isProcessing = false;
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = '⚡ Procesar Venta'; // ✅ CAMBIO: Nuevo texto del botón
        }
    }
}

        // Funciones auxiliares
        function showOrderForm() {
            document.getElementById('order-form-container').style.display = 'block';
        }

        function hideOrderForm() {
            document.getElementById('order-form-container').style.display = 'none';
        }

        function refreshSubstoreStatus() {
            console.log('🔄 Refrescando estado del subalmacén...');
            loadSubstoreStatus();
        }

        function contactAdmin() {
            alert(`📞 Contacta al Administrador

Para obtener productos en tu subalmacén:

1. Solicita al administrador que cree un nuevo viaje
2. El administrador debe asignarte productos específicos
3. Una vez asignados, podrás crear pedidos desde tu subalmacén

Mientras tanto, el administrador puede crear pedidos directamente desde el almacén principal.`);
        }

        function removeFromOrder(index) {
            const product = orderProducts[index];
            if (!product) return;
            
            if (confirm(`¿Remover ${product.name} del subalmacén?`)) {
                orderProducts.splice(index, 1);
                updateOrderTable();
                if (window.showNotification) {
                    window.showNotification('Producto removido', 'info');
                }
            }
        }

        function handleClearOrder() {
            if (orderProducts.length === 0) return;
            
            if (confirm('¿Limpiar todo el pedido del subalmacén?')) {
                orderProducts = [];
                updateOrderTable();
                
                ['client-name', 'client-phone', 'client-address', 'client-email', 'order-notes'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) field.value = '';
                });
                
                const photoInput = document.getElementById('order-photo');
                const photoPreview = document.getElementById('photo-preview');
                if (photoInput) photoInput.value = '';
                if (photoPreview) photoPreview.innerHTML = '';
                
                if (window.showNotification) {
                    window.showNotification('Pedido del subalmacén limpiado', 'success');
                }
            }
        }

        let searchTimeout;
        function handleSearch(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const term = e.target.value.toLowerCase().trim();
                let filtered = substoreProducts;
                
                if (term) {
                    filtered = substoreProducts.filter(p => 
                        p.name.toLowerCase().includes(term) ||
                        p.code.toLowerCase().includes(term) ||
                        p.brand.toLowerCase().includes(term) ||
                        p.viscosity.toLowerCase().includes(term)
                    );
                }
                
                displaySubstoreProducts(filtered);
            }, 300);
        }

        function handlePhotoChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                if (window.showNotification) {
                    window.showNotification('Archivo muy grande (máx 5MB)', 'warning');
                }
                e.target.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                if (window.showNotification) {
                    window.showNotification('Solo imágenes permitidas', 'warning');
                }
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-preview').innerHTML = `
                    <div style="position: relative; display: inline-block; margin-top: 1rem;">
                        <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                        <button onclick="removePhoto()" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">×</button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            const photoInput = document.getElementById('order-photo');
            const photoPreview = document.getElementById('photo-preview');
            if (photoInput) photoInput.value = '';
            if (photoPreview) photoPreview.innerHTML = '';
        }

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function setupMobile() {
            if (!document.querySelector('.mobile-menu-btn')) {
                const mobileBtn = document.createElement('button');
                mobileBtn.className = 'mobile-menu-btn';
                mobileBtn.innerHTML = '☰';
                mobileBtn.onclick = toggleMobileMenu;
                document.body.appendChild(mobileBtn);
            }
            
            adjustForMobile();
            window.addEventListener('resize', adjustForMobile);
            document.addEventListener('click', handleOutsideClick);
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth <= 768) {
                sidebar.classList.toggle('active');
            }
        }

        function adjustForMobile() {
            const mobileBtn = document.querySelector('.mobile-menu-btn');
            if (mobileBtn) {
                mobileBtn.style.display = window.innerWidth <= 768 ? 'block' : 'none';
            }
        }

        function handleOutsideClick(e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const menuBtn = document.querySelector('.mobile-menu-btn');
                
                if (sidebar && menuBtn && !sidebar.contains(e.target) && !menuBtn.contains(e.target) && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function logout() {
            if (confirm('¿Cerrar sesión?')) {
                localStorage.clear();
                window.location.href = '/';
            }
        }
        function showAutoConfirmSuccess(orderData, saleData) {
            const message = `🎉 ¡VENTA COMPLETADA! 
            
        Pedido: ${orderData.order_number}
        Cliente: ${orderData.client_info.name}
        Total: ${formatCurrency(orderData.total)}
            
        La venta ha sido procesada automáticamente.`;
            
            if (window.showNotification) {
                window.showNotification(message, 'success');
            }
        }

        function showOrderPendingMessage(orderData) {
            const message = `📋 Pedido creado: ${orderData.order_number}
            
        ⏳ Requiere confirmación manual del administrador.`;
            
            if (window.showNotification) {
                window.showNotification(message, 'info');
            }
        }

        // Hacer funciones globales
        window.addToOrder = addToOrder;
        window.removeFromOrder = removeFromOrder;
        window.removePhoto = removePhoto;
        window.logout = logout;
        window.refreshSubstoreStatus = refreshSubstoreStatus;
        window.contactAdmin = contactAdmin;
        window.showAutoConfirmSuccess = showAutoConfirmSuccess;
        window.showOrderPendingMessage = showOrderPendingMessage;

        console.log('✅ Página de pedidos con subalmacén inicializada correctamente');
    </script>
</body>
</html>